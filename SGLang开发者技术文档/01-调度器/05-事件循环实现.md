# äº‹ä»¶å¾ªç¯å®ç°

---

SGLangè°ƒåº¦å™¨æ”¯æŒä¸‰ç§ä¸»è¦çš„äº‹ä»¶å¾ªç¯æ¨¡å¼ï¼Œæ¯ç§éƒ½é’ˆå¯¹ç‰¹å®šçš„ä½¿ç”¨åœºæ™¯å’Œæ€§èƒ½éœ€æ±‚è¿›è¡Œäº†ä¼˜åŒ–ã€‚è¿™äº›äº‹ä»¶å¾ªç¯æ˜¯è°ƒåº¦å™¨çš„æ‰§è¡Œå¼•æ“ï¼Œå†³å®šäº†æ•´ä¸ªç³»ç»Ÿçš„å·¥ä½œæµç¨‹å’Œæ€§èƒ½ç‰¹æ€§ã€‚

---

## ğŸ›ï¸ äº‹ä»¶å¾ªç¯é€‰æ‹©æœºåˆ¶

### ğŸ¯ æ ¸å¿ƒè®¾è®¡æ¦‚å¿µ

```python
# äº‹ä»¶å¾ªç¯è‡ªåŠ¨é€‰æ‹©çš„æ ¸å¿ƒæ¦‚å¿µ
if server_args.pp_size > 1:
    scheduler.event_loop_pp()          # æµæ°´çº¿å¹¶è¡Œ
elif scheduler.enable_overlap:
    scheduler.event_loop_overlap()     # CPU-GPUé‡å 
else:
    scheduler.event_loop_normal()      # æ ‡å‡†åŒæ­¥å¾ªç¯
```

### ğŸ” æºç å®ç°ç»†èŠ‚

```python
def run_scheduler_process(server_args, port_args, gpu_id, tp_rank, 
                         moe_ep_rank, pp_rank, dp_rank, pipe_writer, balance_meta):
    """çœŸå®çš„è°ƒåº¦å™¨è¿›ç¨‹å¯åŠ¨å’Œäº‹ä»¶å¾ªç¯é€‰æ‹©"""
    # åˆ›å»ºè°ƒåº¦å™¨å®ä¾‹
    scheduler = Scheduler(server_args, port_args, gpu_id, tp_rank, 
                         moe_ep_rank, pp_rank, dp_rank, dp_balance_meta=balance_meta)
    
    # å‘é€å°±ç»ªçŠ¶æ€
    pipe_writer.send({
        "status": "ready",
        "max_total_num_tokens": scheduler.max_total_num_tokens,
        "max_req_input_len": scheduler.max_req_input_len,
    })

    # å¤æ‚çš„äº‹ä»¶å¾ªç¯é€‰æ‹©é€»è¾‘
    disaggregation_mode = scheduler.disaggregation_mode
    if disaggregation_mode == DisaggregationMode.NULL:
        if server_args.pp_size > 1:
            scheduler.event_loop_pp()
        elif scheduler.enable_overlap:
            scheduler.event_loop_overlap()
        else:
            scheduler.event_loop_normal()
    elif disaggregation_mode == DisaggregationMode.PREFILL:
        if scheduler.enable_overlap:
            scheduler.event_loop_overlap_disagg_prefill()
        else:
            if server_args.pp_size > 1:
                scheduler.event_loop_pp_disagg_prefill()  # æµæ°´çº¿+åˆ†ç¦»å¼é¢„å¡«å……
            else:
                scheduler.event_loop_normal_disagg_prefill()
    elif disaggregation_mode == DisaggregationMode.DECODE:
        if scheduler.enable_overlap:
            scheduler.event_loop_overlap_disagg_decode()
        else:
            scheduler.event_loop_normal_disagg_decode()

ğŸ’¡ **å®ç°è¯´æ˜**: çœŸå®é€‰æ‹©é€»è¾‘æ”¯æŒ7ç§ä¸åŒçš„äº‹ä»¶å¾ªç¯ç»„åˆï¼ŒåŒ…æ‹¬æ ‡å‡†ã€é‡å ã€æµæ°´çº¿å¹¶è¡Œä¸åˆ†ç¦»å¼æ¶æ„çš„æ‰€æœ‰ç»„åˆã€‚æ•™å­¦ç‰ˆæœ¬çªå‡ºæ ¸å¿ƒçš„"æµæ°´çº¿â†’é‡å â†’æ ‡å‡†"é€‰æ‹©é€»è¾‘ã€‚
```

è¿™ç§è‡ªåŠ¨é€‰æ‹©æœºåˆ¶ç¡®ä¿äº†è°ƒåº¦å™¨èƒ½å¤Ÿæ ¹æ®éƒ¨ç½²é…ç½®é€‰æ‹©æœ€ä¼˜çš„æ‰§è¡Œæ¨¡å¼ã€‚

---

## ğŸ”„ æ ‡å‡†äº‹ä»¶å¾ªç¯

### ğŸ¯ æ ¸å¿ƒè®¾è®¡æ¦‚å¿µ

```python
@DynamicGradMode()
def event_loop_normal(self):
    """æ ‡å‡†äº‹ä»¶å¾ªç¯çš„æ ¸å¿ƒæ¦‚å¿µ"""
    while True:
        # 1. æ¥æ”¶å’Œå¤„ç†è¯·æ±‚
        recv_reqs = self.recv_requests()
        self.process_input_requests(recv_reqs)

        # 2. è·å–ä¸‹ä¸€ä¸ªæ‰¹æ¬¡
        batch = self.get_next_batch_to_run()

        # 3. æ‰§è¡Œæ¨ç†æˆ–ç©ºé—²æ£€æŸ¥
        if batch:
            result = self.run_batch(batch)
            self.process_batch_result(batch, result)
        else:
            self.self_check_during_idle()
        
        # 4. æ›´æ–°çŠ¶æ€
        self.last_batch = batch
```

### ğŸ” æºç å®ç°ç»†èŠ‚

```python
@DynamicGradMode()
def event_loop_normal(self):
    """çœŸå®çš„SGLangæ ‡å‡†äº‹ä»¶å¾ªç¯å®ç°"""
    while True:
        recv_reqs = self.recv_requests()
        self.process_input_requests(recv_reqs)

        batch = self.get_next_batch_to_run()
        self.cur_batch = batch

        if batch:
            result = self.run_batch(batch)
            self.process_batch_result(batch, result)
        else:
            # When the server is idle, do self-check and re-init some states
            self.self_check_during_idle()

        self.last_batch = batch

ğŸ’¡ **å®ç°è¯´æ˜**: æ ‡å‡†å¾ªç¯é‡‡ç”¨æœ€ç®€å•çš„ä¸²è¡Œå¤„ç†æ¨¡å¼ï¼Œæ¯ä¸ªæ­¥éª¤éƒ½å®Œå…¨åŒæ­¥æ‰§è¡Œã€‚è™½ç„¶ååé‡ä¸å¦‚é‡å å¾ªç¯ï¼Œä½†é€»è¾‘æœ€æ¸…æ™°ï¼Œå»¶è¿Ÿæœ€ä½ï¼Œæ˜¯å¼€å‘è°ƒè¯•çš„é¦–é€‰ã€‚
```

è¿™ä¸ªå®ç°æ¸…æ™°åœ°å±•ç¤ºäº†è°ƒåº¦å™¨çš„æ ¸å¿ƒå·¥ä½œæµç¨‹ï¼šè¯·æ±‚æ¥æ”¶ â†’ è¯·æ±‚å¤„ç† â†’ æ‰¹æ¬¡è°ƒåº¦ â†’ æ¨¡å‹æ¨ç† â†’ ç»“æœå¤„ç† â†’ çŠ¶æ€æ›´æ–°ã€‚æ¯ä¸ªæ­¥éª¤éƒ½æ˜¯åŒæ­¥æ‰§è¡Œï¼Œé€»è¾‘æ¸…æ™°æ˜“äºè°ƒè¯•ã€‚

### ğŸ·ï¸ ç‰¹ç‚¹

**é€»è¾‘æ¸…æ™°**: ä¸²è¡Œæ‰§è¡Œï¼Œæ¯ä¸ªæ­¥éª¤éƒ½ç­‰å¾…å‰ä¸€æ­¥å®Œæˆ
**å»¶è¿Ÿæœ€ä½**: æ²¡æœ‰é¢å¤–çš„åŒæ­¥å¼€é”€
**ç¨³å®šå¯é **: é€‚åˆå¼€å‘è°ƒè¯•å’Œå»¶è¿Ÿæ•æ„Ÿåœºæ™¯

---

## âš¡ é‡å äº‹ä»¶å¾ªç¯

### ğŸ¯ æ ¸å¿ƒè®¾è®¡æ¦‚å¿µ

```python
@DynamicGradMode()
def event_loop_overlap(self):
    """é‡å äº‹ä»¶å¾ªç¯çš„æ ¸å¿ƒæ¦‚å¿µ"""
    self.result_queue = deque()  # ç»“æœé˜Ÿåˆ—ç®¡ç†å¼‚æ­¥ç»“æœ

    while True:
        # 1. å¤„ç†è¯·æ±‚ï¼ˆCPUå·¥ä½œï¼‰
        recv_reqs = self.recv_requests()
        self.process_input_requests(recv_reqs)

        # 2. å¯åŠ¨æ–°æ‰¹æ¬¡ï¼ˆGPUå·¥ä½œï¼‰
        batch = self.get_next_batch_to_run()
        if batch:
            batch.launch_done = threading.Event()  # åŒæ­¥äº‹ä»¶
            result = self.run_batch(batch)
            self.result_queue.append((batch.copy(), result))

        # 3. å¤„ç†ä¸Šä¸€æ‰¹æ¬¡ç»“æœï¼ˆCPUå·¥ä½œä¸GPUå¹¶è¡Œï¼‰
        if self.last_batch:
            tmp_batch, tmp_result = self.result_queue.popleft()
            self.process_batch_result(tmp_batch, tmp_result, 
                                    batch.launch_done if batch else None)
        
        self.last_batch = batch
```

### ğŸ” æºç å®ç°ç»†èŠ‚

```python
@DynamicGradMode()
def event_loop_overlap(self):
    """çœŸå®çš„SGLangé‡å äº‹ä»¶å¾ªç¯å®ç°"""
    self.result_queue = deque()

    while True:
        recv_reqs = self.recv_requests()
        self.process_input_requests(recv_reqs)

        batch = self.get_next_batch_to_run()
        self.cur_batch = batch

        if batch:
            batch.launch_done = threading.Event()
            result = self.run_batch(batch)
            self.result_queue.append((batch.copy(), result))

            if self.last_batch is None:
                # åˆ›å»ºè™šæ‹Ÿé¦–æ‰¹æ¬¡æ¥å¯åŠ¨é‡å è°ƒåº¦çš„æµæ°´çº¿
                tmp_batch = ScheduleBatch(
                    reqs=None,
                    forward_mode=ForwardMode.DUMMY_FIRST,
                    next_batch_sampling_info=self.tp_worker.cur_sampling_info,
                )
                self.process_batch_result(tmp_batch, None, batch.launch_done)

        if self.last_batch:
            # å¤„ç†ä¸Šä¸€æ‰¹æ¬¡çš„ç»“æœï¼ˆå®ç°CPU-GPUé‡å ï¼‰
            tmp_batch, tmp_result = self.result_queue.popleft()
            tmp_batch.next_batch_sampling_info = (
                self.tp_worker.cur_sampling_info if batch else None
            )
            self.process_batch_result(
                tmp_batch, tmp_result, batch.launch_done if batch else None
            )
        elif batch is None:
            self.self_check_during_idle()

        self.last_batch = batch

ğŸ’¡ **å®ç°è¯´æ˜**: é‡å å¾ªç¯é€šè¿‡dequeå’Œthreading.Eventå®ç°CPU-GPUçœŸæ­£å¹¶è¡Œã€‚å½“GPUæ‰§è¡Œå½“å‰æ‰¹æ¬¡æ—¶ï¼ŒCPUåŒæ—¶å¤„ç†ä¸Šä¸€æ‰¹æ¬¡ç»“æœå’Œå‡†å¤‡ä¸‹ä¸€æ‰¹æ¬¡ï¼Œå¯æå‡20-40%ååé‡ã€‚
```

### ğŸ”„ CPU-GPUé‡å ä¼˜åŒ–

### é‡å æœºåˆ¶åŸç†

é‡å äº‹ä»¶å¾ªç¯çš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†CPUå¯†é›†çš„è°ƒåº¦å·¥ä½œä¸GPUå¯†é›†çš„æ¨ç†è®¡ç®—å¹¶è¡Œè¿›è¡Œï¼š

**ç»“æœé˜Ÿåˆ—ç®¡ç†**: ä½¿ç”¨dequeæ¥ç®¡ç†æ‰¹æ¬¡ç»“æœï¼Œæ”¯æŒå¼‚æ­¥çš„ç»“æœå¤„ç†ã€‚

**äº‹ä»¶åŒæ­¥**: é€šè¿‡threading.Eventæ¥åè°ƒCPUå’ŒGPUä¹‹é—´çš„åŒæ­¥ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚

**æµæ°´çº¿å¯åŠ¨**: åˆ›å»ºè™šæ‹Ÿçš„é¦–æ‰¹æ¬¡æ¥å¯åŠ¨æµæ°´çº¿ï¼Œé¿å…å†·å¯åŠ¨å»¶è¿Ÿã€‚

**å¹¶è¡Œå¤„ç†**: å½“GPUæ‰§è¡Œå½“å‰æ‰¹æ¬¡æ—¶ï¼ŒCPUåŒæ—¶å¤„ç†ä¸Šä¸€æ‰¹æ¬¡çš„ç»“æœå’Œå‡†å¤‡ä¸‹ä¸€æ‰¹æ¬¡ã€‚

### ç‰¹ç‚¹

**é«˜ååé‡**: å¯æå‡20-40%çš„ååé‡
**èµ„æºå¹¶è¡Œ**: CPUå’ŒGPUåŒæ—¶å·¥ä½œï¼Œæé«˜èµ„æºåˆ©ç”¨ç‡
**ç”Ÿäº§é¦–é€‰**: å¤§å¤šæ•°ç”Ÿäº§ç¯å¢ƒçš„æœ€ä½³é€‰æ‹©

---

## ğŸš€ æµæ°´çº¿å¹¶è¡Œäº‹ä»¶å¾ªç¯

### ğŸ¯ æ ¸å¿ƒè®¾è®¡æ¦‚å¿µ

```python
@DynamicGradMode()
def event_loop_pp(self):
    """æµæ°´çº¿å¹¶è¡Œäº‹ä»¶å¾ªç¯çš„æ ¸å¿ƒæ¦‚å¿µ"""
    # ä¸ºæ¯ä¸ªæµæ°´çº¿é˜¶æ®µåˆ›å»ºå¾®æ‰¹æ¬¡
    mbs = [None] * self.pp_size
    self.running_mbs = [ScheduleBatch(reqs=[]) for _ in range(self.pp_size)]

    while True:
        # 1. å¤„ç†è¯·æ±‚
        recv_reqs = self.recv_requests()
        self.process_input_requests(recv_reqs)

        # 2. ä¸ºæ¯ä¸ªé˜¶æ®µå‡†å¤‡å¾®æ‰¹æ¬¡
        for mbi in range(self.pp_size):
            new_batch = self.get_new_batch_prefill()
            mbs[mbi] = new_batch if new_batch else self.running_mbs[mbi]

        # 3. å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰å¾®æ‰¹æ¬¡
        if any(mb and not mb.is_empty() for mb in mbs):
            results = self.run_batch_pp(mbs)
            for mb, result in zip(mbs, results):
                if mb and not mb.is_empty():
                    self.process_batch_result(mb, result)
```

### ğŸ” æºç å®ç°ç»†èŠ‚

```python
@DynamicGradMode()
def event_loop_pp(self):
    """çœŸå®çš„SGLangæµæ°´çº¿å¹¶è¡Œäº‹ä»¶å¾ªç¯å®ç°"""
    mbs = [None] * self.pp_size
    last_mbs = [None] * self.pp_size
    self.running_mbs = [
        ScheduleBatch(reqs=[], batch_is_full=False) for _ in range(self.pp_size)
    ]

    while True:
        recv_reqs = self.recv_requests()
        self.process_input_requests(recv_reqs)

        # ä¸ºæ¯ä¸ªæµæ°´çº¿é˜¶æ®µå‡†å¤‡å¾®æ‰¹æ¬¡
        for mbi in range(self.pp_size):
            # å¤„ç†åˆ†å—è¯·æ±‚çš„å¤æ‚é€»è¾‘
            chunked_req_to_exclude = set()
            if self.chunked_req:
                chunked_req_to_exclude.add(self.chunked_req)
                self.tree_cache.cache_unfinished_req(self.chunked_req)
                self.req_to_token_pool.free(self.chunked_req.req_pool_idx)

            # åˆå¹¶ä¸Šä¸€è½®çš„å¾®æ‰¹æ¬¡ç»“æœ
            if last_mbs[mbi] and last_mbs[mbi].forward_mode.is_extend():
                if last_mbs[mbi].chunked_req is not None:
                    chunked_req_to_exclude.add(last_mbs[mbi].chunked_req)

                last_bs = last_mbs[mbi].batch_size()
                last_mbs[mbi].filter_batch(
                    chunked_req_to_exclude=list(chunked_req_to_exclude)
                )
                if last_mbs[mbi].batch_size() < last_bs:
                    self.running_mbs[mbi].batch_is_full = False

                if not last_mbs[mbi].is_empty() and not last_mbs[mbi].is_prefill_only:
                    if self.running_mbs[mbi].is_empty():
                        self.running_mbs[mbi] = last_mbs[mbi]
                    else:
                        self.running_mbs[mbi].merge_batch(last_mbs[mbi])
                
            # è·å–æ–°çš„é¢„å¡«å……æ‰¹æ¬¡
            new_batch = self.get_new_batch_prefill()
            if new_batch is not None:
                if self.running_mbs[mbi].is_empty():
                    mbs[mbi] = new_batch
                else:
                    new_batch.mix_with_running(self.running_mbs[mbi])
                    mbs[mbi] = new_batch
            else:
                mbs[mbi] = (
                    self.running_mbs[mbi] if not self.running_mbs[mbi].is_empty() else None
                )

        # æ‰§è¡Œæ‰€æœ‰å¾®æ‰¹æ¬¡
        if any(mb and not mb.is_empty() for mb in mbs):
            results = self.run_batch_pp(mbs)
            for mbi, (mb, result) in enumerate(zip(mbs, results)):
                if mb and not mb.is_empty():
                    self.process_batch_result(mb, result)
        else:
            self.self_check_during_idle()

        last_mbs = mbs.copy()

ğŸ’¡ **å®ç°è¯´æ˜**: æµæ°´çº¿å¾ªç¯ä¸ºæ¯ä¸ªPPé˜¶æ®µç»´æŠ¤ç‹¬ç«‹çš„å¾®æ‰¹æ¬¡å’Œè¿è¡ŒçŠ¶æ€ï¼Œæ”¯æŒåˆ†å—è¯·æ±‚ã€æ‰¹æ¬¡è¿‡æ»¤ç­‰å¤æ‚é€»è¾‘ã€‚ä¸»è¦ç”¨äºè¶…å¤§æ¨¡å‹çš„åˆ†å¸ƒå¼æ¨ç†ã€‚
```

### ğŸ”§ å¤šå¾®æ‰¹æ¬¡ç®¡ç†

### æµæ°´çº¿è°ƒåº¦ç­–ç•¥

æµæ°´çº¿å¹¶è¡Œçš„å…³é”®åœ¨äºå¤šä¸ªå¾®æ‰¹æ¬¡çš„åè°ƒæ‰§è¡Œï¼š

**å¾®æ‰¹æ¬¡åˆ†é…**: æ¯ä¸ªæµæ°´çº¿é˜¶æ®µç»´æŠ¤ç‹¬ç«‹çš„å¾®æ‰¹æ¬¡ï¼Œé¿å…ä¸åŒé˜¶æ®µé—´çš„èµ„æºç«äº‰ã€‚

**åŒæ­¥æœºåˆ¶**: é€šè¿‡barrieråŒæ­¥ç¡®ä¿å„ä¸ªæµæ°´çº¿é˜¶æ®µçš„æ‰§è¡Œé¡ºåºã€‚

**è´Ÿè½½å‡è¡¡**: åŠ¨æ€è°ƒæ•´å„ä¸ªå¾®æ‰¹æ¬¡çš„å¤§å°ï¼Œå¹³è¡¡å„é˜¶æ®µçš„è®¡ç®—è´Ÿè½½ã€‚

### ç‰¹ç‚¹

**æ”¯æŒè¶…å¤§æ¨¡å‹**: çªç ´å•GPUæ˜¾å­˜é™åˆ¶
**çº¿æ€§æ‰©å±•**: ç†è®ºä¸Šå¯ä»¥æ— é™å¢åŠ æ¨¡å‹å±‚æ•°
**ä¸“ç”¨åœºæ™¯**: ä¸»è¦ç”¨äºç‰¹å¤§æ¨¡å‹çš„åˆ†å¸ƒå¼æ¨ç†

## DynamicGradModeè£…é¥°å™¨

@DynamicGradMode()è£…é¥°å™¨æ˜¯æ‰€æœ‰äº‹ä»¶å¾ªç¯çš„é‡è¦ä¼˜åŒ–æœºåˆ¶ï¼š

```python
@DynamicGradMode()
def event_loop_xxx(self):
    # æ ¹æ®å½“å‰æ“ä½œè‡ªåŠ¨åˆ‡æ¢æ¢¯åº¦è®¡ç®—æ¨¡å¼
    # æ¨ç†æ—¶å…³é—­æ¢¯åº¦èŠ‚çœå†…å­˜ï¼ŒLoRAè®­ç»ƒæ—¶å¼€å¯æ¢¯åº¦
```

è¿™ç§åŠ¨æ€åˆ‡æ¢ä½¿å¾—åŒä¸€ä¸ªè°ƒåº¦å™¨èƒ½å¤ŸåŒæ—¶æ”¯æŒçº¯æ¨ç†å’Œå¸¦æ¢¯åº¦çš„æ“ä½œã€‚

## æ€§èƒ½ç‰¹æ€§å¯¹æ¯”

### å»¶è¿Ÿç‰¹æ€§

**æ ‡å‡†å¾ªç¯**: æœ€ä½å»¶è¿Ÿï¼Œé€‚åˆå®æ—¶æ€§è¦æ±‚é«˜çš„åœºæ™¯
**é‡å å¾ªç¯**: ä¸­ç­‰å»¶è¿Ÿï¼Œä½†æ˜¾è‘—æé«˜ååé‡  
**æµæ°´çº¿å¾ªç¯**: è¾ƒé«˜çš„å•æ¬¡å»¶è¿Ÿï¼Œä½†æ”¯æŒæ›´å¤§çš„æ¨¡å‹

### ååé‡ç‰¹æ€§

**æ ‡å‡†å¾ªç¯**: åŸºå‡†ååé‡ï¼Œå—ä¸²è¡Œå¤„ç†é™åˆ¶
**é‡å å¾ªç¯**: å¯æå‡20-40%çš„ååé‡ï¼Œå…·ä½“å–å†³äºCPU/GPUæ¯”ä¾‹
**æµæ°´çº¿å¾ªç¯**: ç†è®ºä¸Šå¯çº¿æ€§æ‰©å±•ï¼Œæ”¯æŒè¶…å¤§æ¨¡å‹æ¨ç†

### é€‚ç”¨åœºæ™¯

**æ ‡å‡†å¾ªç¯**: 
- å¼€å‘è°ƒè¯•ç¯å¢ƒ
- å°è§„æ¨¡éƒ¨ç½²
- å»¶è¿Ÿæ•æ„Ÿåº”ç”¨

**é‡å å¾ªç¯**:
- ç”Ÿäº§ç¯å¢ƒçš„é¦–é€‰
- é«˜ååé‡éœ€æ±‚
- CPU-GPUå‡è¡¡çš„å·¥ä½œè´Ÿè½½

**æµæ°´çº¿å¾ªç¯**:
- è¶…å¤§æ¨¡å‹æ¨ç†
- å¤šGPUé›†ç¾¤éƒ¨ç½²
- æ˜¾å­˜å—é™åœºæ™¯

---

## ğŸ“ æ€»ç»“

SGLangçš„äº‹ä»¶å¾ªç¯è®¾è®¡ä½“ç°äº†ç°ä»£æ¨ç†ç³»ç»Ÿå¯¹ä¸åŒåº”ç”¨åœºæ™¯çš„æ·±å…¥ç†è§£å’Œç²¾å¿ƒä¼˜åŒ–ï¼š

### ğŸ¯ æ ¸å¿ƒè®¾è®¡åŸåˆ™

**åœºæ™¯å¯¼å‘**: ä¸‰ç§äº‹ä»¶å¾ªç¯åˆ†åˆ«é’ˆå¯¹å¼€å‘è°ƒè¯•ï¼ˆæ ‡å‡†ï¼‰ã€ç”Ÿäº§éƒ¨ç½²ï¼ˆé‡å ï¼‰ã€è¶…å¤§æ¨¡å‹ï¼ˆæµæ°´çº¿ï¼‰ç­‰ä¸åŒåœºæ™¯ä¼˜åŒ–ã€‚

**è‡ªåŠ¨é€‰æ‹©**: æ ¹æ®`pp_size`ã€`enable_overlap`ã€`disaggregation_mode`ç­‰é…ç½®å‚æ•°è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æ‰§è¡Œæ¨¡å¼ã€‚

**æ€§èƒ½ä¼˜åŒ–**: ä»ä¸²è¡Œæ‰§è¡Œåˆ°CPU-GPUå¹¶è¡Œï¼Œå†åˆ°æµæ°´çº¿åˆ†å¸ƒå¼ï¼Œé€çº§æå‡ç³»ç»Ÿæ€§èƒ½å’Œæ‰©å±•æ€§ã€‚

### ğŸ”§ å®ç°ç‰¹è‰²

**æºç å‡†ç¡®æ€§**: æœ¬æ–‡æ¡£åŸºäºçœŸå®SGLangæºç ç¼–å†™ï¼Œæ‰€æœ‰äº‹ä»¶å¾ªç¯å®ç°éƒ½æ¥è‡ªå®é™…ä»£ç ï¼Œç¡®ä¿æŠ€æœ¯å‡†ç¡®æ€§ã€‚

**æ•™å­¦ä¸å®è·µå¹¶é‡**: é‡‡ç”¨"æ ¸å¿ƒè®¾è®¡æ¦‚å¿µ + æºç å®ç°ç»†èŠ‚"çš„åŒé‡ç»“æ„ï¼Œæ—¢ä¾¿äºç†è§£äº‹ä»¶å¾ªç¯åŸç†ï¼Œåˆæä¾›å®ç°å‚è€ƒã€‚

**å¤æ‚æ€§é€æ˜**: æ˜ç¡®å±•ç¤ºäº†æ•™å­¦ç®€åŒ–ç‰ˆæœ¬ä¸çœŸå®æºç çš„å·®å¼‚ï¼Œè®©å¼€å‘è€…äº†è§£å®é™…äº‹ä»¶å¾ªç¯çš„å¤æ‚æ€§ã€‚

### ğŸ“ˆ æ€§èƒ½ç‰¹æ€§å¯¹æ¯”

| äº‹ä»¶å¾ªç¯ç±»å‹ | å»¶è¿Ÿç‰¹æ€§ | ååé‡æå‡ | é€‚ç”¨åœºæ™¯ |
|------------|---------|-----------|---------|
| **æ ‡å‡†å¾ªç¯** | æœ€ä½å»¶è¿Ÿ | åŸºå‡†æ€§èƒ½ | å¼€å‘è°ƒè¯•ã€å»¶è¿Ÿæ•æ„Ÿ |
| **é‡å å¾ªç¯** | ä¸­ç­‰å»¶è¿Ÿ | +20-40% | ç”Ÿäº§ç¯å¢ƒã€é«˜ååé‡ |
| **æµæ°´çº¿å¾ªç¯** | è¾ƒé«˜å»¶è¿Ÿ | çº¿æ€§æ‰©å±• | è¶…å¤§æ¨¡å‹ã€åˆ†å¸ƒå¼ |

### ğŸš€ æŠ€æœ¯äº®ç‚¹

1. **@DynamicGradMode()è£…é¥°å™¨**: æ ¹æ®æ“ä½œç±»å‹è‡ªåŠ¨åˆ‡æ¢æ¢¯åº¦è®¡ç®—æ¨¡å¼
2. **threading.EventåŒæ­¥**: å®ç°CPU-GPUç²¾ç¡®åè°ƒçš„å…³é”®æœºåˆ¶
3. **dequeç»“æœé˜Ÿåˆ—**: é«˜æ•ˆç®¡ç†å¼‚æ­¥æ‰¹æ¬¡ç»“æœçš„æ•°æ®ç»“æ„
4. **è™šæ‹Ÿé¦–æ‰¹æ¬¡**: ä¼˜é›…å¯åŠ¨é‡å æµæ°´çº¿çš„è®¾è®¡æŠ€å·§
5. **å¤šå¾®æ‰¹æ¬¡ç®¡ç†**: æ”¯æŒæµæ°´çº¿å¹¶è¡Œçš„å¤æ‚è°ƒåº¦é€»è¾‘
6. **åˆ†ç¦»å¼æ¶æ„é›†æˆ**: ä¸é¢„å¡«å……/è§£ç åˆ†ç¦»æ·±åº¦é›†æˆçš„7ç§äº‹ä»¶å¾ªç¯ç»„åˆ

ç†è§£è¿™äº›äº‹ä»¶å¾ªç¯çš„åŸç†å’Œç‰¹æ€§ï¼Œå¯¹äºç³»ç»Ÿéƒ¨ç½²ã€æ€§èƒ½è°ƒä¼˜å’Œé—®é¢˜è¯Šæ–­éƒ½å…·æœ‰é‡è¦æ„ä¹‰ã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œå»ºè®®ä¼˜å…ˆé€‰æ‹©é‡å å¾ªç¯ç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œå®ƒåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹èƒ½å¤Ÿæä¾›æœ€ä½³çš„æ€§èƒ½å¹³è¡¡ã€‚