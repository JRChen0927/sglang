# ä¼šè¯ç®¡ç†ä¸çŠ¶æ€æ§åˆ¶

---

SGLangè°ƒåº¦å™¨æ”¯æŒä¼šè¯çº§åˆ«çš„è¯·æ±‚ç®¡ç†ï¼Œé€šè¿‡Sessionæœºåˆ¶å®ç°å¯¹è¯ä¸Šä¸‹æ–‡çš„æŒä¹…åŒ–å’Œè¯·æ±‚é“¾çš„ç®¡ç†ã€‚æœ¬ç« åŸºäºçœŸå®æºç è§£æä¼šè¯ç®¡ç†çš„æ ¸å¿ƒå®ç°ã€‚

---

## ğŸ—ï¸ ä¼šè¯æ¶æ„è®¾è®¡

### ğŸ¯ æ ¸å¿ƒè®¾è®¡æ¦‚å¿µ

**ä¼šè¯ç®¡ç†çš„è®¾è®¡ç†å¿µ**ï¼šSessionç±»é‡‡ç”¨æ ‘å½¢ç»“æ„ç®¡ç†ä¼šè¯ä¸­çš„è¯·æ±‚é“¾ï¼Œæ”¯æŒå¤šè½®å¯¹è¯çš„ä¸Šä¸‹æ–‡ä¿æŒå’Œè¯·æ±‚å…³ç³»ç®¡ç†ï¼Œé€šè¿‡å®¹é‡æ§åˆ¶ç¡®ä¿å†…å­˜ä½¿ç”¨çš„åˆç†æ€§ã€‚

> ğŸ“ **ç®€åŒ–è¯´æ˜**ï¼šä»¥ä¸‹ä¸ºSessionç±»çš„æ ¸å¿ƒæ¦‚å¿µç®€åŒ–ç‰ˆæœ¬ï¼Œçªå‡ºä¸»è¦è®¾è®¡æ€è·¯ã€‚çœŸå®å®ç°åŒ…å«æ›´å¤šä¼šè¯çŠ¶æ€ç®¡ç†å’Œé”™è¯¯å¤„ç†é€»è¾‘ã€‚

```python
class Session:
    """ä¼šè¯ç®¡ç†ï¼ˆç®€åŒ–ç‰ˆï¼‰"""
    def __init__(self, capacity_of_str_len: int, session_id: str = None):
        self.session_id = session_id or uuid.uuid4().hex
        self.capacity_of_str_len = capacity_of_str_len  # å®¹é‡é™åˆ¶
        self.req_nodes: Dict[str, SessionReqNode] = {}  # è¯·æ±‚èŠ‚ç‚¹æ˜ å°„
        
    def create_req(self, recv_req, tokenizer):
        """åˆ›å»ºä¼šè¯è¯·æ±‚ï¼ˆç®€åŒ–ç‰ˆï¼‰"""
        # 1. æ„å»ºè¯·æ±‚å¯¹è±¡
        # 2. åˆ›å»ºè¯·æ±‚èŠ‚ç‚¹
        # 3. å»ºç«‹çˆ¶å­å…³ç³»
        pass
```

### ğŸ” æºç å®ç°ç»†èŠ‚

```python
class Session:
    """çœŸå®çš„SGLang Sessionå®ç°"""
    def __init__(self, capacity_of_str_len: int, session_id: Optional[str] = None):
        self.session_id = session_id if session_id is not None else uuid.uuid4().hex
        self.capacity_of_str_len = capacity_of_str_len  # ä¼šè¯å­—ç¬¦ä¸²é•¿åº¦å®¹é‡é™åˆ¶
        self.req_nodes: Dict[str, SessionReqNode] = {}  # è¯·æ±‚IDåˆ°èŠ‚ç‚¹çš„æ˜ å°„

ğŸ’¡ **å®ç°è¯´æ˜**: çœŸå®çš„Sessionç±»æ”¯æŒä¼šè¯å®¹é‡ç®¡ç†ã€è¯·æ±‚æ ‘ç»“æ„ã€ä¸Šä¸‹æ–‡ä¿æŒç­‰å¤æ‚åŠŸèƒ½ã€‚æ•™å­¦ç‰ˆæœ¬çªå‡º"IDç®¡ç†â†’èŠ‚ç‚¹æ˜ å°„â†’å®¹é‡æ§åˆ¶"çš„æ ¸å¿ƒæ¶æ„ã€‚
```

### ğŸ“Š Sessionæ ¸å¿ƒæ•°æ®ç»“æ„

### ğŸŒ³ SessionReqNodeè¯·æ±‚èŠ‚ç‚¹

```python
class SessionReqNode:
    def __init__(self, req, parent=None, childs=None):
        self.req = req                    # å…³è”çš„Reqå¯¹è±¡
        self.parent = parent              # çˆ¶èŠ‚ç‚¹å¼•ç”¨
        self.childs = [] if not childs else childs  # å­èŠ‚ç‚¹åˆ—è¡¨
        
        # è‡ªåŠ¨å»ºç«‹çˆ¶å­å…³ç³»
        if parent is not None:
            parent.childs.append(self)
```

è¯·æ±‚èŠ‚ç‚¹æ„å»ºäº†ä¼šè¯å†…çš„è¯·æ±‚æ ‘ç»“æ„ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªè¯·æ±‚ï¼Œé€šè¿‡parent/childså»ºç«‹å±‚æ¬¡å…³ç³»ã€‚

---

## ğŸ”„ ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†

### ğŸš€ ä¼šè¯åˆ›å»ºæµç¨‹

è°ƒåº¦å™¨é€šè¿‡`open_session`æ–¹æ³•åˆ›å»ºæ–°ä¼šè¯ï¼š

```python
def open_session(self, recv_req: OpenSessionReqInput):
    """åˆ›å»ºæ–°ä¼šè¯"""
    session_id = recv_req.session_id
    
    # 1. éªŒè¯ä¼šè¯IDå”¯ä¸€æ€§
    if session_id in self.sessions:
        logger.warning(f"session id {session_id} already exist, cannot open.")
        return OpenSessionReqOutput(session_id, False)
    elif session_id is None:
        logger.warning("session id is None, cannot open.")
        return OpenSessionReqOutput(session_id, False)
    
    # 2. åˆ›å»ºä¼šè¯å¯¹è±¡
    self.sessions[session_id] = Session(
        recv_req.capacity_of_str_len, session_id
    )
    
    return OpenSessionReqOutput(session_id, True)
```

### ğŸ—‘ï¸ ä¼šè¯é”€æ¯æµç¨‹

```python
def close_session(self, recv_req: CloseSessionReqInput):
    """å…³é—­å¹¶æ¸…ç†ä¼šè¯"""
    session_id = recv_req.session_id
    
    if session_id not in self.sessions:
        logger.warning(f"session id {session_id} does not exist, cannot delete.")
    else:
        # ç®€å•åœ°ä»sessionså­—å…¸ä¸­åˆ é™¤
        del self.sessions[session_id]
```

---

## ğŸŒ³ è¯·æ±‚æ ‘ç®¡ç†

### ğŸ¯ ä¼šè¯è¯·æ±‚åˆ›å»º

Sessionçš„æ ¸å¿ƒæ–¹æ³•æ˜¯`create_req`ï¼Œè´Ÿè´£åœ¨ä¼šè¯ä¸­åˆ›å»ºæ–°è¯·æ±‚å¹¶å»ºç«‹è¯·æ±‚æ ‘ç»“æ„ï¼š

```python
def create_req(self, req: TokenizedGenerateReqInput, tokenizer):
    """åœ¨ä¼šè¯ä¸­åˆ›å»ºè¯·æ±‚ï¼Œæ„å»ºè¯·æ±‚æ ‘ç»“æ„"""
    assert req.session_params is not None
    session_params = req.session_params
    
    last_req_node = None
    last_req = None
    abort = False
    
    # 1. å¤„ç†æ›¿æ¢æ¨¡å¼
    if session_params.replace:
        if session_params.rid is None:
            # æ¸…ç©ºæ•´ä¸ªä¼šè¯
            for _, req_node in self.req_nodes.items():
                req_node.clear(self.req_nodes)
        else:
            # æ›¿æ¢ç‰¹å®šèŠ‚ç‚¹
            if session_params.rid not in self.req_nodes:
                abort = True
            else:
                last_req_node = self.req_nodes[session_params.rid]
                last_req_node.abort()
                last_req = last_req_node.req
                last_req_node.clear_childs(self.req_nodes)
    
    # 2. å¤„ç†è¿½åŠ æ¨¡å¼
    else:
        if session_params.rid is not None:
            if session_params.rid not in self.req_nodes:
                abort = True
            else:
                last_req_node = self.req_nodes[session_params.rid]
                last_req = last_req_node.req
                if not last_req.finished():
                    logging.warning("å‘æœªå®Œæˆçš„è¯·æ±‚è¿½åŠ å†…å®¹")
                    abort = True
    
    # 3. æ„å»ºè¾“å…¥åºåˆ—ï¼ˆä¸Šä¸‹æ–‡ç»§æ‰¿ï¼‰
    if last_req is not None:
        # å¤„ç†BOS token
        if tokenizer is not None and req.input_ids[0] == tokenizer.bos_token_id:
            req.input_ids = req.input_ids[1:]
        
        # ç»§æ‰¿çˆ¶è¯·æ±‚çš„è¾“å…¥å’Œè¾“å‡º
        input_ids = (
            last_req.origin_input_ids
            + last_req.output_ids[:last_req.sampling_params.max_new_tokens]
        )
        
        # æ ¹æ®session_paramsè°ƒæ•´ç»§æ‰¿è¡Œä¸º
        if session_params.drop_previous_output:
            input_ids = last_req.origin_input_ids[:]
        
        if session_params.offset and session_params.offset != 0:
            input_ids = input_ids[:session_params.offset] + req.input_ids
        else:
            input_ids += req.input_ids
            
        # åŒæ ·å¤„ç†unpaddedç‰ˆæœ¬
        input_ids_unpadded = (
            last_req.origin_input_ids_unpadded
            + last_req.output_ids[:last_req.sampling_params.max_new_tokens]
        )
        # ... ç±»ä¼¼çš„å¤„ç†é€»è¾‘
    else:
        input_ids = req.input_ids
        input_ids_unpadded = req.input_ids
    
    # 4. åˆ›å»ºæ–°çš„Reqå¯¹è±¡
    new_req = Req(
        rid=req.rid,
        origin_input_text=None,
        origin_input_ids=input_ids,
        origin_input_ids_unpadded=input_ids_unpadded,
        sampling_params=req.sampling_params,
        lora_path=req.lora_path,
        session_id=self.session_id,
        custom_logit_processor=req.custom_logit_processor,
        stream=req.stream,
        return_logprob=req.return_logprob,
        top_logprobs_num=req.top_logprobs_num,
        token_ids_logprob=req.token_ids_logprob,
    )
    
    # 5. ç»§æ‰¿å¤šæ¨¡æ€è¾“å…¥
    if last_req is not None:
        new_req.multimodal_inputs = last_req.multimodal_inputs
    new_req.tokenizer = tokenizer
    
    # 6. å¤„ç†abortæƒ…å†µæˆ–åˆ›å»ºèŠ‚ç‚¹
    if abort:
        new_req.set_finish_with_abort("Invalid request session id")
    else:
        new_req_node = SessionReqNode(new_req, last_req_node)
        self.req_nodes[req.rid] = new_req_node
    
    return new_req
```

## èŠ‚ç‚¹ç®¡ç†æ–¹æ³•

### æ¸…ç†å­èŠ‚ç‚¹

```python
def clear_childs(self, req_dict):
    """é€’å½’æ¸…ç†æ‰€æœ‰å­èŠ‚ç‚¹"""
    for req_node in self.childs:
        req_node.clear(req_dict)
    self.childs = []
```

### æ¸…ç†èŠ‚ç‚¹

```python
def clear(self, req_dict):
    """æ¸…ç†å½“å‰èŠ‚ç‚¹åŠå…¶æ‰€æœ‰å­èŠ‚ç‚¹"""
    # å…ˆé€’å½’æ¸…ç†å­èŠ‚ç‚¹
    for req_node in self.childs:
        req_node.clear(req_dict)
    
    # å¦‚æœè¯·æ±‚æœªå®Œæˆï¼Œæ ‡è®°ä¸ºç»ˆæ­¢
    if self.req.finished_reason is None:
        self.req.to_abort = True
    
    # ä»è¯·æ±‚å­—å…¸ä¸­åˆ é™¤
    del req_dict[self.req.rid]
```

### ç»ˆæ­¢èŠ‚ç‚¹

```python
def abort(self):
    """ç»ˆæ­¢èŠ‚ç‚¹å¯¹åº”çš„è¯·æ±‚"""
    if self.req.finished_reason is None:
        self.req.to_abort = True
```

## ä¼šè¯å‚æ•°æ§åˆ¶

### SessionParamsé…ç½®

ä¼šè¯è¡Œä¸ºé€šè¿‡SessionParamsæ§åˆ¶ï¼š

```python
@dataclass
class SessionParams:
    id: Optional[str] = None              # ä¼šè¯ID
    rid: Optional[str] = None             # çˆ¶è¯·æ±‚ID
    offset: Optional[int] = None          # ç»§æ‰¿åç§»ä½ç½®
    replace: Optional[bool] = None        # æ˜¯å¦æ›¿æ¢æ¨¡å¼
    drop_previous_output: Optional[bool] = None  # æ˜¯å¦ä¸¢å¼ƒå‰æ¬¡è¾“å‡º
```

### ç»§æ‰¿è¡Œä¸ºæ§åˆ¶

- **æ­£å¸¸è¿½åŠ **: ç»§æ‰¿çˆ¶è¯·æ±‚çš„å®Œæ•´è¾“å…¥å’Œè¾“å‡º
- **drop_previous_output**: åªç»§æ‰¿è¾“å…¥ï¼Œä¸¢å¼ƒè¾“å‡º
- **offset**: ä»æŒ‡å®šä½ç½®å¼€å§‹ç»§æ‰¿
- **replace**: æ›¿æ¢æŒ‡å®šèŠ‚ç‚¹è€Œéè¿½åŠ 

## APIé›†æˆ

### TokenizerManagerä¸­çš„ä¼šè¯ç®¡ç†

```python
async def open_session(self, obj: OpenSessionReqInput, request: Optional[fastapi.Request] = None):
    self.auto_create_handle_loop()
    
    # ç”Ÿæˆä¼šè¯IDï¼ˆå¦‚æœæœªæä¾›ï¼‰
    if obj.session_id is None:
        obj.session_id = uuid.uuid4().hex
    elif obj.session_id in self.session_futures:
        return None  # ä¼šè¯å·²å­˜åœ¨
    
    # å‘é€ç»™è°ƒåº¦å™¨
    self.send_to_scheduler.send_pyobj(obj)
    
    # ç­‰å¾…è°ƒåº¦å™¨å“åº”
    self.session_futures[obj.session_id] = asyncio.Future()
    session_id = await self.session_futures[obj.session_id]
    del self.session_futures[obj.session_id]
    return session_id

async def close_session(self, obj: CloseSessionReqInput, request: Optional[fastapi.Request] = None):
    await self.send_to_scheduler.send_pyobj(obj)
```

## ä¼šè¯çŠ¶æ€å¯è§†åŒ–

### è¯·æ±‚æ ‘æ‰“å°

SessionReqNodeæä¾›äº†è¯·æ±‚æ ‘çš„å¯è§†åŒ–æ–¹æ³•ï¼š

```python
def __str__(self):
    return self._str_helper(self.req.rid)

def _str_helper(self, prefix=""):
    """é€’å½’æ„å»ºæ ‘çŠ¶ç»“æ„å­—ç¬¦ä¸²"""
    if len(self.childs) == 0:
        return prefix + "\n"
    else:
        origin_prefix = prefix
        prefix += " -- " + self.childs[0].req.rid
        ret = self.childs[0]._str_helper(prefix)
        for child in self.childs[1:]:
            prefix = " " * len(origin_prefix) + " \\- " + child.req.rid
            ret += child._str_helper(prefix)
        return ret
```

è¿™ä¼šç”Ÿæˆç±»ä¼¼çš„æ ‘çŠ¶è¾“å‡ºï¼š
```
root_request
 -- child1
    -- grandchild1
 \- child2
    -- grandchild2
    \- grandchild3
```

## æ€»ç»“

SGLangçš„ä¼šè¯ç®¡ç†ç³»ç»Ÿå®é™…ä¸Šç›¸å½“ç®€æ´ï¼Œæ ¸å¿ƒåŠŸèƒ½åŒ…æ‹¬ï¼š

**æ ¸å¿ƒç‰¹æ€§**: 
- åŸºäºè¯·æ±‚æ ‘çš„ä¼šè¯ç»“æ„ç®¡ç†
- è‡ªåŠ¨çš„ä¸Šä¸‹æ–‡ç»§æ‰¿æœºåˆ¶
- çµæ´»çš„èŠ‚ç‚¹æ›¿æ¢å’Œè¿½åŠ æ¨¡å¼
- ç®€å•ä½†æœ‰æ•ˆçš„èŠ‚ç‚¹æ¸…ç†æœºåˆ¶

**å…³é”®å®ç°**:
- Sessionç±»ç®¡ç†ä¼šè¯å…ƒæ•°æ®å’Œè¯·æ±‚èŠ‚ç‚¹æ˜ å°„
- SessionReqNodeæ„å»ºçˆ¶å­å…³ç³»çš„è¯·æ±‚æ ‘
- create_reqæ–¹æ³•å®ç°å¤æ‚çš„ä¸Šä¸‹æ–‡ç»§æ‰¿é€»è¾‘
- è°ƒåº¦å™¨é›†æˆæä¾›ä¼šè¯çš„åˆ›å»ºå’Œé”€æ¯æ¥å£

**è®¾è®¡å“²å­¦**: SGLangçš„ä¼šè¯ç®¡ç†é‡‡ç”¨äº†ç®€å•ç›´æ¥çš„è®¾è®¡ï¼Œé¿å…äº†è¿‡åº¦å¤æ‚çš„çŠ¶æ€ç®¡ç†ï¼Œä¸“æ³¨äºæ ¸å¿ƒçš„å¯¹è¯ä¸Šä¸‹æ–‡ç»§æ‰¿åŠŸèƒ½ã€‚