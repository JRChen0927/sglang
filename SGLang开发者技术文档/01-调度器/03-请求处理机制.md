# è¯·æ±‚å¤„ç†æœºåˆ¶

---

SGLangè°ƒåº¦å™¨é€šè¿‡ç»“æ„åŒ–çš„è¯·æ±‚å¤„ç†æµç¨‹æ¥ç®¡ç†å„ç§ç±»å‹çš„è¯·æ±‚ã€‚æœ¬ç« æ·±å…¥ä»‹ç»è°ƒåº¦å™¨çš„è¯·æ±‚æ¥æ”¶ã€åˆ†å‘å’Œå¤„ç†æœºåˆ¶ï¼Œæ­ç¤ºSGLangå¦‚ä½•é«˜æ•ˆå¤„ç†å¤šç§ç±»å‹çš„æ¨ç†è¯·æ±‚ã€‚

---

## 1. åˆå­¦è€…æŒ‡å—ï¼šè¯·æ±‚å¤„ç†åŸºç¡€æ¦‚å¿µ

### 1.1 ä»€ä¹ˆæ˜¯è¯·æ±‚å¤„ç†ï¼Ÿ

åœ¨å­¦ä¹ å…·ä½“å®ç°ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆä»æœ€åŸºç¡€çš„æ¦‚å¿µå¼€å§‹ç†è§£ã€‚è¯·æ±‚å¤„ç†æ˜¯AIæ¨ç†ç³»ç»Ÿçš„"ç¥ç»ä¸­æ¢"ï¼Œå®ƒå†³å®šäº†ç³»ç»Ÿå¦‚ä½•å“åº”ç”¨æˆ·çš„å„ç§éœ€æ±‚ã€‚

**ç°å®ä¸–ç•Œçš„æŒ‘æˆ˜**ï¼š
- **è¯·æ±‚ç±»å‹å¤šæ ·**ï¼šç”¨æˆ·å¯èƒ½è¦æ±‚å¯¹è¯ã€ç¿»è¯‘ã€å›¾ç‰‡åˆ†æã€å‘é‡è®¡ç®—ç­‰20+ç§ä¸åŒåŠŸèƒ½
- **å¹¶å‘å‹åŠ›å·¨å¤§**ï¼šç”Ÿäº§ç¯å¢ƒå¯èƒ½åŒæ—¶å¤„ç†æ•°åƒä¸ªè¯·æ±‚
- **å“åº”æ—¶é—´è¦æ±‚**ï¼šç”¨æˆ·æœŸæœ›æ¯«ç§’çº§çš„å“åº”ï¼Œä¸èƒ½æœ‰æ˜æ˜¾å»¶è¿Ÿ
- **èµ„æºåè°ƒå¤æ‚**ï¼šå¤šGPUç¯å¢ƒä¸‹éœ€è¦ç²¾ç¡®çš„åè°ƒå’ŒåŒæ­¥

**æƒ³è±¡ä¸€ä¸ªç°ä»£åŒ–çš„å¿«é€’åˆ†æ‹£ä¸­å¿ƒ**ï¼š
- **åŒ…è£¹åˆ°è¾¾**ï¼ˆè¯·æ±‚æ¥æ”¶ï¼‰ï¼šå„ç§å¿«é€’ä»å…¨å›½å„åœ°è¿æ¥ï¼Œæœ‰æ–‡ä»¶ã€ç”Ÿé²œã€æ˜“ç¢å“ç­‰
- **æ™ºèƒ½åˆ†æ‹£**ï¼ˆè¯·æ±‚åˆ†å‘ï¼‰ï¼šè‡ªåŠ¨æ‰«æç³»ç»Ÿæ ¹æ®åŒ…è£¹æ ‡ç­¾åˆ†é…åˆ°ä¸åŒå¤„ç†çº¿
- **ä¸“ä¸šå¤„ç†**ï¼ˆè¯·æ±‚å¤„ç†ï¼‰ï¼šç”Ÿé²œæœ‰å†·é“¾å¤„ç†ï¼Œæ˜“ç¢å“æœ‰é˜²éœ‡åŒ…è£…ï¼Œæ–‡ä»¶æœ‰å¿«é€Ÿé€šé“
- **åŠ¨æ€æ’é˜Ÿ**ï¼ˆé˜Ÿåˆ—ç®¡ç†ï¼‰ï¼šæ ¹æ®ä¼˜å…ˆçº§å’Œç›®çš„åœ°æ™ºèƒ½æ’é˜Ÿï¼Œä¼˜åŒ–é…é€æ•ˆç‡

### 1.2 è¯·æ±‚å¤„ç†æµç¨‹è¯¦ç»†å¯¹æ¯”è¡¨

| é˜¶æ®µ | åŠŸèƒ½ | è¾“å…¥ | è¾“å‡º | å…³é”®ç»„ä»¶ | å¤„ç†æ—¶é—´ | ç±»æ¯”ç†è§£ | æŠ€æœ¯æŒ‘æˆ˜ |
|------|------|------|------|----------|----------|----------|----------|
| **æ¥æ”¶** | ä»ç½‘ç»œè·å–è¯·æ±‚ | ç½‘ç»œæ•°æ®åŒ… | ç»“æ„åŒ–è¯·æ±‚å¯¹è±¡ | recv_requests() | <1ms | å¿«é€’è½¦å¸è´§ | å¹¶å‘å¤„ç†ã€åˆ†å¸ƒå¼åŒæ­¥ |
| **åˆ†å‘** | æ ¹æ®ç±»å‹è·¯ç”±è¯·æ±‚ | è¯·æ±‚å¯¹è±¡ | å¤„ç†æ–¹æ³•è°ƒç”¨ | TypeBasedDispatcher | <0.1ms | è‡ªåŠ¨åˆ†æ‹£æœº | ç±»å‹è¯†åˆ«ã€è·¯ç”±æ•ˆç‡ |
| **å¤„ç†** | æ‰§è¡Œå…·ä½“ä¸šåŠ¡é€»è¾‘ | åŸå§‹è¯·æ±‚ | Reqå¯¹è±¡ | handle_*_request() | 1-10ms | ä¸“é—¨å¤„ç†æµç¨‹ | å¤šæ¨¡æ€ã€ä¼šè¯ç®¡ç† |
| **æ’é˜Ÿ** | ç®¡ç†ç­‰å¾…æ‰§è¡Œçš„è¯·æ±‚ | Reqå¯¹è±¡ | é˜Ÿåˆ—ä¸­çš„è¯·æ±‚ | waiting_queue | <0.1ms | ç­‰å¾…é…é€åŒº | ä¼˜å…ˆçº§ã€å…¬å¹³æ€§ |

### 1.3 è¯·æ±‚ç”Ÿå‘½å‘¨æœŸè¯¦ç»†åˆ†æ

```
ç½‘ç»œè¯·æ±‚ â†’ æ¥æ”¶è§£æ â†’ ç±»å‹è¯†åˆ« â†’ ä¸šåŠ¡å¤„ç† â†’ é˜Ÿåˆ—ç­‰å¾… â†’ æ‰¹æ¬¡æ‰§è¡Œ â†’ ç»“æœè¿”å›
   â†“          â†“         â†“         â†“         â†“         â†“         â†“
åŸå§‹æ•°æ®   ç»“æ„åŒ–å¯¹è±¡  è·¯ç”±åˆ†å‘   Reqåˆ›å»º   é˜Ÿåˆ—ç®¡ç†   GPUè®¡ç®—   ç”¨æˆ·å“åº”

è¯¦ç»†è¯´æ˜ï¼š
1. ç”¨æˆ·å‘é€HTTPè¯·æ±‚ï¼š"è¯·å¸®æˆ‘å†™ä¸€é¦–å…³äºæ˜¥å¤©çš„è¯—"
2. recv_requests()æ¥æ”¶ç½‘ç»œæ•°æ®ï¼Œè§£æä¸ºTokenizedGenerateReqInputå¯¹è±¡
3. TypeBasedDispatcherè¯†åˆ«è¿™æ˜¯æ–‡æœ¬ç”Ÿæˆè¯·æ±‚ï¼Œè·¯ç”±åˆ°handle_generate_request()
4. handle_generate_request()åˆ›å»ºReqå¯¹è±¡ï¼Œè®¾ç½®é‡‡æ ·å‚æ•°ã€å¤šæ¨¡æ€è¾“å…¥ç­‰
5. Reqå¯¹è±¡è¢«æ·»åŠ åˆ°waiting_queueï¼Œç­‰å¾…è°ƒåº¦å™¨å¤„ç†
6. è°ƒåº¦å™¨å°†å¤šä¸ªReqç»„ç»‡æˆæ‰¹æ¬¡ï¼Œå‘é€åˆ°GPUæ‰§è¡Œ
7. GPUè®¡ç®—å®Œæˆåï¼Œç»“æœé€šè¿‡æµå¼è¾“å‡ºè¿”å›ç»™ç”¨æˆ·
```

### 1.4 æ ¸å¿ƒæ¦‚å¿µæ·±åº¦è§£æ

**1. éé˜»å¡æ¥æ”¶çš„é‡è¦æ€§**
- **ä¼ ç»Ÿé˜»å¡æ¨¡å¼çš„é—®é¢˜**ï¼šç³»ç»Ÿç­‰å¾…ç½‘ç»œæ•°æ®æ—¶ï¼ŒCPUå®Œå…¨ç©ºé—²ï¼Œæµªè´¹èµ„æº
- **éé˜»å¡æ¨¡å¼çš„ä¼˜åŠ¿**ï¼šç³»ç»Ÿå¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡ï¼Œæé«˜å¹¶å‘èƒ½åŠ›
- **å®ç°åŸç†**ï¼šä½¿ç”¨ZMQçš„NOBLOCKæ¨¡å¼ï¼Œæœ‰æ•°æ®å°±å¤„ç†ï¼Œæ²¡æ•°æ®å°±ç»§ç»­å…¶ä»–å·¥ä½œ
- **æ€§èƒ½æå‡**ï¼šä»å•çº¿ç¨‹é˜»å¡åˆ°å¤šä»»åŠ¡å¹¶å‘ï¼Œååé‡æå‡æ•°å€

**2. ç±»å‹åŒ–åˆ†å‘çš„æŠ€æœ¯ä¼˜åŠ¿**
- **ä¼ ç»Ÿæ¡ä»¶åˆ¤æ–­çš„é—®é¢˜**ï¼šå¤§é‡if-elseè¯­å¥ï¼Œç»´æŠ¤å›°éš¾ï¼Œæ€§èƒ½éšç±»å‹æ•°é‡çº¿æ€§ä¸‹é™
- **ç±»å‹åŒ–åˆ†å‘çš„ä¼˜åŠ¿**ï¼šO(1)å¤æ‚åº¦ï¼Œç±»å‹å®‰å…¨ï¼Œæ˜“äºæ‰©å±•
- **Pythonç±»å‹ç³»ç»Ÿçš„åˆ©ç”¨**ï¼šisinstance()æ¯”å­—ç¬¦ä¸²æ¯”è¾ƒæ›´å¿«æ›´å®‰å…¨
- **æ‰©å±•æ€§**ï¼šæ·»åŠ æ–°ç±»å‹åªéœ€è¦åœ¨æ˜ å°„è¡¨ä¸­åŠ ä¸€è¡Œï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒé€»è¾‘

**3. å¤šæ¨¡æ€ç»Ÿä¸€å¤„ç†çš„å¤æ‚æ€§**
- **æ•°æ®æ ¼å¼å·®å¼‚**ï¼šæ–‡æœ¬æ˜¯1Dåºåˆ—ï¼Œå›¾åƒæ˜¯3Då¼ é‡ï¼ŒéŸ³é¢‘æ˜¯æ—¶é—´åºåˆ—
- **TokenåŒ–ç­–ç•¥**ï¼šæ¯ç§æ¨¡æ€éœ€è¦ç‰¹æ®Šçš„token IDå’Œè¾¹ç•Œæ ‡è®°
- **å†…å­˜ç®¡ç†**ï¼šä¸åŒæ¨¡æ€çš„å†…å­˜éœ€æ±‚å·®å¼‚å·¨å¤§
- **æ¨¡å‹é€‚é…**ï¼šä¸åŒæ¨¡å‹å¯¹å¤šæ¨¡æ€è¾“å…¥çš„æ ¼å¼è¦æ±‚ä¸åŒ

**4. åˆ†å¸ƒå¼åè°ƒçš„æŒ‘æˆ˜**
- **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿æ‰€æœ‰GPUèŠ‚ç‚¹è·å¾—ç›¸åŒçš„è¯·æ±‚æ•°æ®
- **è´Ÿè½½å‡è¡¡**ï¼šåˆç†åˆ†é…è¯·æ±‚åˆ°ä¸åŒèŠ‚ç‚¹ï¼Œé¿å…çƒ­ç‚¹
- **æ•…éšœå¤„ç†**ï¼šæŸä¸ªèŠ‚ç‚¹æ•…éšœæ—¶ï¼Œå¦‚ä½•é‡æ–°åˆ†é…è¯·æ±‚
- **ç½‘ç»œä¼˜åŒ–**ï¼šå‡å°‘èŠ‚ç‚¹é—´çš„é€šä¿¡å¼€é”€

### 1.5 å¸¸è§è¯·æ±‚ç±»å‹è¯¦ç»†è¯´æ˜

| è¯·æ±‚ç±»å‹ | ç”¨é€” | è¾“å…¥ç¤ºä¾‹ | è¾“å‡ºç¤ºä¾‹ | å¤„ç†ç‰¹ç‚¹ | æ€§èƒ½è€ƒé‡ |
|----------|------|----------|----------|----------|----------|
| **æ–‡æœ¬ç”Ÿæˆ** | å¯¹è¯ã€å†™ä½œã€ç¿»è¯‘ | "è¯·ä»‹ç»ä¸€ä¸‹Python" | "Pythonæ˜¯ä¸€ç§ç¼–ç¨‹è¯­è¨€..." | éœ€è¦è§£ç ç”Ÿæˆï¼Œæ”¯æŒæµå¼è¾“å‡º | å†…å­˜éšç”Ÿæˆé•¿åº¦å¢é•¿ |
| **åµŒå…¥è®¡ç®—** | å‘é‡æ£€ç´¢ã€ç›¸ä¼¼åº¦ | "æœºå™¨å­¦ä¹ " | [0.1, -0.3, 0.8, ...] | åªéœ€å‰å‘ä¼ æ’­ï¼Œæ— éœ€è§£ç  | è®¡ç®—é‡å›ºå®šï¼Œé€‚åˆæ‰¹å¤„ç† |
| **å¤šæ¨¡æ€ç”Ÿæˆ** | å›¾æ–‡ç†è§£ã€è§†é¢‘åˆ†æ | å›¾ç‰‡ + "æè¿°è¿™ä¸ªå›¾ç‰‡" | "è¿™æ˜¯ä¸€åªå¯çˆ±çš„å°çŒ«..." | éœ€è¦ç‰¹æ®Šçš„tokenåŒ–å¤„ç† | å†…å­˜éœ€æ±‚å¤§ï¼Œå¤„ç†å¤æ‚ |
| **æ‰¹é‡å¤„ç†** | å¤§è§„æ¨¡æ¨ç† | 100ä¸ªé—®é¢˜çš„åˆ—è¡¨ | 100ä¸ªç­”æ¡ˆçš„åˆ—è¡¨ | ç½‘ç»œä¼ è¾“ä¼˜åŒ– | ååé‡é«˜ï¼Œå»¶è¿Ÿå¯èƒ½å¢åŠ  |
| **ä¼šè¯ç®¡ç†** | è¿ç»­å¯¹è¯ | ä¼šè¯ID + å¯¹è¯å†…å®¹ | å¸¦ä¸Šä¸‹æ–‡çš„å›å¤ | éœ€è¦çŠ¶æ€ä¿æŒ | å†…å­˜æŒç»­å ç”¨ |

### 1.6 å­¦ä¹ è·¯å¾„è¯¦ç»†æŒ‡å—

**ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æµç¨‹ç†è§£ï¼ˆå»ºè®®å­¦ä¹ æ—¶é—´ï¼š2-3å¤©ï¼‰**

1. **ç†è§£è¯·æ±‚çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ**
   - ä»ç”¨æˆ·ç‚¹å‡»å‘é€åˆ°æ”¶åˆ°å›å¤çš„å®Œæ•´è¿‡ç¨‹
   - æ¯ä¸ªé˜¶æ®µçš„ä½œç”¨å’Œé‡è¦æ€§
   - è§‚å¯Ÿä¸€ä¸ªç®€å•è¯·æ±‚çš„å¤„ç†è¿‡ç¨‹

2. **æŒæ¡éé˜»å¡æ¥æ”¶çš„åŸç†**
   - ç†è§£ä¸ºä»€ä¹ˆéœ€è¦éé˜»å¡å¤„ç†
   - å­¦ä¹ ZMQé€šä¿¡çš„åŸºæœ¬æ¦‚å¿µ
   - è§‚å¯Ÿç³»ç»Ÿå¦‚ä½•å¤„ç†å¹¶å‘è¯·æ±‚

**ç¬¬äºŒé˜¶æ®µï¼šåˆ†å‘æœºåˆ¶æ·±å…¥ï¼ˆå»ºè®®å­¦ä¹ æ—¶é—´ï¼š2-3å¤©ï¼‰**

3. **æŒæ¡TypeBasedDispatcherçš„å·¥ä½œåŸç†**
   - ç†è§£ç±»å‹åˆ°æ–¹æ³•çš„æ˜ å°„æœºåˆ¶
   - å­¦ä¹ å¦‚ä½•æ·»åŠ æ–°çš„è¯·æ±‚ç±»å‹
   - å¯¹æ¯”ä¼ ç»Ÿåˆ†å‘æ–¹å¼çš„ä¼˜åŠ£

4. **äº†è§£ä¸åŒè¯·æ±‚ç±»å‹çš„å¤„ç†å·®å¼‚**
   - æ–‡æœ¬ç”Ÿæˆ vs åµŒå…¥è®¡ç®—çš„åŒºåˆ«
   - å•ä¸ªè¯·æ±‚ vs æ‰¹é‡è¯·æ±‚çš„å·®å¼‚
   - ç³»ç»Ÿç®¡ç†è¯·æ±‚çš„ç‰¹æ®Šæ€§

**ç¬¬ä¸‰é˜¶æ®µï¼šé«˜çº§åŠŸèƒ½ç†è§£ï¼ˆå»ºè®®å­¦ä¹ æ—¶é—´ï¼š3-4å¤©ï¼‰**

5. **æ·±å…¥handle_generate_requestçš„å®ç°**
   - ç†è§£Reqå¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹
   - å­¦ä¹ å¤šæ¨¡æ€è¾“å…¥çš„å¤„ç†æµç¨‹
   - æŒæ¡ä¼šè¯ç®¡ç†å’Œè¯­æ³•çº¦æŸ

6. **æŒæ¡ç³»ç»Ÿæ§åˆ¶æœºåˆ¶**
   - ç†è§£æµé‡æ§åˆ¶çš„å·¥ä½œåŸç†
   - å­¦ä¹ ç¼“å­˜ç®¡ç†å’Œæ€§èƒ½ç›‘æ§
   - äº†è§£åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„åè°ƒ

### 1.7 å®è·µå­¦ä¹ å»ºè®®

**åŠ¨æ‰‹å®éªŒ**ï¼š
1. **å‘é€ç®€å•è¯·æ±‚**ï¼šä½¿ç”¨SGLangå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªæ–‡æœ¬ç”Ÿæˆè¯·æ±‚ï¼Œè§‚å¯Ÿå¤„ç†è¿‡ç¨‹
2. **æ·»åŠ æ—¥å¿—è¾“å‡º**ï¼šåœ¨å…³é”®æ–¹æ³•ä¸­æ·»åŠ printè¯­å¥ï¼Œè·Ÿè¸ªè¯·æ±‚å¤„ç†æµç¨‹
3. **æµ‹è¯•ä¸åŒç±»å‹**ï¼šå°è¯•å‘é€åµŒå…¥è¯·æ±‚ã€æ‰¹é‡è¯·æ±‚ï¼Œè§‚å¯Ÿå¤„ç†å·®å¼‚
4. **æ¨¡æ‹Ÿé«˜å¹¶å‘**ï¼šåŒæ—¶å‘é€å¤šä¸ªè¯·æ±‚ï¼Œè§‚å¯Ÿç³»ç»Ÿçš„å¹¶å‘å¤„ç†èƒ½åŠ›

**ä»£ç é˜…è¯»æŠ€å·§**ï¼š
1. **ä»å…¥å£å¼€å§‹**ï¼šå…ˆçœ‹recv_requests()æ–¹æ³•ï¼Œç†è§£è¯·æ±‚æ˜¯å¦‚ä½•è¿›å…¥ç³»ç»Ÿçš„
2. **è·Ÿè¸ªè°ƒç”¨é“¾**ï¼šä½¿ç”¨IDEçš„"è·³è½¬åˆ°å®šä¹‰"åŠŸèƒ½ï¼Œè·Ÿè¸ªæ–¹æ³•è°ƒç”¨å…³ç³»
3. **å…³æ³¨é”™è¯¯å¤„ç†**ï¼šçœ‹çœ‹ç³»ç»Ÿå¦‚ä½•å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ
4. **ç†è§£è®¾è®¡æ„å›¾**ï¼šæ€è€ƒä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ï¼Œè§£å†³äº†ä»€ä¹ˆé—®é¢˜

**å¸¸è§å­¦ä¹ éš¾ç‚¹è§£ç­”**ï¼š

**Q: ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¹ˆå¤šä¸åŒçš„è¯·æ±‚ç±»å‹ï¼Ÿ**
A: ä¸åŒçš„AIåº”ç”¨åœºæ™¯æœ‰ä¸åŒçš„éœ€æ±‚ã€‚å¯¹è¯éœ€è¦ç”Ÿæˆæ–‡æœ¬ï¼Œæœç´¢éœ€è¦è®¡ç®—å‘é‡ï¼Œå›¾ç‰‡ç†è§£éœ€è¦å¤šæ¨¡æ€å¤„ç†ã€‚æ¯ç§ç±»å‹éƒ½æœ‰ç‰¹å®šçš„ä¼˜åŒ–ç­–ç•¥ã€‚

**Q: TypeBasedDispatcheræ¯”if-elseæœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ**
A: ä¸»è¦æœ‰ä¸‰ä¸ªä¼˜åŠ¿ï¼š1) æ€§èƒ½æ›´å¥½ï¼ˆO(1) vs O(n)ï¼‰ï¼›2) ç±»å‹å®‰å…¨ï¼ˆç¼–è¯‘æ—¶æ£€æŸ¥ï¼‰ï¼›3) æ˜“äºæ‰©å±•ï¼ˆåªéœ€æ·»åŠ æ˜ å°„ï¼Œä¸ä¿®æ”¹æ ¸å¿ƒé€»è¾‘ï¼‰ã€‚

**Q: ä¸ºä»€ä¹ˆè¦ä½¿ç”¨éé˜»å¡æ¥æ”¶ï¼Ÿ**
A: é˜»å¡æ¥æ”¶ä¼šè®©ç³»ç»Ÿåœ¨ç­‰å¾…ç½‘ç»œæ•°æ®æ—¶å®Œå…¨åœæ­¢å·¥ä½œï¼Œæµªè´¹CPUèµ„æºã€‚éé˜»å¡æ¥æ”¶è®©ç³»ç»Ÿå¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡ï¼Œå¤§å¤§æé«˜å¹¶å‘èƒ½åŠ›ã€‚

**Q: åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„åè°ƒä¸ºä»€ä¹ˆè¿™ä¹ˆå¤æ‚ï¼Ÿ**
A: å› ä¸ºéœ€è¦ç¡®ä¿æ‰€æœ‰GPUèŠ‚ç‚¹è·å¾—ä¸€è‡´çš„æ•°æ®ï¼ŒåŒæ—¶è¿˜è¦ä¼˜åŒ–ç½‘ç»œé€šä¿¡æ•ˆç‡ã€‚è¿™æ¶‰åŠåˆ°åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€è‡´æ€§ã€å®¹é”™æ€§ã€æ€§èƒ½ç­‰å¤šä¸ªæŒ‘æˆ˜ã€‚

---

## 2. è¯·æ±‚å¤„ç†æ¶æ„æ€»è§ˆ

SGLangçš„è¯·æ±‚å¤„ç†æ¶æ„æ˜¯ä¸€ä¸ªé«˜åº¦æ¨¡å—åŒ–å’Œå¯æ‰©å±•çš„ç³»ç»Ÿï¼Œå®ƒé€šè¿‡åˆ†å±‚è®¾è®¡å®ç°äº†ä»ç½‘ç»œæ¥æ”¶åˆ°é˜Ÿåˆ—ç®¡ç†çš„å®Œæ•´è¯·æ±‚å¤„ç†æµç¨‹ã€‚è¿™ä¸ªæ¶æ„ä¸ä»…è¦å¤„ç†åŸºç¡€çš„æ–‡æœ¬ç”Ÿæˆå’ŒåµŒå…¥è®¡ç®—è¯·æ±‚ï¼Œè¿˜è¦æ”¯æŒå¤šæ¨¡æ€è¾“å…¥ã€è¯­æ³•çº¦æŸã€ä¼šè¯ç®¡ç†ã€æƒé‡æ›´æ–°ç­‰å¤æ‚åŠŸèƒ½ã€‚

**æ¶æ„è®¾è®¡çš„æ ¸å¿ƒåŸåˆ™**ï¼š
- **åˆ†å±‚å¤„ç†**ï¼šé€šè¿‡æ¥æ”¶å±‚ã€åˆ†å‘å±‚ã€å¤„ç†å±‚ã€é˜Ÿåˆ—å±‚çš„æ¸…æ™°åˆ†å·¥ï¼Œå®ç°é«˜æ•ˆçš„è¯·æ±‚å¤„ç†
- **ç±»å‹åŒ–è·¯ç”±**ï¼šåŸºäºPythonç±»å‹ç³»ç»Ÿçš„è‡ªåŠ¨è¯·æ±‚åˆ†å‘ï¼Œæ”¯æŒ20+ç§ä¸åŒç±»å‹çš„è¯·æ±‚
- **å¼‚æ­¥éé˜»å¡**ï¼šå…¨ç¨‹é‡‡ç”¨éé˜»å¡çš„ZMQé€šä¿¡ï¼Œç¡®ä¿ç³»ç»Ÿçš„é«˜å¹¶å‘å¤„ç†èƒ½åŠ›
- **åˆ†å¸ƒå¼åè°ƒ**ï¼šåŸç”Ÿæ”¯æŒTPã€PPã€DPç­‰å¤šç§å¹¶è¡Œæ¨¡å¼çš„è¯·æ±‚åè°ƒ

**æµç¨‹ä¼˜åŒ–ç­–ç•¥**ï¼š
- **æ™ºèƒ½è·³è¿‡æœºåˆ¶**ï¼šrecv_skipperæ ¹æ®ç³»ç»ŸçŠ¶æ€åŠ¨æ€å†³å®šæ˜¯å¦æ¥æ”¶æ–°è¯·æ±‚
- **æµé‡æ§åˆ¶é›†æˆ**ï¼šSchedulerInputBlockeræä¾›ç²¾ç»†çš„æµé‡ç®¡ç†å’ŒèƒŒå‹æœºåˆ¶
- **é˜Ÿåˆ—åˆ†ç¦»è®¾è®¡**ï¼šæ™®é€šè¯·æ±‚ã€è¯­æ³•çº¦æŸè¯·æ±‚ã€ä¼šè¯è¯·æ±‚é‡‡ç”¨ä¸åŒçš„é˜Ÿåˆ—ç®¡ç†ç­–ç•¥

### 2.1 è¯·æ±‚å¤„ç†æµç¨‹å¯è§†åŒ–

```mermaid
graph TD
    subgraph "ğŸŒ è¯·æ±‚æ¥æº"
        direction LR
        A1["ğŸ”— Tokenizer<br/>ZMQç®¡é“"]
        A2["ğŸ”Œ RPCæ¥å£<br/>ZMQç®¡é“"]
    end

    subgraph "ğŸ“¥ è¯·æ±‚æ¥æ”¶å±‚"
        direction TB
        B1["recv_requests()<br/>éé˜»å¡æ¥æ”¶"]
        B2["SchedulerInputBlocker<br/>æµé‡æ§åˆ¶"]
        B3["process_input_requests()<br/>é¢„å¤„ç†å’Œè¿‡æ»¤"]
    end

    subgraph "ğŸ¯ è¯·æ±‚åˆ†å‘å±‚"
        direction TB
        C1["TypeBasedDispatcher<br/>ç±»å‹è·¯ç”±"]
        C2{"è¯·æ±‚ç±»å‹åˆ¤æ–­"}
        C3["20+ç§å¤„ç†æ–¹æ³•<br/>è‡ªåŠ¨åˆ†å‘"]
    end

    subgraph "ğŸ”„ è¯·æ±‚å¤„ç†å±‚"
        direction LR
        D1["handle_generate_request<br/>ç”Ÿæˆè¯·æ±‚"]
        D2["handle_embedding_request<br/>åµŒå…¥è¯·æ±‚"]
        D3["handle_batch_*_request<br/>æ‰¹é‡è¯·æ±‚"]
        D4["å…¶ä»–æ§åˆ¶è¯·æ±‚<br/>ç³»ç»Ÿç®¡ç†"]
    end

    subgraph "ğŸ“‹ é˜Ÿåˆ—ç®¡ç†å±‚"
        direction TB
        E1["waiting_queue<br/>ç­‰å¾…é˜Ÿåˆ—"]
        E2["grammar_queue<br/>è¯­æ³•é˜Ÿåˆ—"]
        E3["sessions<br/>ä¼šè¯ç®¡ç†"]
    end

    A1 --> B1
    A2 --> B1
    B1 --> B2
    B2 --> B3
    B3 --> C1
    C1 --> C2
    C2 --> C3
    C3 --> D1
    C3 --> D2
    C3 --> D3
    C3 --> D4
    D1 --> E1
    D1 --> E2
    D2 --> E1
    D3 --> E1
    D4 --> E3

    style A1 fill:#e3f2fd,color:#000000,stroke:#333
    style A2 fill:#e3f2fd,color:#000000,stroke:#333
    style B1 fill:#f1f8e9,color:#000000,stroke:#333
    style B2 fill:#f1f8e9,color:#000000,stroke:#333
    style B3 fill:#f1f8e9,color:#000000,stroke:#333
    style C1 fill:#fff3e0,color:#000000,stroke:#333
    style C2 fill:#fff3e0,color:#000000,stroke:#333
    style C3 fill:#fff3e0,color:#000000,stroke:#333
    style D1 fill:#ffebee,color:#000000,stroke:#333
    style D2 fill:#ffebee,color:#000000,stroke:#333
    style D3 fill:#ffebee,color:#000000,stroke:#333
    style D4 fill:#ffebee,color:#000000,stroke:#333
    style E1 fill:#f3e5f5,color:#000000,stroke:#333
    style E2 fill:#f3e5f5,color:#000000,stroke:#333
    style E3 fill:#f3e5f5,color:#000000,stroke:#333
```

**å›¾ç¤ºè¯´æ˜**ï¼šè“è‰²è¡¨ç¤ºè¯·æ±‚æ¥æºï¼Œç»¿è‰²è¡¨ç¤ºæ¥æ”¶å±‚ï¼Œæ©™è‰²è¡¨ç¤ºåˆ†å‘å±‚ï¼Œçº¢è‰²è¡¨ç¤ºå¤„ç†å±‚ï¼Œç´«è‰²è¡¨ç¤ºé˜Ÿåˆ—ç®¡ç†ã€‚æ•´ä¸ªæµç¨‹ä½“ç°äº†SGLangè¯·æ±‚å¤„ç†çš„å±‚æ¬¡åŒ–å’Œæ¨¡å—åŒ–è®¾è®¡ã€‚

---

## 3. è¯·æ±‚æ¥æ”¶æµç¨‹

### 3.1 recv_requestsæ–¹æ³•

recv_requests()æ–¹æ³•æ˜¯SGLangè°ƒåº¦å™¨ç½‘ç»œè¯·æ±‚æ¥æ”¶çš„æ ¸å¿ƒæœºåˆ¶ï¼Œå®ƒéœ€è¦åœ¨å¤æ‚çš„åˆ†å¸ƒå¼ç¯å¢ƒä¸­åè°ƒå¤šç§å¹¶è¡Œç­–ç•¥ã€‚è¯¥æ–¹æ³•ä¸ä»…è¦å¤„ç†æ¥è‡ªtokenizerå’ŒRPCæ¥å£çš„è¯·æ±‚ï¼Œè¿˜è¦è€ƒè™‘å¼ é‡å¹¶è¡Œ(TP)ã€æµæ°´çº¿å¹¶è¡Œ(PP)ã€æ•°æ®å¹¶è¡Œ(DP)ç­‰å¤šç§å¹¶è¡Œæ¨¡å¼çš„åè°ƒã€‚

**åˆ†å¸ƒå¼æ¥æ”¶çš„æ ¸å¿ƒæŒ‘æˆ˜**ï¼š
- **å¹¶è¡Œæ¨¡å¼åè°ƒ**ï¼šåœ¨TPã€PPã€DPæ··åˆçš„ç¯å¢ƒä¸­ï¼Œåªæœ‰ç‰¹å®šçš„rankè´Ÿè´£å®é™…æ¥æ”¶ï¼Œå…¶ä»–ranké€šè¿‡é€šä¿¡è·å–è¯·æ±‚
- **éé˜»å¡é€šä¿¡**ï¼šä½¿ç”¨ZMQçš„éé˜»å¡æ¨¡å¼ï¼Œé¿å…è°ƒåº¦å™¨çº¿ç¨‹è¢«ç½‘ç»œIOé˜»å¡
- **æµé‡æ§åˆ¶é›†æˆ**ï¼šä¸SchedulerInputBlockerç´§å¯†é›†æˆï¼Œå®ç°ç³»ç»Ÿçº§çš„æµé‡æ§åˆ¶
- **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿æ‰€æœ‰å¹¶è¡Œworkerè·å¾—ä¸€è‡´çš„è¯·æ±‚æ•°æ®

**æ¥æ”¶ç­–ç•¥ä¼˜åŒ–**ï¼š
- **PP rankåˆ†å·¥**ï¼šåªæœ‰ç¬¬ä¸€ä¸ªPP rank(pp_rank==0)è´Ÿè´£ç½‘ç»œæ¥æ”¶ï¼Œå…¶ä»–ranké€šè¿‡ç‚¹å¯¹ç‚¹é€šä¿¡è·å–
- **TP rankåˆ†å·¥**ï¼šåœ¨æ¯ä¸ªPP stageä¸­ï¼Œåªæœ‰attn_tp_rank==0çš„è¿›ç¨‹è¿›è¡Œå®é™…æ¥æ”¶
- **DPå¹¿æ’­æœºåˆ¶**ï¼šå¯ç”¨DP attentionæ—¶ï¼Œé€šè¿‡é«˜æ•ˆçš„å¹¿æ’­æ“ä½œåŒæ­¥è¯·æ±‚åˆ°æ‰€æœ‰DP ranks

**æ¥æ”¶è·³è¿‡å™¨æœºåˆ¶**ï¼šrecv_skipperæ ¹æ®å‰å‘æ¨¡å¼åŠ¨æ€å†³å®šæ˜¯å¦è·³è¿‡æœ¬è½®æ¥æ”¶ï¼Œè¿™æ˜¯SGLangè°ƒåº¦å™¨ä¸æ¨¡å‹æ‰§è¡Œå™¨åè°ƒçš„å…³é”®æœºåˆ¶ï¼Œé¿å…äº†ä¸å¿…è¦çš„ç½‘ç»œå¼€é”€ã€‚

```python
def recv_requests(self) -> List[Req]:
    """æ¥æ”¶æ¥è‡ªtokenizerçš„è¯·æ±‚å®Œæ•´å®ç°"""
    
    # æ¥æ”¶è·³è¿‡å™¨ï¼šæ ¹æ®å‰å‘æ¨¡å¼å†³å®šæ˜¯å¦è·³è¿‡æ¥æ”¶
    if self.recv_skipper is not None:
        last_forward_mode = (
            self.last_batch.forward_mode if self.last_batch is not None else None
        )
        if not self.recv_skipper.handle(last_forward_mode):
            return []  # è·³è¿‡æœ¬è½®æ¥æ”¶ï¼Œé¿å…ä¸å¿…è¦çš„ç½‘ç»œå¼€é”€

    # æµæ°´çº¿å¹¶è¡Œï¼šåªæœ‰ç¬¬ä¸€ä¸ªPP rankè´Ÿè´£ç½‘ç»œæ¥æ”¶
    if self.pp_rank == 0:
        if self.attn_tp_rank == 0:  # æ³¨æ„åŠ›TPçš„ä¸»rank
            recv_reqs = []

            # ä»tokenizeræ¥æ”¶æ–‡æœ¬ç”Ÿæˆå’ŒåµŒå…¥è¯·æ±‚
            while True:
                try:
                    recv_req = self.recv_from_tokenizer.recv_pyobj(zmq.NOBLOCK)
                except zmq.ZMQError:
                    break  # æ— æ›´å¤šè¯·æ±‚æ—¶é€€å‡ºå¾ªç¯
                recv_reqs.append(recv_req)

            # ä»RPCæ¥å£æ¥æ”¶ç³»ç»Ÿç®¡ç†è¯·æ±‚
            while True:
                try:
                    recv_rpc = self.recv_from_rpc.recv_pyobj(zmq.NOBLOCK)
                except zmq.ZMQError:
                    break  # æ— æ›´å¤šRPCè¯·æ±‚æ—¶é€€å‡ºå¾ªç¯
                recv_reqs.append(recv_rpc)
        else:
            recv_reqs = None  # éä¸»rankç­‰å¾…åŒæ­¥
    else:
        # éç¬¬ä¸€ä¸ªPP ranké€šè¿‡ç‚¹å¯¹ç‚¹é€šä¿¡æ¥æ”¶
        if self.attn_tp_rank == 0:
            dp_offset = self.attn_dp_rank * self.attn_tp_size  # è®¡ç®—DPåç§»é‡
            # ä»å‰ä¸€ä¸ªPP rankæ¥æ”¶è¯·æ±‚æ•°æ®
            recv_reqs = point_to_point_pyobj(
                [],  # ç©ºçš„åˆå§‹æ•°æ®
                self.pp_rank * self.tp_size + dp_offset,      # å½“å‰rankåœ°å€
                self.world_group.device_group,                # é€šä¿¡è®¾å¤‡ç»„
                (self.pp_rank - 1) * self.tp_size + dp_offset, # æºrankåœ°å€
                self.pp_rank * self.tp_size + dp_offset,       # ç›®æ ‡rankåœ°å€
            )
        else:
            recv_reqs = None  # éä¸»rankç­‰å¾…åŒæ­¥

    # æµé‡æ§åˆ¶å¤„ç†ï¼šåº”ç”¨é˜»å¡ç­–ç•¥
    if self.input_blocker is not None:
        recv_reqs = self.input_blocker.handle(recv_reqs)

    # æ•°æ®å¹¶è¡Œæ³¨æ„åŠ›ï¼šå¹¿æ’­åˆ°æ‰€æœ‰DP ranks
    if self.server_args.enable_dp_attention:
        recv_reqs = broadcast_pyobj(
            recv_reqs,                           # è¦å¹¿æ’­çš„è¯·æ±‚æ•°æ®
            self.world_group.device_group,       # é€šä¿¡è®¾å¤‡ç»„
            self.attn_dp_rank * self.attn_tp_size, # å¹¿æ’­æºrank
        )
    
    return recv_reqs  # è¿”å›å¤„ç†åçš„è¯·æ±‚åˆ—è¡¨
```

### 3.2 process_input_requestsæ–¹æ³•

process_input_requests()æ–¹æ³•æ˜¯è¯·æ±‚é¢„å¤„ç†çš„æ ¸å¿ƒç¯èŠ‚ï¼Œå®ƒåœ¨è¯·æ±‚æ­£å¼è¿›å…¥è°ƒåº¦å™¨å¤„ç†æµç¨‹ä¹‹å‰ï¼Œæ‰§è¡Œä¸€ç³»åˆ—å…³é”®çš„è¿‡æ»¤ã€éªŒè¯å’Œåˆ†å‘æ“ä½œã€‚è¯¥æ–¹æ³•ä½“ç°äº†SGLangåœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯¹ç³»ç»Ÿç¨³å®šæ€§å’Œæ€§èƒ½çš„ç²¾å¿ƒè€ƒé‡ã€‚

**é¢„å¤„ç†çš„æ ¸å¿ƒåŠŸèƒ½**ï¼š
- **å¥åº·æ£€æŸ¥ä¼˜åŒ–**ï¼šæ™ºèƒ½å¤„ç†å¥åº·æ£€æŸ¥è¯·æ±‚ï¼Œé¿å…åœ¨ç³»ç»Ÿç¹å¿™æ—¶äº§ç”Ÿä¸å¿…è¦çš„å¼€é”€
- **é˜Ÿåˆ—å®¹é‡ä¿æŠ¤**ï¼šå®æ—¶ç›‘æ§é˜Ÿåˆ—å¤§å°ï¼Œé˜²æ­¢ç³»ç»Ÿè¿‡è½½å¹¶åŠæ—¶æ‹’ç»æ–°è¯·æ±‚
- **è¯·æ±‚åˆ†ç±»è·¯ç”±**ï¼šé€šè¿‡TypeBasedDispatcherå®ç°O(1)å¤æ‚åº¦çš„è¯·æ±‚ç±»å‹è¯†åˆ«å’Œè·¯ç”±
- **è¾“å‡ºç®¡é“é€‰æ‹©**ï¼šæ ¹æ®è¯·æ±‚ç±»å‹å’Œè¾“å‡ºç±»å‹é€‰æ‹©åˆé€‚çš„å‘é€ç®¡é“

**å¥åº·æ£€æŸ¥ç­–ç•¥**ï¼šSGLangé‡‡ç”¨äº†æ™ºèƒ½çš„å¥åº·æ£€æŸ¥å¤„ç†ç­–ç•¥ï¼Œå½“ç³»ç»Ÿå¤„äºç¹å¿™çŠ¶æ€ï¼ˆæœ‰åˆ†å—è¯·æ±‚ã€è¿è¡Œæ‰¹æ¬¡æˆ–ç¦»è½½æ ‡ç­¾ï¼‰æ—¶ï¼Œä¼šè·³è¿‡å¥åº·æ£€æŸ¥è¯·æ±‚çš„å¤„ç†ï¼Œé¿å…é¢å¤–çš„ç³»ç»Ÿå¼€é”€ã€‚è¿™ç§è®¾è®¡ç¡®ä¿äº†å¥åº·æ£€æŸ¥ä¸ä¼šå½±å“æ­£å¸¸ä¸šåŠ¡è¯·æ±‚çš„å¤„ç†æ€§èƒ½ã€‚

**é˜Ÿåˆ—ä¿æŠ¤æœºåˆ¶**ï¼šå½“ç­‰å¾…é˜Ÿåˆ—æ¥è¿‘æ»¡è½½æ—¶ï¼Œç³»ç»Ÿä¼šä¸»åŠ¨æ‹’ç»æ–°çš„å·¥ä½œè¯·æ±‚ï¼Œå¹¶å‘é€æ ‡å‡†åŒ–çš„HTTP 503é”™è¯¯å“åº”ã€‚è¿™ç§èƒŒå‹æœºåˆ¶æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿç¨³å®šæ€§çš„é‡è¦ä¿éšœï¼Œé˜²æ­¢ç³»ç»Ÿå› è¿‡è½½è€Œå´©æºƒã€‚

**åˆ†å‘å™¨é›†æˆ**ï¼šprocess_input_requests()ä¸TypeBasedDispatcherç´§å¯†é›†æˆï¼Œå®ç°äº†è¯·æ±‚ç±»å‹åˆ°å¤„ç†æ–¹æ³•çš„è‡ªåŠ¨æ˜ å°„ã€‚è¿™ç§è®¾è®¡ä¸ä»…æé«˜äº†å¤„ç†æ•ˆç‡ï¼Œè¿˜ä¸ºç³»ç»Ÿæ‰©å±•æ–°çš„è¯·æ±‚ç±»å‹æä¾›äº†çµæ´»çš„æ¡†æ¶ã€‚

```python
def process_input_requests(self, recv_reqs: List):
    """å¤„ç†è¾“å…¥è¯·æ±‚åˆ—è¡¨å®Œæ•´å®ç°"""
    for recv_req in recv_reqs:
        # å¥åº·æ£€æŸ¥è¯·æ±‚çš„ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæœ‰æ­£åœ¨è¿è¡Œçš„è¯·æ±‚æˆ–åˆ†å—è¯·æ±‚ï¼Œåˆ™å¿½ç•¥å¥åº·æ£€æŸ¥
        if is_health_check_generate_req(recv_req) and (
            self.chunked_req is not None           # æœ‰åˆ†å—è¯·æ±‚æ­£åœ¨å¤„ç†
            or not self.running_batch.is_empty()   # æœ‰æ‰¹æ¬¡æ­£åœ¨è¿è¡Œ
            or len(self.offload_tags) > 0          # æœ‰ç¦»è½½æ ‡ç­¾
        ):
            self.return_health_check_ct += 1
            continue

        # å·¥ä½œè¯·æ±‚çš„é˜Ÿåˆ—å¤§å°æ£€æŸ¥ï¼šé˜²æ­¢é˜Ÿåˆ—è¿‡è½½
        if is_work_request(recv_req):
            if len(self.waiting_queue) + 1 > self.max_queued_requests:
                # é˜Ÿåˆ—å·²æ»¡ï¼Œå‘é€ä¸­æ­¢è¯·æ±‚
                abort_req = AbortReq(
                    recv_req.rid,
                    finished_reason={
                        "type": "abort",
                        "status_code": HTTPStatus.SERVICE_UNAVAILABLE,
                        "message": "The request queue is full.",
                    },
                )
                self.send_to_tokenizer.send_pyobj(abort_req)
                continue
        
        # ä½¿ç”¨ç±»å‹åˆ†å‘å™¨å¤„ç†è¯·æ±‚ï¼šè‡ªåŠ¨è·¯ç”±åˆ°å¯¹åº”çš„å¤„ç†æ–¹æ³•
        output = self._request_dispatcher(recv_req)
        if output is not None:
            # æ ¹æ®è¾“å‡ºç±»å‹é€‰æ‹©å‘é€ç›®æ ‡
            if isinstance(output, RpcReqOutput):
                # RPCè¾“å‡ºå‘é€åˆ°RPCç®¡é“
                if self.recv_from_rpc is not None:
                    self.recv_from_rpc.send_pyobj(output)
            else:
                # å…¶ä»–è¾“å‡ºå‘é€åˆ°tokenizer
                self.send_to_tokenizer.send_pyobj(output)
```

---

## 4. è¯·æ±‚åˆ†å‘æœºåˆ¶

### 4.1 åˆå­¦è€…è§†è§’ï¼šä»€ä¹ˆæ˜¯è¯·æ±‚åˆ†å‘ï¼Ÿ

**ç®€å•ç†è§£**ï¼šè¯·æ±‚åˆ†å‘å°±åƒæ˜¯å¿«é€’åˆ†æ‹£ä¸­å¿ƒçš„è‡ªåŠ¨åˆ†æ‹£æœºï¼Œæ ¹æ®åŒ…è£¹ä¸Šçš„æ ‡ç­¾ï¼ˆè¯·æ±‚ç±»å‹ï¼‰è‡ªåŠ¨å°†åŒ…è£¹é€åˆ°å¯¹åº”çš„å¤„ç†çº¿ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦åˆ†å‘ï¼Ÿ**
- **ä¸åŒç±»å‹ä¸åŒå¤„ç†**ï¼šæ–‡æœ¬ç”Ÿæˆå’ŒåµŒå…¥è®¡ç®—éœ€è¦ä¸åŒçš„å¤„ç†æ–¹å¼
- **è‡ªåŠ¨åŒ–è·¯ç”±**ï¼šç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«è¯·æ±‚ç±»å‹ï¼Œæ— éœ€äººå·¥åˆ¤æ–­
- **é«˜æ•ˆå¤„ç†**ï¼šé¿å…å¤æ‚çš„if-elseåˆ¤æ–­ï¼Œå®ç°O(1)å¤æ‚åº¦çš„è·¯ç”±

### 4.2 SGLangæ”¯æŒçš„è¯·æ±‚ç±»å‹ï¼ˆç®€åŒ–ç‰ˆï¼‰

| ç±»å‹ | ç”¨é€” | å¤„ç†æ–¹æ³• | å¸¸è§åœºæ™¯ |
|------|------|----------|----------|
| **æ–‡æœ¬ç”Ÿæˆ** | ç”Ÿæˆæ–‡æœ¬å†…å®¹ | handle_generate_request | å¯¹è¯ã€å†™ä½œã€ç¿»è¯‘ |
| **åµŒå…¥è®¡ç®—** | è®¡ç®—æ–‡æœ¬å‘é‡ | handle_embedding_request | æœç´¢ã€æ¨èã€åˆ†ç±» |
| **æ‰¹é‡ç”Ÿæˆ** | ä¸€æ¬¡å¤„ç†å¤šä¸ªç”Ÿæˆè¯·æ±‚ | handle_batch_generate_request | å¤§è§„æ¨¡æ¨ç† |
| **æ‰¹é‡åµŒå…¥** | ä¸€æ¬¡å¤„ç†å¤šä¸ªåµŒå…¥è¯·æ±‚ | handle_batch_embedding_request | æ‰¹é‡å‘é‡åŒ– |
| **ä¼šè¯ç®¡ç†** | æ‰“å¼€/å…³é—­å¯¹è¯ä¼šè¯ | open_session/close_session | è¿ç»­å¯¹è¯ |
| **ç¼“å­˜ç®¡ç†** | æ¸…ç†ç³»ç»Ÿç¼“å­˜ | flush_cache_wrapped | ç³»ç»Ÿç»´æŠ¤ |

### 4.3 TypeBasedDispatcherå·¥ä½œåŸç†ï¼ˆç®€åŒ–ç‰ˆï¼‰

```python
# ç®€åŒ–ç†è§£ç‰ˆæœ¬
class SimpleDispatcher:
    def route_request(self, request):
        if requestæ˜¯æ–‡æœ¬ç”Ÿæˆç±»å‹:
            return è°ƒç”¨æ–‡æœ¬ç”Ÿæˆå¤„ç†å™¨
        elif requestæ˜¯åµŒå…¥è®¡ç®—ç±»å‹:
            return è°ƒç”¨åµŒå…¥è®¡ç®—å¤„ç†å™¨
        elif requestæ˜¯æ‰¹é‡è¯·æ±‚ç±»å‹:
            return è°ƒç”¨æ‰¹é‡å¤„ç†å™¨
        # ... å…¶ä»–ç±»å‹
```

å®é™…çš„TypeBasedDispatcheræ›´æ™ºèƒ½ï¼Œå®ƒä½¿ç”¨Pythonçš„ç±»å‹ç³»ç»Ÿæ¥è‡ªåŠ¨åŒ¹é…ï¼Œé¿å…äº†å¤æ‚çš„æ¡ä»¶åˆ¤æ–­ã€‚

SGLangçš„è¯·æ±‚åˆ†å‘æœºåˆ¶æ˜¯æ•´ä¸ªè¯·æ±‚å¤„ç†ç³»ç»Ÿçš„æ ¸å¿ƒæ¢çº½ï¼Œå®ƒè´Ÿè´£å°†æ¥æ”¶åˆ°çš„å„ç§ç±»å‹è¯·æ±‚å‡†ç¡®åœ°è·¯ç”±åˆ°å¯¹åº”çš„å¤„ç†æ–¹æ³•ã€‚è¿™ä¸ªæœºåˆ¶ä¸ä»…è¦ä¿è¯é«˜æ€§èƒ½çš„è·¯ç”±æ•ˆç‡ï¼Œè¿˜è¦æä¾›è‰¯å¥½çš„æ‰©å±•æ€§å’Œç±»å‹å®‰å…¨æ€§ã€‚

**åˆ†å‘æœºåˆ¶çš„æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- **ç±»å‹é©±åŠ¨è·¯ç”±**ï¼šåŸºäºPythonç±»å‹ç³»ç»Ÿå®ç°O(1)å¤æ‚åº¦çš„è¯·æ±‚åˆ†å‘
- **å®Œæ•´åŠŸèƒ½è¦†ç›–**ï¼šæ”¯æŒ20+ç§ä¸åŒç±»å‹çš„è¯·æ±‚ï¼Œæ¶µç›–æ¨ç†ã€ç®¡ç†ã€æ§åˆ¶ç­‰å„ä¸ªæ–¹é¢
- **æ‰©å±•æ€§æ¡†æ¶**ï¼šæ–°å¢è¯·æ±‚ç±»å‹åªéœ€ç®€å•çš„é…ç½®ä¿®æ”¹ï¼Œæ— éœ€æ”¹åŠ¨æ ¸å¿ƒé€»è¾‘
- **é”™è¯¯å¤„ç†å®Œå¤‡**ï¼šå®Œæ•´çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œç¡®ä¿æœªçŸ¥è¯·æ±‚ç±»å‹çš„å®‰å…¨å¤„ç†

**åˆ†å‘å™¨è®¾è®¡çš„æŠ€æœ¯ç‰¹ç‚¹**ï¼š
- **æ˜ å°„è¡¨é©±åŠ¨**ï¼šé€šè¿‡ç±»å‹åˆ°å¤„ç†å‡½æ•°çš„æ˜ å°„è¡¨ï¼Œå®ç°äº†å£°æ˜å¼çš„è¯·æ±‚é…ç½®
- **è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥**ï¼šåˆ©ç”¨isinstance()è¿›è¡Œç²¾ç¡®çš„ç±»å‹åŒ¹é…ï¼Œé¿å…äº†ä¼ ç»Ÿçš„æ¡ä»¶åˆ¤æ–­å¼€é”€
- **å‡½æ•°å¼è®¾è®¡**ï¼šåˆ†å‘å™¨æœ¬èº«æ˜¯ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ï¼Œæä¾›äº†ç®€æ´çš„ä½¿ç”¨æ¥å£

### 4.4 TypeBasedDispatcheræ ¸å¿ƒè®¾è®¡

TypeBasedDispatcheræ˜¯SGLangè¯·æ±‚åˆ†å‘ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼Œå®ƒå®ç°äº†åŸºäºPythonç±»å‹ç³»ç»Ÿçš„é«˜æ•ˆè¯·æ±‚è·¯ç”±æœºåˆ¶ã€‚è¿™ç§è®¾è®¡å……åˆ†åˆ©ç”¨äº†Pythonçš„åŠ¨æ€ç±»å‹ç‰¹æ€§ï¼Œå°†å¤æ‚çš„æ¡ä»¶åˆ¤æ–­è½¬æ¢ä¸ºO(1)å¤æ‚åº¦çš„ç±»å‹åŒ¹é…æ“ä½œã€‚

**ç±»å‹é©±åŠ¨è·¯ç”±çš„è®¾è®¡ä¼˜åŠ¿**ï¼š
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…äº†ä¼ ç»Ÿçš„if-elifé“¾å¼åˆ¤æ–­ï¼Œå®ç°O(1)å¤æ‚åº¦çš„è¯·æ±‚åˆ†å‘
- **ç±»å‹å®‰å…¨**ï¼šåŸºäºPythonç±»å‹ç³»ç»Ÿï¼Œåœ¨ç¼–è¯‘æ—¶å°±èƒ½å‘ç°ç±»å‹é”™è¯¯
- **æ‰©å±•æ€§**ï¼šæ·»åŠ æ–°è¯·æ±‚ç±»å‹åªéœ€åœ¨æ˜ å°„è¡¨ä¸­å¢åŠ ä¸€è¡Œé…ç½®
- **å¯ç»´æŠ¤æ€§**ï¼šè¯·æ±‚ç±»å‹ä¸å¤„ç†æ–¹æ³•çš„æ˜ å°„å…³ç³»æ¸…æ™°æ˜ç¡®

**æ˜ å°„æœºåˆ¶å®ç°**ï¼šTypeBasedDispatcherç»´æŠ¤ä¸€ä¸ªç±»å‹åˆ°å¤„ç†å‡½æ•°çš„æ˜ å°„åˆ—è¡¨ï¼Œé€šè¿‡isinstance()è¿›è¡Œç±»å‹åŒ¹é…ã€‚è¿™ç§è®¾è®¡æ—¢ä¿æŒäº†é«˜æ€§èƒ½ï¼Œåˆæä¾›äº†è‰¯å¥½çš„æ‰©å±•æ€§ã€‚

**é”™è¯¯å¤„ç†ç­–ç•¥**ï¼šå½“é‡åˆ°æœªçŸ¥è¯·æ±‚ç±»å‹æ—¶ï¼Œåˆ†å‘å™¨ä¼šæŠ›å‡ºValueErrorå¼‚å¸¸ï¼Œè¿™ç§fail-fastæœºåˆ¶ç¡®ä¿äº†ç³»ç»Ÿçš„å¥å£®æ€§ï¼Œé¿å…äº†æœªå¤„ç†è¯·æ±‚çš„é™é»˜å¤±è´¥ã€‚

```python
# TypeBasedDispatcherçš„å®Œæ•´å®ç°
class TypeBasedDispatcher:
    def __init__(self, mapping: List[Tuple[Type, Callable]]):
        self._mapping = mapping

    def __call__(self, obj: Any):
        for ty, fn in self._mapping:
            if isinstance(obj, ty):
                return fn(obj)
        raise ValueError(f"Invalid object: {obj}")
```

### 4.5 è¯·æ±‚åˆ†å‘å™¨é…ç½®

SGLangè°ƒåº¦å™¨æ”¯æŒ20+ç§ä¸åŒç±»å‹çš„è¯·æ±‚å¤„ç†ï¼Œæ¶µç›–äº†ä»åŸºç¡€æ¨ç†åˆ°é«˜çº§ç³»ç»Ÿç®¡ç†çš„å®Œæ•´åŠŸèƒ½èŒƒå›´ã€‚è¯·æ±‚åˆ†å‘å™¨çš„é…ç½®åæ˜ äº†SGLangä½œä¸ºç”Ÿäº§çº§æ¨ç†ç³»ç»Ÿçš„åŠŸèƒ½å®Œå¤‡æ€§ã€‚

**è¯·æ±‚ç±»å‹çš„å®Œæ•´åˆ†ç±»**ï¼š
- **åŸºç¡€æ¨ç†è¯·æ±‚**ï¼šæ–‡æœ¬ç”Ÿæˆã€åµŒå…¥è®¡ç®—ã€æ‰¹é‡å¤„ç†ç­‰æ ¸å¿ƒæ¨ç†åŠŸèƒ½
- **ä¼šè¯ç®¡ç†è¯·æ±‚**ï¼šä¼šè¯åˆ›å»ºã€å…³é—­ã€ä¸­æ­¢ç­‰ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **æƒé‡ç®¡ç†è¯·æ±‚**ï¼šæ¨¡å‹æƒé‡çš„åŠ¨æ€æ›´æ–°ã€åˆ†å¸ƒå¼åŒæ­¥ã€æŒ‰åç§°è·å–ç­‰
- **ç³»ç»Ÿæ§åˆ¶è¯·æ±‚**ï¼šç¼“å­˜ç®¡ç†ã€æ€§èƒ½åˆ†æã€æµé‡æ§åˆ¶ç­‰ç³»ç»Ÿçº§æ“ä½œ
- **é«˜çº§åŠŸèƒ½è¯·æ±‚**ï¼šLoRAé€‚é…å™¨ç®¡ç†ã€ä¸“å®¶åˆ†å¸ƒã€çŠ¶æ€ç®¡ç†ç­‰é«˜çº§ç‰¹æ€§

**é…ç½®è®¾è®¡åŸåˆ™**ï¼šåˆ†å‘å™¨é…ç½®é‡‡ç”¨äº†å£°æ˜å¼çš„è®¾è®¡ï¼Œæ¯ä¸ªè¯·æ±‚ç±»å‹ä¸å…¶å¤„ç†æ–¹æ³•å½¢æˆä¸€ä¸€å¯¹åº”å…³ç³»ã€‚è¿™ç§è®¾è®¡ä¸ä»…æé«˜äº†ä»£ç çš„å¯è¯»æ€§ï¼Œè¿˜ä¸ºç³»ç»Ÿçš„æ‰©å±•å’Œç»´æŠ¤æä¾›äº†ä¾¿åˆ©ã€‚

```python
# è°ƒåº¦å™¨è¯·æ±‚åˆ†å‘å™¨å®Œæ•´é…ç½®
self._request_dispatcher = TypeBasedDispatcher([
    # åŸºç¡€æ¨ç†è¯·æ±‚
    (TokenizedGenerateReqInput, self.handle_generate_request),
    (TokenizedEmbeddingReqInput, self.handle_embedding_request),
    (BatchTokenizedGenerateReqInput, self.handle_batch_generate_request),
    (BatchTokenizedEmbeddingReqInput, self.handle_batch_embedding_request),
    
    # ç¼“å­˜å’Œä¼šè¯ç®¡ç†
    (FlushCacheReqInput, self.flush_cache_wrapped),
    (AbortReq, self.abort_request),
    (OpenSessionReqInput, self.open_session),
    (CloseSessionReqInput, self.close_session),
    
    # æƒé‡æ›´æ–°å’Œæ¨¡å‹ç®¡ç†
    (UpdateWeightFromDiskReqInput, self.update_weights_from_disk),
    (InitWeightsUpdateGroupReqInput, self.init_weights_update_group),
    (UpdateWeightsFromDistributedReqInput, self.update_weights_from_distributed),
    (UpdateWeightsFromTensorReqInput, self.update_weights_from_tensor),
    (GetWeightsByNameReqInput, self.get_weights_by_name),
    
    # ç³»ç»Ÿæ§åˆ¶å’Œç›‘æ§
    (ReleaseMemoryOccupationReqInput, self.release_memory_occupation),
    (ResumeMemoryOccupationReqInput, self.resume_memory_occupation),
    (SlowDownReqInput, self.slow_down),
    (ProfileReq, self.profile),
    (FreezeGCReq, self.handle_freeze_gc),
    
    # çŠ¶æ€ç®¡ç†å’Œè°ƒè¯•
    (GetInternalStateReq, self.get_internal_state),
    (SetInternalStateReq, self.set_internal_state),
    (RpcReqInput, self.handle_rpc_request),
    
    # é«˜çº§åŠŸèƒ½
    (ExpertDistributionReq, self.expert_distribution_handle),
    (LoadLoRAAdapterReqInput, self.load_lora_adapter),
    (UnloadLoRAAdapterReqInput, self.unload_lora_adapter),
])
```

### 4.6 è¯·æ±‚ç±»å‹åˆ†ç±»

| ç±»åˆ« | è¯·æ±‚ç±»å‹ | å¤„ç†æ–¹æ³• | åŠŸèƒ½æè¿° |
|------|----------|----------|----------|
| **åŸºç¡€æ¨ç†** | TokenizedGenerateReqInput | handle_generate_request | æ–‡æœ¬ç”Ÿæˆè¯·æ±‚ |
| | TokenizedEmbeddingReqInput | handle_embedding_request | åµŒå…¥è®¡ç®—è¯·æ±‚ |
| | BatchTokenized*ReqInput | handle_batch_*_request | æ‰¹é‡è¯·æ±‚å¤„ç† |
| **ä¼šè¯ç®¡ç†** | OpenSessionReqInput | open_session | æ‰“å¼€æ–°ä¼šè¯ |
| | CloseSessionReqInput | close_session | å…³é—­ä¼šè¯ |
| | AbortReq | abort_request | ä¸­æ­¢è¯·æ±‚ |
| **æƒé‡ç®¡ç†** | UpdateWeightFromDiskReqInput | update_weights_from_disk | ä»ç£ç›˜æ›´æ–°æƒé‡ |
| | UpdateWeightsFromDistributedReqInput | update_weights_from_distributed | åˆ†å¸ƒå¼æƒé‡æ›´æ–° |
| | GetWeightsByNameReqInput | get_weights_by_name | è·å–æŒ‡å®šæƒé‡ |
| **ç³»ç»Ÿæ§åˆ¶** | FlushCacheReqInput | flush_cache_wrapped | åˆ·æ–°ç¼“å­˜ |
| | ProfileReq | profile | æ€§èƒ½åˆ†æ |
| | SlowDownReqInput | slow_down | é™é€Ÿæ§åˆ¶ |
| **LoRAç®¡ç†** | LoadLoRAAdapterReqInput | load_lora_adapter | åŠ è½½LoRAé€‚é…å™¨ |
| | UnloadLoRAAdapterReqInput | unload_lora_adapter | å¸è½½LoRAé€‚é…å™¨ |

---

## 5. ä¸»è¦è¯·æ±‚ç±»å‹å¤„ç†

SGLangæ”¯æŒå¤šç§ç±»å‹çš„æ¨ç†è¯·æ±‚ï¼Œæ¯ç§è¯·æ±‚ç±»å‹éƒ½æœ‰å…¶ç‰¹å®šçš„å¤„ç†æµç¨‹å’Œä¼˜åŒ–ç­–ç•¥ã€‚ä¸»è¦çš„è¯·æ±‚ç±»å‹åŒ…æ‹¬æ–‡æœ¬ç”Ÿæˆã€åµŒå…¥è®¡ç®—ã€æ‰¹é‡å¤„ç†ç­‰ï¼Œæ¯ç§ç±»å‹éƒ½é’ˆå¯¹ç‰¹å®šçš„åº”ç”¨åœºæ™¯è¿›è¡Œäº†ç›¸åº”çš„ä¼˜åŒ–ã€‚

**è¯·æ±‚å¤„ç†çš„æ ¸å¿ƒç‰¹æ€§**ï¼š
- **å¤šæ¨¡æ€ç»Ÿä¸€å¤„ç†**ï¼šæ‰€æœ‰è¯·æ±‚ç±»å‹éƒ½æ”¯æŒå›¾åƒã€è§†é¢‘ã€éŸ³é¢‘ç­‰å¤šæ¨¡æ€è¾“å…¥
- **ä¼šè¯çŠ¶æ€ç®¡ç†**ï¼šæ”¯æŒè¿ç»­å¯¹è¯å’Œä¸Šä¸‹æ–‡ä¿æŒçš„ä¼šè¯æœºåˆ¶
- **è¯­æ³•çº¦æŸé›†æˆ**ï¼šä¸ºç»“æ„åŒ–è¾“å‡ºæä¾›JSON Schemaã€æ­£åˆ™è¡¨è¾¾å¼ç­‰è¯­æ³•çº¦æŸ
- **æ€§èƒ½ä¼˜åŒ–å†…ç½®**ï¼šæ¯ç§è¯·æ±‚ç±»å‹éƒ½é›†æˆäº†ç›¸åº”çš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

**å¤„ç†æµç¨‹çš„ç»Ÿä¸€æ€§**ï¼š
- **è¾“å…¥éªŒè¯**ï¼šæ‰€æœ‰è¯·æ±‚éƒ½ç»è¿‡ä¸¥æ ¼çš„è¾“å…¥é•¿åº¦å’Œæ ¼å¼éªŒè¯
- **å¤šæ¨¡æ€é¢„å¤„ç†**ï¼šç»Ÿä¸€çš„å¤šæ¨¡æ€æ•°æ®é¢„å¤„ç†æµç¨‹ï¼Œæ”¯æŒä¸åŒæ¨¡æ€çš„tokenåŒ–
- **é˜Ÿåˆ—ç®¡ç†**ï¼šæ ¹æ®è¯·æ±‚ç‰¹æ€§é€‰æ‹©åˆé€‚çš„é˜Ÿåˆ—ï¼ˆwaiting_queueã€grammar_queueç­‰ï¼‰
- **é”™è¯¯å¤„ç†**ï¼šå®Œæ•´çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œç¡®ä¿å¼‚å¸¸è¯·æ±‚çš„å®‰å…¨å¤„ç†

### 5.1 ç”Ÿæˆè¯·æ±‚å¤„ç†

æ–‡æœ¬ç”Ÿæˆè¯·æ±‚æ˜¯SGLangæœ€é‡è¦çš„è¯·æ±‚ç±»å‹ï¼Œå®ƒä¸ä»…è¦å¤„ç†åŸºç¡€çš„æ–‡æœ¬è¾“å…¥ï¼Œè¿˜è¦æ”¯æŒå¤šæ¨¡æ€è¾“å…¥ã€LoRAé€‚é…ã€åˆ†ç¦»å¼æ¶æ„ã€ä¼šè¯ç®¡ç†ç­‰é«˜çº§åŠŸèƒ½ã€‚handle_generate_requestæ–¹æ³•å±•ç°äº†ç°ä»£å¤§è¯­è¨€æ¨¡å‹æ¨ç†ç³»ç»Ÿçš„å¤æ‚æ€§å’ŒåŠŸèƒ½å®Œå¤‡æ€§ã€‚

#### 5.1.1 æ ¸å¿ƒå¤„ç†æµç¨‹

handle_generate_requestæ–¹æ³•æ˜¯SGLangå¤„ç†æ–‡æœ¬ç”Ÿæˆè¯·æ±‚çš„æ ¸å¿ƒå¼•æ“ï¼Œå®ƒéœ€è¦å¤„ç†ç°ä»£å¤§è¯­è¨€æ¨¡å‹æ¨ç†ä¸­çš„å„ç§å¤æ‚åœºæ™¯ã€‚è¯¥æ–¹æ³•ä¸ä»…è¦åˆ›å»ºåŸºç¡€çš„Reqå¯¹è±¡ï¼Œè¿˜è¦å¤„ç†ä¼šè¯ç®¡ç†ã€å¤šæ¨¡æ€è¾“å…¥ã€LoRAé€‚é…ã€åˆ†ç¦»å¼æ¶æ„ç­‰é«˜çº§åŠŸèƒ½ã€‚

**å¤„ç†æµç¨‹çš„æ ¸å¿ƒç¯èŠ‚**ï¼š
- **è´Ÿè½½å‡è¡¡å¤„ç†**ï¼šåœ¨æ•°æ®å¹¶è¡Œæ¨¡å¼ä¸‹è®°å½•è¯·æ±‚çš„è´Ÿè½½å‡è¡¡IDï¼Œä¸ºåç»­çš„è´Ÿè½½åˆ†é…æä¾›ä¾æ®
- **ä¼šè¯çŠ¶æ€ç®¡ç†**ï¼šæ£€æŸ¥å’Œåˆ›å»ºä¼šè¯çŠ¶æ€ï¼Œæ”¯æŒè¿ç»­å¯¹è¯å’Œä¸Šä¸‹æ–‡ä¿æŒ
- **è¾“å…¥åµŒå…¥å¤„ç†**ï¼šå¯¹äºç›´æ¥æä¾›åµŒå…¥å‘é‡çš„è¯·æ±‚ï¼Œç”Ÿæˆè™šæ‹Ÿtoken IDä»¥é€‚é…æ¨¡å‹è¾“å…¥æ ¼å¼
- **åˆ†ç¦»å¼æ¶æ„é…ç½®**ï¼šè®¾ç½®bootstrapç«¯å£ç­‰åˆ†ç¦»å¼æ¨ç†çš„è¿æ¥å‚æ•°

**Reqå¯¹è±¡åˆ›å»ºçš„å¤æ‚æ€§**ï¼šåˆ›å»ºReqå¯¹è±¡æ—¶éœ€è¦ä¼ é€’20+ä¸ªå‚æ•°ï¼Œæ¯ä¸ªå‚æ•°éƒ½å¯¹åº”ç‰¹å®šçš„åŠŸèƒ½éœ€æ±‚ã€‚è¿™ç§è®¾è®¡ç¡®ä¿äº†Reqå¯¹è±¡èƒ½å¤Ÿæ‰¿è½½å®Œæ•´çš„è¯·æ±‚ä¿¡æ¯ï¼Œä¸ºåç»­çš„è°ƒåº¦å’Œæ‰§è¡Œæä¾›å……åˆ†çš„ä¸Šä¸‹æ–‡ã€‚

**å‚æ•°æ˜ å°„ç­–ç•¥**ï¼šhandle_generate_requestæ–¹æ³•å®ç°äº†ä»TokenizedGenerateReqInputåˆ°Reqå¯¹è±¡çš„å®Œæ•´å‚æ•°æ˜ å°„ï¼ŒåŒ…æ‹¬é‡‡æ ·å‚æ•°ã€å¤šæ¨¡æ€è¾“å…¥ã€LoRAé…ç½®ã€åˆ†ç¦»å¼æ¶æ„å‚æ•°ç­‰ï¼Œç¡®ä¿äº†ä¿¡æ¯çš„å®Œæ•´ä¼ é€’ã€‚

```python
def handle_generate_request(self, recv_req: TokenizedGenerateReqInput):
    # æ•°æ®å¹¶è¡Œè´Ÿè½½å‡è¡¡ï¼šè®°å½•è¯·æ±‚çš„è´Ÿè½½å‡è¡¡ID
    if (
        self.server_args.enable_dp_attention
        and self.server_args.load_balance_method == "minimum_tokens"
    ):
        self.recv_dp_balance_id_this_term.append(recv_req.dp_balance_id)

    # åˆ›å»ºæ–°è¯·æ±‚ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºæ–°ä¼šè¯æˆ–ç°æœ‰ä¼šè¯
    if (
        recv_req.session_params is None
        or recv_req.session_params.id is None
        or recv_req.session_params.id not in self.sessions
    ):
        # å¤„ç†è¾“å…¥åµŒå…¥çš„ç‰¹æ®Šæƒ…å†µ
        if recv_req.input_embeds is not None:
            # ä¸ºè¾“å…¥åµŒå…¥ç”Ÿæˆè™šæ‹Ÿtoken IDsï¼Œé€‚é…æ¨¡å‹è¾“å…¥æ ¼å¼
            seq_length = len(recv_req.input_embeds)
            fake_input_ids = [1] * seq_length
            recv_req.input_ids = fake_input_ids

        # åˆ†ç¦»å¼æ¶æ„ï¼šè®¾ç½®é»˜è®¤bootstrapç«¯å£
        if recv_req.bootstrap_port is None:
            # ä½¿ç”¨é»˜è®¤çš„åˆ†ç¦»å¼æ¨ç†ç«¯å£
            recv_req.bootstrap_port = self.server_args.disaggregation_bootstrap_port

        # åˆ›å»ºå®Œæ•´çš„Reqå¯¹è±¡ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦å‚æ•°
        req = Req(
            recv_req.rid,                    # è¯·æ±‚å”¯ä¸€æ ‡è¯†ç¬¦
            recv_req.input_text,             # åŸå§‹è¾“å…¥æ–‡æœ¬
            recv_req.input_ids,              # tokenåŒ–çš„è¾“å…¥åºåˆ—
            recv_req.sampling_params,        # é‡‡æ ·ç­–ç•¥é…ç½®
            return_logprob=recv_req.return_logprob,      # æ˜¯å¦è¿”å›å¯¹æ•°æ¦‚ç‡
            top_logprobs_num=recv_req.top_logprobs_num,  # top-kå¯¹æ•°æ¦‚ç‡æ•°é‡
            token_ids_logprob=recv_req.token_ids_logprob, # æŒ‡å®štokençš„å¯¹æ•°æ¦‚ç‡
            stream=recv_req.stream,                      # æ˜¯å¦å¯ç”¨æµå¼è¾“å‡º
            lora_id=recv_req.lora_id,                   # LoRAé€‚é…å™¨æ ‡è¯†
            input_embeds=recv_req.input_embeds,         # è¾“å…¥åµŒå…¥å‘é‡
            custom_logit_processor=recv_req.custom_logit_processor, # è‡ªå®šä¹‰logitå¤„ç†å™¨
            return_hidden_states=recv_req.return_hidden_states,     # æ˜¯å¦è¿”å›éšè—çŠ¶æ€
            eos_token_ids=self.model_config.hf_eos_token_id,       # ç»“æŸtokené›†åˆ
            bootstrap_host=recv_req.bootstrap_host,     # åˆ†ç¦»å¼æ¨ç†ä¸»æœºåœ°å€
            bootstrap_port=recv_req.bootstrap_port,     # åˆ†ç¦»å¼æ¨ç†ç«¯å£å·
            bootstrap_room=recv_req.bootstrap_room,     # åˆ†ç¦»å¼æ¨ç†æˆ¿é—´ID
            data_parallel_rank=recv_req.data_parallel_rank, # æ•°æ®å¹¶è¡Œrank
            vocab_size=self.model_config.vocab_size,    # æ¨¡å‹è¯æ±‡è¡¨å¤§å°
        )
        req.tokenizer = self.tokenizer  # è®¾ç½®tokenizerå¼•ç”¨
```

#### 5.1.2 å¤šæ¨¡æ€è¾“å…¥å¤„ç†

å¤šæ¨¡æ€è¾“å…¥å¤„ç†æ˜¯ç°ä»£å¤§è¯­è¨€æ¨¡å‹çš„é‡è¦ç‰¹æ€§ï¼ŒSGLangåœ¨ç”Ÿæˆè¯·æ±‚å¤„ç†ä¸­é›†æˆäº†å®Œæ•´çš„å¤šæ¨¡æ€æ•°æ®é¢„å¤„ç†æµç¨‹ã€‚è¿™ä¸ªè¿‡ç¨‹éœ€è¦å°†ä¸åŒæ¨¡æ€çš„æ•°æ®è½¬æ¢ä¸ºæ¨¡å‹å¯ä»¥ç†è§£çš„tokenåºåˆ—ï¼ŒåŒæ—¶ä¿æŒæ•°æ®çš„è¯­ä¹‰å®Œæ•´æ€§ã€‚

**å¤šæ¨¡æ€å¤„ç†çš„æŠ€æœ¯æŒ‘æˆ˜**ï¼š
- **æ•°æ®æ ¼å¼è½¬æ¢**ï¼šå°†å›¾åƒã€è§†é¢‘ã€éŸ³é¢‘ç­‰åŸå§‹æ•°æ®è½¬æ¢ä¸ºtokenåŒ–çš„è¾“å…¥åºåˆ—
- **è¾“å…¥å¡«å……ç­–ç•¥**ï¼šæ ¹æ®ä¸åŒæ¨¡æ€çš„ç‰¹æ€§ï¼Œé‡‡ç”¨åˆé€‚çš„å¡«å……ç­–ç•¥æ¥æ„å»ºç»Ÿä¸€çš„è¾“å…¥æ ¼å¼
- **è¯­ä¹‰å¯¹é½**ï¼šç¡®ä¿å¤šæ¨¡æ€æ•°æ®ä¸æ–‡æœ¬æ•°æ®åœ¨è¯­ä¹‰å±‚é¢çš„æ­£ç¡®å¯¹é½
- **å†…å­˜ä¼˜åŒ–**ï¼šé«˜æ•ˆå¤„ç†å¤§å‹å¤šæ¨¡æ€æ•°æ®ï¼Œé¿å…å†…å­˜æº¢å‡º

**pad_input_ids_funcæ ¸å¿ƒæœºåˆ¶**ï¼špad_input_ids_funcæ˜¯SGLangå¤šæ¨¡æ€tokenåŒ–é›†æˆçš„æ ¸å¿ƒå‡½æ•°ï¼Œå®ƒå®ç°äº†å¤šæ¨¡æ€æ•°æ®åˆ°tokenåºåˆ—çš„æ™ºèƒ½è½¬æ¢ã€‚è¯¥å‡½æ•°æ”¯æŒå¤šç§å¡«å……æ¨¡å¼ï¼ŒåŒ…æ‹¬tokenå¯¹æ¨¡å¼ï¼ˆMultiModalityDataPaddingPatternTokenPairsï¼‰å’Œå¤šæ¨¡æ€tokenæ¨¡å¼ï¼ˆMultiModalityDataPaddingPatternMultimodalTokensï¼‰ï¼Œèƒ½å¤Ÿæ ¹æ®ä¸åŒæ¨¡å‹çš„éœ€æ±‚é€‰æ‹©åˆé€‚çš„å¡«å……ç­–ç•¥ã€‚

**å¡«å……ç­–ç•¥ä¼˜åŒ–**ï¼š
- **Tokenå¯¹æ¨¡å¼**ï¼šé€‚ç”¨äºä½¿ç”¨start/end tokenå¯¹åŒ…å›´å¤šæ¨¡æ€å†…å®¹çš„æ¨¡å‹
- **å¤šæ¨¡æ€Tokenæ¨¡å¼**ï¼šé€‚ç”¨äºä½¿ç”¨å•ä¸€ç‰¹æ®Štokenè¡¨ç¤ºå¤šæ¨¡æ€å†…å®¹çš„æ¨¡å‹
- **Padå€¼ç”Ÿæˆ**ï¼šé€šè¿‡å“ˆå¸Œæœºåˆ¶ä¸ºæ¯ä¸ªå¤šæ¨¡æ€æ•°æ®é¡¹ç”Ÿæˆå”¯ä¸€çš„padå€¼ï¼Œç¡®ä¿æ‰¹é‡å¤„ç†æ—¶çš„æ•°æ®åŒºåˆ†

**è¾“å…¥é•¿åº¦éªŒè¯**ï¼šå¤šæ¨¡æ€è¾“å…¥å¤„ç†åï¼Œç³»ç»Ÿä¼šè¿›è¡Œä¸¥æ ¼çš„é•¿åº¦éªŒè¯ï¼Œç¡®ä¿æ‰©å±•åçš„è¾“å…¥åºåˆ—ä¸è¶…è¿‡æ¨¡å‹çš„æœ€å¤§ä¸Šä¸‹æ–‡é•¿åº¦é™åˆ¶ã€‚è¿™ç§éªŒè¯æœºåˆ¶é˜²æ­¢äº†å› å¤šæ¨¡æ€tokenæ‰©å±•å¯¼è‡´çš„å†…å­˜æº¢å‡ºé—®é¢˜ã€‚

```python
# å¤šæ¨¡æ€è¾“å…¥å¤„ç†
if recv_req.mm_inputs is not None:  # æ£€æŸ¥æ˜¯å¦åŒ…å«å¤šæ¨¡æ€è¾“å…¥
    # ä»å­—å…¸åˆ›å»ºå¤šæ¨¡æ€è¾“å…¥å¯¹è±¡
    mm_inputs = MultimodalInputs.from_dict(recv_req.mm_inputs)
    # ä½¿ç”¨pad_input_ids_funcè¿›è¡Œå¤šæ¨¡æ€tokenåŒ–é›†æˆ
    req.origin_input_ids = self.pad_input_ids_func(
        req.origin_input_ids,  # åŸå§‹tokenåºåˆ—
        mm_inputs              # å¤šæ¨¡æ€è¾“å…¥æ•°æ®
    )
    # å°†å¤šæ¨¡æ€è¾“å…¥æ‰©å±•åˆ°è¯·æ±‚å¯¹è±¡ä¸­
    req.extend_image_inputs(mm_inputs)

# è¾“å…¥é•¿åº¦éªŒè¯ï¼šç¡®ä¿ä¸è¶…è¿‡æ¨¡å‹ä¸Šä¸‹æ–‡é™åˆ¶
error_msg = validate_input_length(
    req,                              # è¯·æ±‚å¯¹è±¡
    self.max_req_input_len,          # æœ€å¤§è¾“å…¥é•¿åº¦é™åˆ¶
    self.server_args.allow_auto_truncate, # æ˜¯å¦å…è®¸è‡ªåŠ¨æˆªæ–­
)
if error_msg:
    req.set_finish_with_abort(error_msg)  # é•¿åº¦è¶…é™ï¼Œä¸­æ­¢è¯·æ±‚
```

#### 5.1.3 è¯­æ³•çº¦æŸå¤„ç†

è¯­æ³•çº¦æŸå¤„ç†æ˜¯SGLangæ”¯æŒç»“æ„åŒ–è¾“å‡ºçš„æ ¸å¿ƒç‰¹æ€§ï¼Œå®ƒé€šè¿‡é›†æˆå¤šç§è¯­æ³•è§„èŒƒï¼ˆJSON Schemaã€æ­£åˆ™è¡¨è¾¾å¼ã€EBNFã€ç»“æ„åŒ–æ ‡ç­¾ï¼‰ï¼Œä¸ºå¤§è¯­è¨€æ¨¡å‹çš„è¾“å‡ºæä¾›äº†å¼ºå¤§çš„æ ¼å¼æ§åˆ¶èƒ½åŠ›ã€‚è¿™ä¸€ç‰¹æ€§å¯¹äºéœ€è¦ç»“æ„åŒ–è¾“å‡ºçš„åº”ç”¨åœºæ™¯è‡³å…³é‡è¦ã€‚

**è¯­æ³•çº¦æŸçš„æŠ€æœ¯å®ç°**ï¼š
- **å¤šæ ¼å¼æ”¯æŒ**ï¼šç»Ÿä¸€æ”¯æŒJSON Schemaã€æ­£åˆ™è¡¨è¾¾å¼ã€EBNFã€ç»“æ„åŒ–æ ‡ç­¾å››ç§ä¸»è¦è¯­æ³•è§„èŒƒ
- **ç¼“å­˜ä¼˜åŒ–**ï¼šé€šè¿‡è¯­æ³•å¯¹è±¡ç¼“å­˜é¿å…é‡å¤çš„è¯­æ³•ç¼–è¯‘å¼€é”€ï¼Œæ˜¾è‘—æå‡æ€§èƒ½
- **å¼‚æ­¥æ„å»º**ï¼šè¯­æ³•å¯¹è±¡çš„æ„å»ºé‡‡ç”¨å¼‚æ­¥æ¨¡å¼ï¼Œé¿å…é˜»å¡ä¸»è°ƒåº¦æµç¨‹
- **é˜Ÿåˆ—åˆ†ç¦»**ï¼šè¯­æ³•çº¦æŸè¯·æ±‚ä½¿ç”¨ä¸“é—¨çš„grammar_queueï¼Œå®ç°ä¸æ™®é€šè¯·æ±‚çš„å¤„ç†éš”ç¦»

**ç¼“å­˜ç­–ç•¥ä¼˜åŒ–**ï¼šSGLangé‡‡ç”¨äº†åŸºäºé”®å€¼çš„è¯­æ³•å¯¹è±¡ç¼“å­˜æœºåˆ¶ï¼Œç›¸åŒçš„è¯­æ³•è§„èŒƒåªéœ€è¦ç¼–è¯‘ä¸€æ¬¡ã€‚ç¼“å­˜é”®ç”±è¯­æ³•ç±»å‹å’Œå†…å®¹ç»„æˆï¼Œç¡®ä¿äº†ç¼“å­˜çš„å‡†ç¡®æ€§å’Œé«˜æ•ˆæ€§ã€‚

**é”™è¯¯å¤„ç†æœºåˆ¶**ï¼šå½“è¯­æ³•çº¦æŸæ— æ•ˆæ—¶ï¼Œç³»ç»Ÿä¼šå°†è¯·æ±‚æ ‡è®°ä¸ºä¸­æ­¢çŠ¶æ€ï¼Œå¹¶æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ã€‚è¿™ç§å¤„ç†æ–¹å¼ç¡®ä¿äº†ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œé¿å…äº†æ— æ•ˆè¯­æ³•å¯¼è‡´çš„ç³»ç»Ÿå¼‚å¸¸ã€‚

```python
# è¯­æ³•çº¦æŸå¤„ç†ï¼ˆæ¥è‡ªhandle_generate_requestæ–¹æ³•ï¼‰
# åˆå§‹åŒ–è¯·æ±‚çš„è¯­æ³•ç¼“å­˜
add_to_grammar_queue = False
if (
    req.sampling_params.json_schema is not None      # JSON Schemaçº¦æŸ
    or req.sampling_params.regex is not None         # æ­£åˆ™è¡¨è¾¾å¼çº¦æŸ
    or req.sampling_params.ebnf is not None          # EBNFè¯­æ³•çº¦æŸ
    or req.sampling_params.structural_tag is not None # ç»“æ„åŒ–æ ‡ç­¾çº¦æŸ
):
    assert self.grammar_backend is not None  # ç¡®ä¿è¯­æ³•åç«¯å·²åˆå§‹åŒ–
    
    # æ ¹æ®è¯­æ³•ç±»å‹æ„å»ºç¼“å­˜é”®
    if req.sampling_params.json_schema is not None:
        key = ("json", req.sampling_params.json_schema)
    elif req.sampling_params.regex is not None:
        key = ("regex", req.sampling_params.regex)
    elif req.sampling_params.ebnf is not None:
        key = ("ebnf", req.sampling_params.ebnf)
    elif req.sampling_params.structural_tag:
        key = ("structural_tag", req.sampling_params.structural_tag)

    # å°è¯•ä»ç¼“å­˜è·å–æˆ–åˆ›å»ºæ–°çš„è¯­æ³•å¯¹è±¡
    value, cache_hit = self.grammar_backend.get_cached_or_future_value(key)
    req.grammar = value  # è®¾ç½®è¯·æ±‚çš„è¯­æ³•å¯¹è±¡

    if not cache_hit:
        # ç¼“å­˜æœªå‘½ä¸­ï¼Œéœ€è¦å¼‚æ­¥æ„å»ºè¯­æ³•å¯¹è±¡
        req.grammar_key = key
        add_to_grammar_queue = True  # æ ‡è®°éœ€è¦æ·»åŠ åˆ°è¯­æ³•é˜Ÿåˆ—
    else:
        # ç¼“å­˜å‘½ä¸­ï¼Œæ£€æŸ¥è¯­æ³•å¯¹è±¡æ˜¯å¦æœ‰æ•ˆ
        if value is INVALID_GRAMMAR_OBJ:  # ç¼“å­˜çš„æ— æ•ˆè¯­æ³•å¯¹è±¡
            error_msg = f"Invalid grammar request with cache hit: {key=}"
            req.set_finish_with_abort(error_msg)  # ä¸­æ­¢æ— æ•ˆè¯­æ³•è¯·æ±‚

# æ ¹æ®è¯­æ³•çŠ¶æ€å†³å®šé˜Ÿåˆ—åˆ†é…
if add_to_grammar_queue:
    req.queue_time_start = time.perf_counter()  # è®°å½•é˜Ÿåˆ—å¼€å§‹æ—¶é—´
    self.grammar_queue.append(req)              # æ·»åŠ åˆ°è¯­æ³•é˜Ÿåˆ—ç­‰å¾…æ„å»º
else:
    self._add_request_to_queue(req)             # æ·»åŠ åˆ°æ™®é€šç­‰å¾…é˜Ÿåˆ—
```

### 5.2 åµŒå…¥è¯·æ±‚å¤„ç†

#### 5.2.1 æ ¸å¿ƒå¤„ç†é€»è¾‘

åµŒå…¥è®¡ç®—è¯·æ±‚çš„å¤„ç†è™½ç„¶åœ¨æµç¨‹ä¸Šç›¸å¯¹ç®€åŒ–ï¼Œä½†åœ¨æŠ€æœ¯å®ç°ä¸ŠåŒæ ·å±•ç°äº†SGLangçš„åŠŸèƒ½å®Œå¤‡æ€§ã€‚åµŒå…¥è¯·æ±‚ä¸»è¦ç”¨äºå‘é‡æ£€ç´¢ã€ç›¸ä¼¼åº¦è®¡ç®—ç­‰åœºæ™¯ï¼Œå…¶å¤„ç†é‡ç‚¹åœ¨äºè¾“å…¥æ•°æ®çš„æ ‡å‡†åŒ–å’Œå¤šæ¨¡æ€æ”¯æŒã€‚

**åµŒå…¥è¯·æ±‚çš„ç‰¹æ®Šæ€§**ï¼š
- **æ— ç”Ÿæˆéœ€æ±‚**ï¼šåµŒå…¥è¯·æ±‚ä¸éœ€è¦tokenç”Ÿæˆï¼Œä¸»è¦å…³æ³¨è¾“å…¥çš„å‘é‡åŒ–è¡¨ç¤º
- **æ‰¹é‡ä¼˜åŒ–å‹å¥½**ï¼šåµŒå…¥è®¡ç®—å¤©ç„¶é€‚åˆæ‰¹é‡å¤„ç†ï¼Œèƒ½å¤Ÿå……åˆ†åˆ©ç”¨GPUçš„å¹¶è¡Œè®¡ç®—èƒ½åŠ›
- **å¤šæ¨¡æ€æ”¯æŒ**ï¼šæ”¯æŒå›¾åƒåµŒå…¥è®¡ç®—ï¼Œä¸ºå¤šæ¨¡æ€æ£€ç´¢åº”ç”¨æä¾›åŸºç¡€
- **é•¿åº¦çº¦æŸå®½æ¾**ï¼šç›¸æ¯”ç”Ÿæˆä»»åŠ¡ï¼ŒåµŒå…¥ä»»åŠ¡å¯¹è¾“å…¥é•¿åº¦çš„çº¦æŸæ›´åŠ å®½æ¾

**logprobé…ç½®ä¼˜åŒ–**ï¼šåµŒå…¥è¯·æ±‚çš„logprob_start_lenè®¾ç½®ä¸ºè¾“å…¥é•¿åº¦å‡1ï¼Œè¿™ç§é…ç½®ç¡®ä¿äº†ç³»ç»Ÿèƒ½å¤Ÿæ­£ç¡®è®¡ç®—è¾“å…¥åºåˆ—çš„å¯¹æ•°æ¦‚ç‡ï¼Œä¸ºä¸€äº›éœ€è¦ç½®ä¿¡åº¦è¯„ä¼°çš„åº”ç”¨æä¾›æ”¯æŒã€‚

```python
def handle_embedding_request(self, recv_req: TokenizedEmbeddingReqInput):
    # åˆ›å»ºåµŒå…¥è¯·æ±‚çš„Reqå¯¹è±¡
    req = Req(
        recv_req.rid,                 # è¯·æ±‚æ ‡è¯†ç¬¦
        recv_req.input_text,          # è¾“å…¥æ–‡æœ¬
        recv_req.input_ids,           # tokenåŒ–çš„è¾“å…¥åºåˆ—
        recv_req.sampling_params,     # é‡‡æ ·å‚æ•°ï¼ˆåµŒå…¥è¯·æ±‚é€šå¸¸ä¸éœ€è¦é‡‡æ ·ï¼‰
        token_type_ids=recv_req.token_type_ids,  # è·¨ç¼–ç å™¨æ¨¡å‹çš„tokenç±»å‹
    )
    req.tokenizer = self.tokenizer  # è®¾ç½®tokenizerå¼•ç”¨

    # å¤„ç†å¤šæ¨¡æ€è¾“å…¥ï¼ˆå›¾åƒåµŒå…¥ç­‰ï¼‰
    if recv_req.image_inputs is not None:
        # ä»å­—å…¸åˆ›å»ºå›¾åƒè¾“å…¥å¯¹è±¡
        image_inputs = MultimodalInputs.from_dict(recv_req.image_inputs)
        # å°†å•ä¸ªå›¾åƒtokenæ‰©å±•ä¸ºå¤šä¸ªè™šæ‹Ÿtokenä»¥æ¥æ”¶å›¾åƒåµŒå…¥
        req.origin_input_ids = self.pad_input_ids_func(
            req.origin_input_ids,  # åŸå§‹tokenåºåˆ—
            image_inputs           # å›¾åƒè¾“å…¥æ•°æ®
        )
        req.extend_image_inputs(image_inputs)  # æ‰©å±•å›¾åƒè¾“å…¥åˆ°è¯·æ±‚ä¸­

        # æ£€æŸ¥å¤šæ¨¡æ€æ‰©å±•åçš„é•¿åº¦
        if len(req.origin_input_ids) >= self.max_req_input_len:
            req.set_finish_with_abort(
                error_msg=(
                    "Multimodal prompt is too long after expanding multimodal tokens. "
                    f"After expanding {len(req.origin_input_ids_unpadded)=} => {len(req.origin_input_ids)} >= {self.max_req_input_len}."
                )
            )
            self._add_request_to_queue(req)  # æ·»åŠ åˆ°é˜Ÿåˆ—ä»¥å‘é€é”™è¯¯å“åº”
            return

    # éªŒè¯è¾“å…¥åºåˆ—é•¿åº¦
    error_msg = validate_input_length(
        req,                              # è¯·æ±‚å¯¹è±¡
        self.max_req_input_len,          # æœ€å¤§è¾“å…¥é•¿åº¦é™åˆ¶
        self.server_args.allow_auto_truncate, # æ˜¯å¦å…è®¸è‡ªåŠ¨æˆªæ–­
    )
    if error_msg:
        req.set_finish_with_abort(error_msg)  # é•¿åº¦è¶…é™ï¼Œä¸­æ­¢è¯·æ±‚
        self._add_request_to_queue(req)       # æ·»åŠ åˆ°é˜Ÿåˆ—ä»¥å‘é€é”™è¯¯å“åº”
        return

    # è®¾ç½®å¯¹æ•°æ¦‚ç‡è®¡ç®—çš„èµ·å§‹ä½ç½®
    req.logprob_start_len = len(req.origin_input_ids) - 1
    self._add_request_to_queue(req)  # å°†è¯·æ±‚æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—
```

### 5.3 æ‰¹é‡è¯·æ±‚å¤„ç†

æ‰¹é‡è¯·æ±‚å¤„ç†æ˜¯SGLangåœ¨ç½‘ç»œä¼ è¾“å’Œå¤„ç†æ•ˆç‡æ–¹é¢çš„é‡è¦ä¼˜åŒ–ï¼Œé€šè¿‡å°†å¤šä¸ªå•ç‹¬è¯·æ±‚åˆå¹¶ä¸ºæ‰¹é‡æ“ä½œï¼Œæ˜¾è‘—å‡å°‘äº†ç½‘ç»œå¾€è¿”æ¬¡æ•°å’Œå‡½æ•°è°ƒç”¨å¼€é”€ã€‚è¿™ç§è®¾è®¡åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹èƒ½å¤Ÿæ˜¾è‘—æå‡ç³»ç»Ÿçš„æ•´ä½“ååé‡ã€‚

**æ‰¹é‡å¤„ç†çš„æ€§èƒ½ä¼˜åŠ¿**ï¼š
- **ç½‘ç»œæ•ˆç‡**ï¼šå‡å°‘TCPè¿æ¥å»ºç«‹å’ŒHTTPè¯·æ±‚å¤´éƒ¨å¼€é”€
- **åºåˆ—åŒ–ä¼˜åŒ–**ï¼šæ‰¹é‡åºåˆ—åŒ–æ¯”å•ç‹¬åºåˆ—åŒ–æ›´é«˜æ•ˆ
- **å¤„ç†æµæ°´åŒ–**ï¼šæ‰¹é‡éªŒè¯å’Œé¢„å¤„ç†ï¼Œå‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€
- **å†…å­˜å±€éƒ¨æ€§**ï¼šç›¸å…³è¯·æ±‚æ•°æ®è¿ç»­å­˜å‚¨ï¼Œæé«˜CPUç¼“å­˜å‘½ä¸­ç‡

**å®ç°ç­–ç•¥**ï¼šæ‰¹é‡è¯·æ±‚å¤„ç†é‡‡ç”¨äº†ç®€å•è€Œé«˜æ•ˆçš„å®ç°ç­–ç•¥â€”â€”éå†æ‰¹é‡å®¹å™¨ä¸­çš„æ¯ä¸ªè¯·æ±‚ï¼Œé€ä¸€è°ƒç”¨å¯¹åº”çš„å•è¯·æ±‚å¤„ç†æ–¹æ³•ã€‚è¿™ç§è®¾è®¡æ—¢ä¿æŒäº†ä»£ç çš„ç®€æ´æ€§ï¼Œåˆå……åˆ†åˆ©ç”¨äº†æ‰¹é‡ä¼ è¾“çš„ç½‘ç»œä¼˜åŠ¿ã€‚

```python
def handle_batch_generate_request(self, recv_req: BatchTokenizedGenerateReqInput):
    """Handle optimized batch generate request."""
    logger.debug(f"Processing batch generate request with {len(recv_req)} requests")

    # Process each request in the batch
    for tokenized_req in recv_req:
        self.handle_generate_request(tokenized_req)

def handle_batch_embedding_request(self, recv_req: BatchTokenizedEmbeddingReqInput):
    """Handle optimized batch embedding request."""
    logger.debug(f"Processing batch embedding request with {len(recv_req)} requests")

    # Process each request in the batch
    for tokenized_req in recv_req:
        self.handle_embedding_request(tokenized_req)
```

---

## 6. ç³»ç»Ÿæ§åˆ¶å’Œç®¡ç†è¯·æ±‚

é™¤äº†åŸºç¡€çš„æ¨ç†è¯·æ±‚å¤–ï¼ŒSGLangè¿˜æ”¯æŒä¸°å¯Œçš„ç³»ç»Ÿæ§åˆ¶å’Œç®¡ç†è¯·æ±‚ï¼Œè¿™äº›è¯·æ±‚å¯¹äºç”Ÿäº§ç¯å¢ƒçš„è¿ç»´å’Œç®¡ç†è‡³å…³é‡è¦ã€‚ç³»ç»Ÿæ§åˆ¶è¯·æ±‚åŒ…æ‹¬ä¼šè¯ç®¡ç†ã€ç¼“å­˜æ§åˆ¶ã€æƒé‡æ›´æ–°ã€æ€§èƒ½åˆ†æç­‰å¤šä¸ªæ–¹é¢ï¼Œåæ˜ äº†SGLangä½œä¸ºç”Ÿäº§çº§æ¨ç†ç³»ç»Ÿçš„åŠŸèƒ½å®Œå¤‡æ€§ã€‚

**ç³»ç»Ÿç®¡ç†çš„æ ¸å¿ƒéœ€æ±‚**ï¼š
- **ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šæ”¯æŒä¼šè¯çš„åˆ›å»ºã€ç»´æŠ¤å’Œé”€æ¯ï¼Œä¸ºè¿ç»­å¯¹è¯æä¾›çŠ¶æ€ä¿æŒ
- **èµ„æºåŠ¨æ€ç®¡ç†**ï¼šæ”¯æŒç¼“å­˜åˆ·æ–°ã€å†…å­˜é‡Šæ”¾ç­‰èµ„æºç®¡ç†æ“ä½œ
- **æ¨¡å‹åŠ¨æ€æ›´æ–°**ï¼šæ”¯æŒLoRAé€‚é…å™¨çš„åŠ¨æ€åŠ è½½å¸è½½ï¼Œä»¥åŠæ¨¡å‹æƒé‡çš„åœ¨çº¿æ›´æ–°
- **ç³»ç»Ÿç›‘æ§è°ƒè¯•**ï¼šæä¾›æ€§èƒ½åˆ†æã€çŠ¶æ€æŸ¥è¯¢ç­‰ç›‘æ§å’Œè°ƒè¯•åŠŸèƒ½

**ç®¡ç†è¯·æ±‚çš„è®¾è®¡ç‰¹ç‚¹**ï¼š
- **å³æ—¶å“åº”**ï¼šå¤§éƒ¨åˆ†ç®¡ç†è¯·æ±‚éƒ½æ˜¯åŒæ­¥å¤„ç†ï¼Œèƒ½å¤Ÿç«‹å³è¿”å›æ“ä½œç»“æœ
- **çŠ¶æ€ä¸€è‡´æ€§**ï¼šæ‰€æœ‰ç®¡ç†æ“ä½œéƒ½ç¡®ä¿ç³»ç»ŸçŠ¶æ€çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§
- **é”™è¯¯å¤„ç†å®Œå¤‡**ï¼šæ¯ä¸ªç®¡ç†æ“ä½œéƒ½æœ‰å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œå¼‚å¸¸æ¢å¤æœºåˆ¶
- **æ—¥å¿—è®°å½•è¯¦ç»†**ï¼šæ‰€æœ‰å…³é”®æ“ä½œéƒ½æœ‰è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼Œä¾¿äºæ•…éšœè¯Šæ–­

### 6.1 ä¼šè¯ç®¡ç†

ä¼šè¯ç®¡ç†æ˜¯SGLangæ”¯æŒè¿ç»­å¯¹è¯çš„æ ¸å¿ƒæœºåˆ¶ï¼Œå®ƒé€šè¿‡Sessionå¯¹è±¡ç»´æŠ¤å¯¹è¯çš„å†å²çŠ¶æ€å’Œä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚ä¼šè¯ç³»ç»Ÿä¸ä»…è¦å¤„ç†åŸºç¡€çš„çŠ¶æ€ä¿æŒï¼Œè¿˜è¦è€ƒè™‘å®¹é‡é™åˆ¶ã€èµ„æºæ¸…ç†ã€å¹¶å‘è®¿é—®ç­‰å¤æ‚é—®é¢˜ã€‚

**ä¼šè¯ç³»ç»Ÿçš„æ ¸å¿ƒç‰¹æ€§**ï¼š
- **çŠ¶æ€æŒä¹…åŒ–**ï¼šç»´æŠ¤å¯¹è¯å†å²å’Œä¸Šä¸‹æ–‡çŠ¶æ€ï¼Œæ”¯æŒé•¿æ—¶é—´çš„è¿ç»­äº¤äº’
- **å®¹é‡ç®¡ç†**ï¼šæ¯ä¸ªä¼šè¯éƒ½æœ‰å­—ç¬¦ä¸²é•¿åº¦å®¹é‡é™åˆ¶ï¼Œé˜²æ­¢å•ä¸ªä¼šè¯å ç”¨è¿‡å¤šèµ„æº
- **é”™è¯¯å¤„ç†å®Œå¤‡**ï¼šå¯¹é‡å¤åˆ›å»ºã€ä¸å­˜åœ¨çš„ä¼šè¯ç­‰å¼‚å¸¸æƒ…å†µæä¾›å®Œæ•´çš„é”™è¯¯å¤„ç†
- **å¹¶å‘å®‰å…¨**ï¼šæ”¯æŒå¤šä¸ªä¼šè¯çš„å¹¶å‘è®¿é—®å’Œç®¡ç†

**ä¼šè¯åˆ›å»ºçš„å®‰å…¨æœºåˆ¶**ï¼šopen_sessionæ–¹æ³•å®ç°äº†å®Œæ•´çš„é”™è¯¯æ£€æŸ¥ï¼ŒåŒ…æ‹¬ä¼šè¯IDé‡å¤æ£€æŸ¥ã€ç©ºIDæ£€æŸ¥ç­‰ã€‚å½“å‡ºç°å¼‚å¸¸æƒ…å†µæ—¶ï¼Œæ–¹æ³•ä¼šè¿”å›ç›¸åº”çš„é”™è¯¯çŠ¶æ€ï¼Œç¡®ä¿å®¢æˆ·ç«¯èƒ½å¤Ÿæ­£ç¡®å¤„ç†ä¼šè¯åˆ›å»ºå¤±è´¥çš„æƒ…å†µã€‚

**ä¼šè¯é”€æ¯çš„èµ„æºç®¡ç†**ï¼šclose_sessionæ–¹æ³•åœ¨åˆ é™¤ä¼šè¯æ—¶ä¼šè¿›è¡Œå­˜åœ¨æ€§æ£€æŸ¥ï¼Œé¿å…åˆ é™¤ä¸å­˜åœ¨çš„ä¼šè¯ã€‚è¿™ç§è®¾è®¡ç¡®ä¿äº†ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œé˜²æ­¢äº†å› ä¼šè¯ç®¡ç†é”™è¯¯å¯¼è‡´çš„ç³»ç»Ÿå¼‚å¸¸ã€‚

```python
def open_session(self, recv_req: OpenSessionReqInput):
    # handle error
    session_id = recv_req.session_id
    if session_id in self.sessions:
        logger.warning(f"session id {session_id} already exist, cannot open.")
        return OpenSessionReqOutput(session_id, False)
    elif session_id is None:
        logger.warning("session id is None, cannot open.")
        return OpenSessionReqOutput(session_id, False)
    else:
        self.sessions[session_id] = Session(
            recv_req.capacity_of_str_len, session_id
        )
        return OpenSessionReqOutput(session_id, True)

def close_session(self, recv_req: CloseSessionReqInput):
    # handle error
    session_id = recv_req.session_id
    if session_id not in self.sessions:
        logger.warning(f"session id {session_id} does not exist, cannot delete.")
    else:
        del self.sessions[session_id]
```

### 6.2 ç¼“å­˜ç®¡ç†

ç¼“å­˜ç®¡ç†æ˜¯SGLangç³»ç»Ÿç»´æŠ¤çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå®ƒæä¾›äº†ç¼“å­˜åˆ·æ–°å’Œè¯·æ±‚ä¸­æ­¢ç­‰å…³é”®åŠŸèƒ½ã€‚è¿™äº›æ“ä½œå¯¹äºç³»ç»Ÿçš„ç¨³å®šè¿è¡Œå’Œèµ„æºç®¡ç†è‡³å…³é‡è¦ï¼Œç‰¹åˆ«æ˜¯åœ¨é•¿æ—¶é—´è¿è¡Œçš„ç”Ÿäº§ç¯å¢ƒä¸­ã€‚

**ç¼“å­˜ç®¡ç†çš„æ ¸å¿ƒåŠŸèƒ½**ï¼š
- **å…¨å±€ç¼“å­˜åˆ·æ–°**ï¼šæ¸…ç†æ‰€æœ‰ç¼“å­˜æ•°æ®ï¼Œé‡Šæ”¾å†…å­˜èµ„æºï¼Œä¸ºç³»ç»Ÿé‡ç½®æä¾›æ”¯æŒ
- **è¯·æ±‚ä¸­æ­¢æœºåˆ¶**ï¼šæ”¯æŒç²¾ç¡®çš„è¯·æ±‚å–æ¶ˆï¼ŒåŒ…æ‹¬ç­‰å¾…é˜Ÿåˆ—å’Œè¿è¡Œæ‰¹æ¬¡ä¸­çš„è¯·æ±‚
- **çŠ¶æ€ä¸€è‡´æ€§**ï¼šç¡®ä¿ç¼“å­˜æ“ä½œå’Œè¯·æ±‚ä¸­æ­¢ä¸ä¼šç ´åç³»ç»Ÿçš„å†…éƒ¨çŠ¶æ€
- **èµ„æºå›æ”¶**ï¼šåŠæ—¶å›æ”¶è¢«ä¸­æ­¢è¯·æ±‚å ç”¨çš„å†…å­˜å’Œè®¡ç®—èµ„æº

**è¯·æ±‚ä¸­æ­¢ç­–ç•¥**ï¼šabort_requestæ–¹æ³•å®ç°äº†å…¨é¢çš„è¯·æ±‚æŸ¥æ‰¾å’Œä¸­æ­¢é€»è¾‘ï¼Œå®ƒä¼šåœ¨ç­‰å¾…é˜Ÿåˆ—å’Œè¿è¡Œæ‰¹æ¬¡ä¸­æŸ¥æ‰¾ç›®æ ‡è¯·æ±‚ï¼Œå¹¶è®¾ç½®é€‚å½“çš„ä¸­æ­¢çŠ¶æ€ã€‚è¿™ç§è®¾è®¡ç¡®ä¿äº†è¯·æ±‚èƒ½å¤Ÿè¢«åŠæ—¶ä¸­æ­¢ï¼Œé¿å…èµ„æºæµªè´¹ã€‚

```python
def flush_cache_wrapped(self, recv_req: FlushCacheReqInput):
    success = self.flush_cache()
    return FlushCacheReqOutput(success=success)

def abort_request(self, recv_req: AbortReq):
    # Delete requests in the waiting queue
    to_del = []
    for i, req in enumerate(self.waiting_queue):
        if recv_req.abort_all or req.rid.startswith(recv_req.rid):
            to_del.append(i)

    # Sort in reverse order to avoid index issues when deleting
    for i in reversed(to_del):
        # Abort method 1: directly pop from the queue
        # This only works for requests that have not started anything.
        # We still need to send something back to TokenizerManager to clean up the state.
        req = self.waiting_queue.pop(i)
        self.send_to_tokenizer.send_pyobj(AbortReq(req.rid))
        logger.debug(f"Abort queued request. {req.rid=}")

    # Delete the requests in the grammar queue
    for req in self.grammar_queue:
        # Abort method 2: call `set_finish_with_abort`
        # The request will still run one prefill forward pass.
        # In this case, we change the input_ids to be only one token to make this prefill cheap.
        if recv_req.abort_all or req.rid.startswith(recv_req.rid):
            logger.debug(f"Abort grammar queue request. {req.rid=}")
            if req.grammar:
                req.grammar.cancel()
            req.set_finish_with_abort("Aborted by AbortReq.")
```

---

## 7. æµé‡æ§åˆ¶æœºåˆ¶

æµé‡æ§åˆ¶æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿç¨³å®šæ€§çš„é‡è¦ä¿éšœï¼ŒSGLangé€šè¿‡SchedulerInputBlockerå®ç°äº†ç²¾ç»†çš„æµé‡ç®¡ç†å’ŒèƒŒå‹æœºåˆ¶ã€‚è¿™ä¸ªç³»ç»Ÿä¸ä»…è¦å¤„ç†æ­£å¸¸çš„æµé‡æ§åˆ¶éœ€æ±‚ï¼Œè¿˜è¦åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­å®ç°å…¨å±€ä¸€è‡´çš„é˜»å¡æ§åˆ¶ã€‚

**æµé‡æ§åˆ¶çš„æ ¸å¿ƒä»·å€¼**ï¼š
- **ç³»ç»Ÿä¿æŠ¤**ï¼šåœ¨ç³»ç»Ÿç»´æŠ¤æˆ–å¼‚å¸¸æƒ…å†µä¸‹ï¼Œèƒ½å¤ŸåŠæ—¶é˜»æ­¢æ–°è¯·æ±‚çš„è¿›å…¥
- **è´Ÿè½½å‡è¡¡**ï¼šé€šè¿‡åŠ¨æ€çš„æµé‡æ§åˆ¶ï¼Œå®ç°ç³»ç»Ÿè´Ÿè½½çš„å¹³è¡¡å’Œä¼˜åŒ–
- **æ•…éšœæ¢å¤**ï¼šåœ¨ç³»ç»Ÿæ•…éšœæ¢å¤è¿‡ç¨‹ä¸­ï¼Œæä¾›æ¸è¿›å¼çš„æµé‡æ¢å¤æœºåˆ¶
- **åˆ†å¸ƒå¼ä¸€è‡´æ€§**ï¼šåœ¨å¤šèŠ‚ç‚¹ç¯å¢ƒä¸­ä¿æŒæµé‡æ§åˆ¶çŠ¶æ€çš„å…¨å±€ä¸€è‡´

**é˜»å¡æœºåˆ¶çš„æŠ€æœ¯å®ç°**ï¼š
- **çŠ¶æ€æœºé©±åŠ¨**ï¼šé€šè¿‡å†…éƒ¨çŠ¶æ€æœºç²¾ç¡®æ§åˆ¶é˜»å¡å’Œè§£é™¤é˜»å¡çš„æ—¶æœº
- **è¯·æ±‚ç¼“å­˜**ï¼šé˜»å¡æœŸé—´çš„è¯·æ±‚ä¼šè¢«ç¼“å­˜ï¼Œé¿å…è¯·æ±‚ä¸¢å¤±
- **å…¨å±€åŒæ­¥**ï¼šé€šè¿‡barrieræœºåˆ¶å®ç°åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„å…¨å±€åŒæ­¥
- **æ— æ“ä½œä¼˜åŒ–**ï¼šåœ¨å•èŠ‚ç‚¹ç¯å¢ƒä¸‹æ”¯æŒnoopæ¨¡å¼ï¼Œé¿å…ä¸å¿…è¦çš„åŒæ­¥å¼€é”€

### 7.1 SchedulerInputBlocker

SchedulerInputBlockerå®ç°äº†SGLangçš„æ ¸å¿ƒæµé‡æ§åˆ¶åŠŸèƒ½ï¼Œå®ƒé€šè¿‡çŠ¶æ€æœºç®¡ç†å’Œåˆ†å¸ƒå¼åŒæ­¥æœºåˆ¶ï¼Œæä¾›äº†å¯é çš„è¯·æ±‚é˜»å¡å’Œæµé‡ç®¡ç†èƒ½åŠ›ã€‚è¿™ä¸ªç»„ä»¶åœ¨ç³»ç»Ÿç»´æŠ¤ã€æ•…éšœæ¢å¤ã€è´Ÿè½½æ§åˆ¶ç­‰åœºæ™¯ä¸­å‘æŒ¥ç€å…³é”®ä½œç”¨ã€‚

**çŠ¶æ€æœºè®¾è®¡**ï¼šSchedulerInputBlockeré‡‡ç”¨äº†ä¸‰çŠ¶æ€è®¾è®¡ï¼ˆUNBLOCKEDã€BLOCKEDã€GLOBAL_UNBLOCK_BARRIERï¼‰ï¼Œé€šè¿‡çŠ¶æ€è½¬æ¢å®ç°ç²¾ç¡®çš„æµé‡æ§åˆ¶ã€‚æ¯ä¸ªçŠ¶æ€éƒ½æœ‰æ˜ç¡®çš„è¯­ä¹‰å’Œè½¬æ¢æ¡ä»¶ï¼Œç¡®ä¿äº†æµé‡æ§åˆ¶çš„å¯é¢„æµ‹æ€§ã€‚

**è¯·æ±‚å¤„ç†ç­–ç•¥**ï¼š
- **UNBLOCKEDçŠ¶æ€**ï¼šæ­£å¸¸æ”¾è¡Œæ‰€æœ‰è¯·æ±‚
- **BLOCKEDçŠ¶æ€**ï¼šç¼“å­˜æ‰€æœ‰æ–°è¯·æ±‚åˆ°pendingé˜Ÿåˆ—
- **GLOBAL_UNBLOCK_BARRIERçŠ¶æ€**ï¼šç­‰å¾…åˆ†å¸ƒå¼åŒæ­¥å®Œæˆåç»Ÿä¸€é‡Šæ”¾pendingè¯·æ±‚

**åˆ†å¸ƒå¼åŒæ­¥ä¼˜åŒ–**ï¼šPollBasedBarrierå®ç°äº†é«˜æ•ˆçš„åˆ†å¸ƒå¼åŒæ­¥ï¼Œé¿å…äº†ä¼ ç»Ÿbarrierçš„é˜»å¡ç­‰å¾…ï¼Œé€šè¿‡è½®è¯¢æœºåˆ¶å®ç°äº†éé˜»å¡çš„åŒæ­¥æ£€æŸ¥ã€‚

```python
class SchedulerInputBlocker:
    """SGLangæµé‡æ§åˆ¶å®Œæ•´å®ç°"""
    def __init__(self, noop: bool):
        self._state = _State.UNBLOCKED
        self._pending_reqs = []
        self._noop = noop
        self._global_unblock_barrier = PollBasedBarrier(noop=noop)

    def handle(self, recv_reqs: Optional[List[Any]]):
        """å¤„ç†æ¥æ”¶åˆ°çš„è¯·æ±‚ï¼Œæ ¹æ®é˜»å¡çŠ¶æ€å†³å®šæ˜¯å¦æ”¾è¡Œ"""
        assert (recv_reqs is None) == self._noop

        if not self._noop:
            output_reqs = []
            for recv_req in recv_reqs:
                output_reqs += self._handle_recv_req(recv_req)

        # æ£€æŸ¥å…¨å±€è§£é™¤é˜»å¡å±éšœ
        global_arrived_unblock_barrier = (
            self._global_unblock_barrier.poll_global_arrived()
        )
        if (self._state == _State.GLOBAL_UNBLOCK_BARRIER 
            and global_arrived_unblock_barrier):
            output_reqs += self._handle_arrive_unblock_barrier()

        if not self._noop:
            return output_reqs

    def _handle_recv_req(self, recv_req):
        """å¤„ç†å•ä¸ªè¯·æ±‚"""
        if isinstance(recv_req, BlockReqInput):
            if recv_req.type == BlockReqType.BLOCK:
                self._execute_block_req()
                return []
            elif recv_req.type == BlockReqType.UNBLOCK:
                self._execute_unblock_req()
                return []
            else:
                raise NotImplementedError(f"{recv_req=}")
        else:
            if self._state == _State.UNBLOCKED:
                return [recv_req]
            else:
                self._pending_reqs.append(recv_req)
                return []
```

---

## 8. æ ¸å¿ƒè®¾è®¡åŸåˆ™ä¸ä¼˜åŠ¿

### 8.1 æ¶æ„è®¾è®¡ä¼˜åŠ¿

SGLangè¯·æ±‚å¤„ç†æœºåˆ¶é‡‡ç”¨äº†ç°ä»£åˆ†å¸ƒå¼ç³»ç»Ÿçš„æˆç†Ÿè®¾è®¡æ¨¡å¼ï¼Œé€šè¿‡åˆ†å±‚æ¶æ„ã€ç±»å‹åŒ–åˆ†å‘ã€å¼‚æ­¥å¤„ç†ç­‰æŠ€æœ¯ï¼Œå®ç°äº†é«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„è¯·æ±‚å¤„ç†ç³»ç»Ÿã€‚

**ç±»å‹åŒ–åˆ†å‘ç³»ç»Ÿ**ï¼š
- **O(1)è·¯ç”±æ€§èƒ½**ï¼šåŸºäºPythonç±»å‹ç³»ç»Ÿçš„é«˜æ•ˆè¯·æ±‚åˆ†å‘ï¼Œé¿å…äº†ä¼ ç»Ÿæ¡ä»¶åˆ¤æ–­çš„æ€§èƒ½å¼€é”€
- **å¼ºç±»å‹å®‰å…¨**ï¼šç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯
- **æ‰©å±•æ€§è®¾è®¡**ï¼šæ–°å¢è¯·æ±‚ç±»å‹åªéœ€ç®€å•çš„é…ç½®ä¿®æ”¹ï¼Œæ— éœ€æ”¹åŠ¨æ ¸å¿ƒé€»è¾‘

```python
# TypeBasedDispatcherçš„æ ¸å¿ƒå®ç°å±•ç¤ºO(1)è·¯ç”±æ€§èƒ½
class TypeBasedDispatcher:
    def __init__(self, mapping: List[Tuple[Type, Callable]]):
        self._mapping = mapping  # å­˜å‚¨ç±»å‹åˆ°å¤„ç†å‡½æ•°çš„æ˜ å°„è¡¨

    def __call__(self, obj: Any):
        for ty, fn in self._mapping:
            if isinstance(obj, ty):  # O(1)ç±»å‹æ£€æŸ¥ï¼Œé¿å…å¤æ‚æ¡ä»¶åˆ¤æ–­
                return fn(obj)  # ç›´æ¥è°ƒç”¨å¯¹åº”çš„å¤„ç†å‡½æ•°
        raise ValueError(f"Invalid object: {obj}")  # æœªçŸ¥ç±»å‹çš„fail-fastå¤„ç†

# åˆ†å‘å™¨é…ç½®å±•ç¤ºæ‰©å±•æ€§è®¾è®¡
self._request_dispatcher = TypeBasedDispatcher([
    (TokenizedGenerateReqInput, self.handle_generate_request),      # æ–‡æœ¬ç”Ÿæˆè¯·æ±‚
    (TokenizedEmbeddingReqInput, self.handle_embedding_request),    # åµŒå…¥è®¡ç®—è¯·æ±‚
    (BatchTokenizedGenerateReqInput, self.handle_batch_generate_request),  # æ‰¹é‡ç”Ÿæˆè¯·æ±‚
    (BatchTokenizedEmbeddingReqInput, self.handle_batch_embedding_request), # æ‰¹é‡åµŒå…¥è¯·æ±‚
    # ... 20+ç§è¯·æ±‚ç±»å‹æ˜ å°„ï¼Œæ”¯æŒå®Œæ•´çš„åŠŸèƒ½è¦†ç›–
])
```

**å¼‚æ­¥å¤„ç†æ¶æ„**ï¼š
- **éé˜»å¡é€šä¿¡**ï¼šZMQéé˜»å¡æ¨¡å¼ç¡®ä¿è°ƒåº¦å™¨çº¿ç¨‹ä¸ä¼šè¢«ç½‘ç»œIOé˜»å¡
- **å¹¶å‘å¤„ç†èƒ½åŠ›**ï¼šæ”¯æŒå¤šè¯·æ±‚å¹¶å‘å¤„ç†ï¼Œå……åˆ†åˆ©ç”¨ç³»ç»Ÿèµ„æº
- **èƒŒå‹ç®¡ç†**ï¼šæ™ºèƒ½çš„æµé‡æ§åˆ¶å’Œé˜Ÿåˆ—ä¿æŠ¤ï¼Œé˜²æ­¢ç³»ç»Ÿè¿‡è½½

```python
# éé˜»å¡ZMQé€šä¿¡çš„æ ¸å¿ƒå®ç°
while True:
    try:
        # éé˜»å¡æ¥æ”¶ï¼Œé¿å…è°ƒåº¦å™¨çº¿ç¨‹è¢«IOé˜»å¡
        recv_req = self.recv_from_tokenizer.recv_pyobj(zmq.NOBLOCK)
    except zmq.ZMQError:
        break  # æ— è¯·æ±‚æ—¶ç«‹å³é€€å‡ºï¼Œä¿æŒé«˜å“åº”æ€§
    recv_reqs.append(recv_req)  # æ”¶é›†æ‰€æœ‰å¯ç”¨è¯·æ±‚

# é˜Ÿåˆ—ä¿æŠ¤çš„èƒŒå‹æœºåˆ¶
if is_work_request(recv_req):  # æ£€æŸ¥æ˜¯å¦ä¸ºå·¥ä½œè¯·æ±‚
    if len(self.waiting_queue) + 1 > self.max_queued_requests:  # é˜Ÿåˆ—å®¹é‡æ£€æŸ¥
        # åˆ›å»ºä¸­æ­¢è¯·æ±‚ï¼Œè¿”å›HTTP 503é”™è¯¯
        abort_req = AbortReq(
            recv_req.rid,
            finished_reason={
                "type": "abort",
                "status_code": HTTPStatus.SERVICE_UNAVAILABLE,
                "message": "The request queue is full.",  # é˜Ÿåˆ—æ»¡è½½é”™è¯¯ä¿¡æ¯
            },
        )
        self.send_to_tokenizer.send_pyobj(abort_req)  # å‘é€ä¸­æ­¢å“åº”
        continue  # è·³è¿‡å½“å‰è¯·æ±‚å¤„ç†
```

**æ¨¡å—åŒ–åˆ†å±‚è®¾è®¡**ï¼š
- **èŒè´£åˆ†ç¦»**ï¼šæ¥æ”¶ã€åˆ†å‘ã€å¤„ç†ã€é˜Ÿåˆ—ç®¡ç†å„å±‚èŒè´£æ¸…æ™°
- **æ¥å£æ ‡å‡†åŒ–**ï¼šå±‚é—´é€šè¿‡æ ‡å‡†åŒ–æ¥å£äº¤äº’ï¼Œæé«˜ç³»ç»Ÿçš„å¯æµ‹è¯•æ€§
- **æ•…éšœéš”ç¦»**ï¼šæ¨¡å—åŒ–è®¾è®¡å®ç°äº†æ•…éšœçš„æœ‰æ•ˆéš”ç¦»å’Œæ¢å¤

**åˆ†å¸ƒå¼åè°ƒæœºåˆ¶**ï¼š
- **å¤šå¹¶è¡Œæ¨¡å¼æ”¯æŒ**ï¼šåŸç”Ÿæ”¯æŒTPã€PPã€DPç­‰å¤šç§å¹¶è¡Œç­–ç•¥
- **æ™ºèƒ½rankåˆ†å·¥**ï¼šæ ¹æ®å¹¶è¡Œé…ç½®è‡ªåŠ¨åˆ†é…æ¥æ”¶å’Œå¤„ç†ä»»åŠ¡
- **ä¸€è‡´æ€§ä¿è¯**ï¼šé€šè¿‡å¹¿æ’­å’Œç‚¹å¯¹ç‚¹é€šä¿¡ç¡®ä¿åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„æ•°æ®ä¸€è‡´æ€§

```python
# åˆ†å¸ƒå¼æ¥æ”¶çš„æ™ºèƒ½rankåˆ†å·¥
if self.pp_rank == 0:  # æµæ°´çº¿å¹¶è¡Œçš„ç¬¬ä¸€ä¸ªstage
    if self.attn_tp_rank == 0:  # æ³¨æ„åŠ›å¼ é‡å¹¶è¡Œçš„ä¸»rank
        # åªæœ‰ä¸»rankè´Ÿè´£å®é™…çš„ç½‘ç»œæ¥æ”¶
        recv_reqs = []
        while True:
            try:
                # ä»tokenizeræ¥æ”¶è¯·æ±‚
                recv_req = self.recv_from_tokenizer.recv_pyobj(zmq.NOBLOCK)
            except zmq.ZMQError:
                break  # æ— æ›´å¤šè¯·æ±‚æ—¶é€€å‡º
            recv_reqs.append(recv_req)
    else:
        recv_reqs = None  # éä¸»rankä¸æ¥æ”¶ï¼Œç­‰å¾…åŒæ­¥
else:
    # PP ranké—´çš„ç‚¹å¯¹ç‚¹é€šä¿¡
    if self.attn_tp_rank == 0:  # æ¯ä¸ªPP stageçš„ä¸»rank
        dp_offset = self.attn_dp_rank * self.attn_tp_size  # è®¡ç®—æ•°æ®å¹¶è¡Œåç§»
        # ä»å‰ä¸€ä¸ªPP rankæ¥æ”¶è¯·æ±‚æ•°æ®
        recv_reqs = point_to_point_pyobj(
            [],  # ç©ºçš„åˆå§‹æ•°æ®
            self.pp_rank * self.tp_size + dp_offset,      # å½“å‰rankåœ°å€
            self.world_group.device_group,                # é€šä¿¡ç»„
            (self.pp_rank - 1) * self.tp_size + dp_offset, # æºrankåœ°å€
            self.pp_rank * self.tp_size + dp_offset,       # ç›®æ ‡rankåœ°å€
        )

# DPæ³¨æ„åŠ›çš„é«˜æ•ˆå¹¿æ’­
if self.server_args.enable_dp_attention:  # å¯ç”¨æ•°æ®å¹¶è¡Œæ³¨æ„åŠ›
    # å°†è¯·æ±‚å¹¿æ’­åˆ°æ‰€æœ‰DP ranksï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
    recv_reqs = broadcast_pyobj(
        recv_reqs,                           # è¦å¹¿æ’­çš„è¯·æ±‚æ•°æ®
        self.world_group.device_group,       # é€šä¿¡ç»„
        self.attn_dp_rank * self.attn_tp_size, # å¹¿æ’­æºrank
    )
```

### 8.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

SGLangè¯·æ±‚å¤„ç†ç³»ç»Ÿåœ¨æ€§èƒ½ä¼˜åŒ–æ–¹é¢é‡‡ç”¨äº†å¤šå±‚æ¬¡çš„ç­–ç•¥ï¼Œä»å†…å­˜ç®¡ç†åˆ°ç½‘ç»œé€šä¿¡ï¼Œä»è®¡ç®—æ•ˆç‡åˆ°ç¼“å­˜æœºåˆ¶ï¼Œå…¨é¢æå‡ç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›ã€‚

**ç½‘ç»œé€šä¿¡ä¼˜åŒ–**ï¼š
SGLangè¯·æ±‚å¤„ç†ç³»ç»Ÿåœ¨ç½‘ç»œé€šä¿¡æ–¹é¢é‡‡ç”¨äº†å¤šé¡¹ä¼˜åŒ–æŠ€æœ¯ï¼ŒåŒ…æ‹¬éé˜»å¡ZMQé€šä¿¡ã€æ‰¹é‡è¯·æ±‚ä¼ è¾“ã€åˆ†å¸ƒå¼å¹¿æ’­ä¼˜åŒ–ç­‰ï¼Œè¿™äº›ä¼˜åŒ–ç­–ç•¥æ˜¾è‘—æå‡äº†ç³»ç»Ÿåœ¨é«˜å¹¶å‘å’Œåˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„æ€§èƒ½è¡¨ç°ã€‚

**ZMQéé˜»å¡é€šä¿¡**ï¼šé€šè¿‡ZMQçš„éé˜»å¡æ¨¡å¼ï¼Œè°ƒåº¦å™¨èƒ½å¤Ÿåœ¨ç½‘ç»œIOç¹å¿™æ—¶ç»§ç»­å¤„ç†å…¶ä»–ä»»åŠ¡ï¼Œé¿å…äº†ä¼ ç»Ÿé˜»å¡IOå¯¼è‡´çš„æ€§èƒ½ç“¶é¢ˆã€‚

**åˆ†å¸ƒå¼é€šä¿¡ä¼˜åŒ–**ï¼šåœ¨æ•°æ®å¹¶è¡Œæ¨¡å¼ä¸‹ï¼ŒSGLangé‡‡ç”¨äº†é«˜æ•ˆçš„å¹¿æ’­ç®—æ³•ï¼Œå°†è¯·æ±‚æ•°æ®ä¸€æ¬¡æ€§åŒæ­¥åˆ°æ‰€æœ‰DP ranksï¼Œé¿å…äº†ç‚¹å¯¹ç‚¹é€šä¿¡çš„O(nÂ²)å¤æ‚åº¦ã€‚

**æ‰¹é‡ä¼ è¾“æ•ˆç‡**ï¼šæ‰¹é‡è¯·æ±‚é€šè¿‡å‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°å’Œåè®®å¤´å¼€é”€ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹èƒ½å¤Ÿæ˜¾è‘—æå‡ç½‘ç»œä¼ è¾“æ•ˆç‡ã€‚

**è®¡ç®—æ•ˆç‡ä¼˜åŒ–**ï¼š
SGLangé€šè¿‡æ™ºèƒ½ç¼“å­˜å’Œæ‰¹é‡å¤„ç†æœºåˆ¶ï¼Œåœ¨è®¡ç®—å±‚é¢å®ç°äº†æ˜¾è‘—çš„æ€§èƒ½æå‡ã€‚è¯­æ³•å¯¹è±¡ç¼“å­˜é¿å…äº†é‡å¤çš„ç¼–è¯‘å¼€é”€ï¼Œè€Œæ‰¹é‡è¯·æ±‚å¤„ç†åˆ™å‡å°‘äº†å‡½æ•°è°ƒç”¨å’Œå¾ªç¯å¼€é”€ã€‚

**è¯­æ³•å¯¹è±¡ç¼“å­˜**ï¼šç›¸åŒçš„è¯­æ³•è§„èŒƒï¼ˆJSON Schemaã€æ­£åˆ™è¡¨è¾¾å¼ç­‰ï¼‰åªéœ€è¦ç¼–è¯‘ä¸€æ¬¡ï¼Œåç»­è¯·æ±‚ç›´æ¥ä½¿ç”¨ç¼“å­˜çš„è¯­æ³•å¯¹è±¡ï¼Œé¿å…äº†é‡å¤çš„ç¼–è¯‘è®¡ç®—ã€‚

**æ‰¹é‡å¤„ç†ä¼˜åŒ–**ï¼šæ‰¹é‡è¯·æ±‚é€šè¿‡ä¸€æ¬¡æ€§å¤„ç†å¤šä¸ªè¯·æ±‚ï¼Œå‡å°‘äº†å‡½æ•°è°ƒç”¨å¼€é”€å’Œä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹èƒ½å¤Ÿæ˜¾è‘—æå‡å¤„ç†æ•ˆç‡ã€‚

```python
# è¯­æ³•å¯¹è±¡ç¼“å­˜çš„æ™ºèƒ½å®ç°
if req.sampling_params.json_schema is not None:
    key = ("json", req.sampling_params.json_schema)  # JSON Schemaç¼“å­˜é”®
elif req.sampling_params.regex is not None:
    key = ("regex", req.sampling_params.regex)       # æ­£åˆ™è¡¨è¾¾å¼ç¼“å­˜é”®
elif req.sampling_params.ebnf is not None:
    key = ("ebnf", req.sampling_params.ebnf)         # EBNFè¯­æ³•ç¼“å­˜é”®
elif req.sampling_params.structural_tag:
    key = ("structural_tag", req.sampling_params.structural_tag)  # ç»“æ„åŒ–æ ‡ç­¾ç¼“å­˜é”®

# å°è¯•ä»ç¼“å­˜è·å–è¯­æ³•å¯¹è±¡
value, cache_hit = self.grammar_backend.get_cached_or_future_value(key)
req.grammar = value  # è®¾ç½®è¯·æ±‚çš„è¯­æ³•å¯¹è±¡

if not cache_hit:
    # ç¼“å­˜æœªå‘½ä¸­ï¼Œéœ€è¦å¼‚æ­¥æ„å»ºè¯­æ³•å¯¹è±¡
    req.grammar_key = key
    add_to_grammar_queue = True  # æ·»åŠ åˆ°è¯­æ³•é˜Ÿåˆ—ç­‰å¾…æ„å»º
else:
    # ç¼“å­˜å‘½ä¸­ï¼Œæ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆè¯­æ³•å¯¹è±¡
    if value is INVALID_GRAMMAR_OBJ:
        error_msg = f"Invalid grammar request with cache hit: {key=}"
        req.set_finish_with_abort(error_msg)  # æ— æ•ˆè¯­æ³•ï¼Œä¸­æ­¢è¯·æ±‚

# æ‰¹é‡è¯·æ±‚å¤„ç†ä¼˜åŒ–
def handle_batch_generate_request(self, recv_req: BatchTokenizedGenerateReqInput):
    """Handle optimized batch generate request."""
    logger.debug(f"Processing batch generate request with {len(recv_req)} requests")

    # éå†æ‰¹é‡å®¹å™¨ä¸­çš„æ¯ä¸ªè¯·æ±‚ï¼Œå¤ç”¨å•è¯·æ±‚å¤„ç†é€»è¾‘
    for tokenized_req in recv_req:
        self.handle_generate_request(tokenized_req)  # è°ƒç”¨å•è¯·æ±‚å¤„ç†æ–¹æ³•
```

---

## 9. å¼€å‘è€…æ‰©å±•æŒ‡å—

SGLangçš„è¯·æ±‚å¤„ç†ç³»ç»Ÿé‡‡ç”¨äº†é«˜åº¦æ¨¡å—åŒ–çš„è®¾è®¡ï¼Œä¸ºå¼€å‘è€…æä¾›äº†å®Œæ•´çš„æ‰©å±•æ¡†æ¶ã€‚é€šè¿‡è§„èŒƒåŒ–çš„æ‰©å±•æµç¨‹ï¼Œå¼€å‘è€…å¯ä»¥ä¾¿æ·åœ°æ·»åŠ æ–°çš„è¯·æ±‚ç±»å‹ï¼Œè€Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒè°ƒåº¦é€»è¾‘ã€‚è¿™ç§è®¾è®¡å±•ç°äº†SGLangåœ¨æ¶æ„è®¾è®¡ä¸Šçš„å¯æ‰©å±•æ€§ã€‚

**æ‰©å±•ç³»ç»Ÿçš„è®¾è®¡ä¼˜åŠ¿**ï¼š
- **é›¶ä¾µå…¥æ‰©å±•**ï¼šæ–°å¢åŠŸèƒ½ä¸éœ€è¦ä¿®æ”¹ç°æœ‰ä»£ç ï¼Œåªéœ€è¦æ·»åŠ æ–°çš„å¤„ç†é€»è¾‘
- **ç±»å‹å®‰å…¨ä¿è¯**ï¼šåŸºäºPythonç±»å‹ç³»ç»Ÿçš„å¼ºç±»å‹æ£€æŸ¥ï¼Œåœ¨ç¼–è¯‘æ—¶å‘ç°é”™è¯¯
- **è§„èŒƒåŒ–æµç¨‹**ï¼šç»Ÿä¸€çš„æ‰©å±•æ¨¡å¼ï¼Œé™ä½äº†å¼€å‘è€…çš„å­¦ä¹ æˆæœ¬
- **å‘åå…¼å®¹**ï¼šæ–°å¢çš„è¯·æ±‚ç±»å‹ä¸ä¼šå½±å“ç°æœ‰åŠŸèƒ½çš„æ­£å¸¸è¿è¡Œ

### 9.1 æ‰©å±•æ–°è¯·æ±‚ç±»å‹

è¯·æ±‚ç±»å‹æ‰©å±•æ˜¯SGLangç³»ç»ŸåŠŸèƒ½å¢å¼ºçš„ä¸»è¦æ–¹å¼ï¼Œå®ƒé€šè¿‡ä¸‰ä¸ªå…³é”®æ­¥éª¤å®ç°ï¼šæ•°æ®ç»“æ„å®šä¹‰ã€å¤„ç†é€»è¾‘å®ç°ã€åˆ†å‘å™¨æ³¨å†Œã€‚æ•´ä¸ªè¿‡ç¨‹éµå¾ªäº†è½¯ä»¶å·¥ç¨‹çš„è‰¯å¥½å®è·µï¼Œç¡®ä¿äº†ä»£ç çš„è´¨é‡å’Œç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚

**æ‰©å±•æµç¨‹çš„æ ¸å¿ƒæ­¥éª¤**ï¼š
1. **è¯·æ±‚ç±»å®šä¹‰**ï¼šåœ¨io_struct.pyä¸­å®šä¹‰è¾“å…¥å’Œè¾“å‡ºçš„æ•°æ®ç»“æ„ï¼Œç¡®ä¿ç±»å‹å®‰å…¨
2. **å¤„ç†æ–¹æ³•å®ç°**ï¼šåœ¨Schedulerç±»ä¸­å®ç°å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ï¼ŒåŒ…æ‹¬é”™è¯¯å¤„ç†å’ŒçŠ¶æ€ç®¡ç†
3. **åˆ†å‘å™¨æ³¨å†Œ**ï¼šåœ¨TypeBasedDispatcherçš„æ˜ å°„è¡¨ä¸­æ³¨å†Œç±»å‹åˆ°å¤„ç†æ–¹æ³•çš„æ˜ å°„å…³ç³»

**è®¾è®¡åŸåˆ™ä¸å®è·µè¦ç‚¹**ï¼š
- **æ•°æ®ç»“æ„è®¾è®¡**ï¼šä½¿ç”¨@dataclassè£…é¥°å™¨ï¼Œæä¾›æ¸…æ™°çš„å­—æ®µå®šä¹‰å’Œç±»å‹æ³¨è§£
- **é”™è¯¯å¤„ç†ç­–ç•¥**ï¼šå®ç°å®Œæ•´çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼ŒåŒ…æ‹¬è¾“å…¥éªŒè¯ã€ä¸šåŠ¡é€»è¾‘å¼‚å¸¸ã€ç³»ç»Ÿå¼‚å¸¸ç­‰
- **çŠ¶æ€ç®¡ç†è§„èŒƒ**ï¼šæ­£ç¡®å¤„ç†è¯·æ±‚çŠ¶æ€çš„åˆ›å»ºã€æ›´æ–°å’Œé”€æ¯
- **æ¥å£ä¸€è‡´æ€§**ï¼šä¿æŒä¸ç°æœ‰è¯·æ±‚ç±»å‹çš„æ¥å£ä¸€è‡´æ€§ï¼Œä¾¿äºå®¢æˆ·ç«¯é›†æˆ

ä»¥ä¸‹æ˜¯æ·»åŠ è‡ªå®šä¹‰æ¨¡å‹æ£€æŸ¥è¯·æ±‚çš„å®Œæ•´ç¤ºä¾‹ï¼š

```python
# 1. å®šä¹‰è¯·æ±‚ç±»ï¼ˆåœ¨io_struct.pyä¸­ï¼‰
@dataclass
class CustomModelCheckReqInput:
    """è‡ªå®šä¹‰æ¨¡å‹æ£€æŸ¥è¯·æ±‚"""
    rid: str
    model_name: str
    check_type: str

@dataclass  
class CustomModelCheckReqOutput:
    """è‡ªå®šä¹‰æ¨¡å‹æ£€æŸ¥è¾“å‡º"""
    rid: str
    status: str
    details: dict

# 2. å®ç°å¤„ç†æ–¹æ³•ï¼ˆåœ¨Schedulerä¸­ï¼‰
def handle_custom_model_check(self, recv_req: CustomModelCheckReqInput):
    """å¤„ç†è‡ªå®šä¹‰æ¨¡å‹æ£€æŸ¥è¯·æ±‚"""
    try:
        if recv_req.check_type == "weights":
            status = self._check_model_weights(recv_req.model_name)
        elif recv_req.check_type == "config":
            status = self._check_model_config(recv_req.model_name)
        else:
            status = self._check_model_status(recv_req.model_name)
            
        return CustomModelCheckReqOutput(
            rid=recv_req.rid,
            status="success",
            details=status
        )
    except Exception as e:
        return CustomModelCheckReqOutput(
            rid=recv_req.rid,
            status="error", 
            details={"error": str(e)}
        )

# 3. æ³¨å†Œåˆ†å‘å™¨ï¼ˆåœ¨__init__ä¸­æ·»åŠ ï¼‰
self._request_dispatcher = TypeBasedDispatcher([
    # ... ç°æœ‰æ˜ å°„ ...
    (CustomModelCheckReqInput, self.handle_custom_model_check),
])
```

### 9.2 è°ƒè¯•ä¸ç›‘æ§

SGLangçš„è°ƒè¯•ä¸ç›‘æ§ç³»ç»Ÿä¸ºå¼€å‘è€…å’Œè¿ç»´äººå‘˜æä¾›äº†å…¨é¢çš„ç³»ç»Ÿå¯è§‚æµ‹æ€§æ”¯æŒã€‚è¿™ä¸ªç³»ç»Ÿä¸ä»…åŒ…å«äº†ä¼ ç»Ÿçš„æ—¥å¿—å’Œæ€§èƒ½åˆ†æå·¥å…·ï¼Œè¿˜é›†æˆäº†ä¸“é—¨é’ˆå¯¹å¤§è¯­è¨€æ¨¡å‹æ¨ç†ç³»ç»Ÿçš„ç›‘æ§æŒ‡æ ‡å’Œè°ƒè¯•æ¥å£ã€‚

**ç›‘æ§ç³»ç»Ÿçš„æ ¸å¿ƒæ¶æ„**ï¼š
- **åˆ†å±‚ç›‘æ§è®¾è®¡**ï¼šä»è¯·æ±‚çº§åˆ°ç³»ç»Ÿçº§çš„å¤šå±‚æ¬¡ç›‘æ§ï¼Œæä¾›ä¸åŒç²’åº¦çš„å¯è§‚æµ‹æ€§
- **å®æ—¶çŠ¶æ€æŸ¥è¯¢**ï¼šé€šè¿‡å†…ç½®çš„çŠ¶æ€æŸ¥è¯¢æ¥å£ï¼Œå®æ—¶è·å–ç³»ç»Ÿå„ç»„ä»¶çš„è¿è¡ŒçŠ¶æ€
- **æ€§èƒ½åˆ†æé›†æˆ**ï¼šæ·±åº¦é›†æˆPyTorch Profilerï¼Œæ”¯æŒCPUã€GPUã€å†…å­˜ç­‰å¤šç»´åº¦æ€§èƒ½åˆ†æ
- **æŒ‡æ ‡æ”¶é›†ä½“ç³»**ï¼šå®Œæ•´çš„æŒ‡æ ‡æ”¶é›†å’Œç»Ÿè®¡ä½“ç³»ï¼Œæ”¯æŒç³»ç»Ÿæ€§èƒ½çš„é‡åŒ–åˆ†æ

**è°ƒè¯•å·¥å…·çš„ä¸“ä¸šç‰¹æ€§**ï¼š
- **è¯·æ±‚ç”Ÿå‘½å‘¨æœŸè¿½è¸ª**ï¼šé€šè¿‡ridå®ç°è¯·æ±‚çš„å…¨é“¾è·¯è¿½è¸ªï¼Œè¦†ç›–ä»æ¥æ”¶åˆ°å®Œæˆçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ
- **é˜Ÿåˆ—çŠ¶æ€å¯è§†åŒ–**ï¼šå®æ—¶ç›‘æ§waiting_queueã€grammar_queueç­‰å…³é”®é˜Ÿåˆ—çš„çŠ¶æ€
- **æ‰¹æ¬¡æ‰§è¡Œç›‘æ§**ï¼šç›‘æ§æ‰¹æ¬¡çš„åˆ›å»ºã€æ‰§è¡Œã€å®Œæˆç­‰å…³é”®é˜¶æ®µ
- **èµ„æºä½¿ç”¨åˆ†æ**ï¼šç›‘æ§å†…å­˜æ± ã€KVç¼“å­˜ç­‰å…³é”®èµ„æºçš„ä½¿ç”¨æƒ…å†µ

**æ€§èƒ½åˆ†æé›†æˆ**ï¼š
SGLangé€šè¿‡SchedulerProfilerMixinå®ç°äº†ä¸PyTorch Profilerçš„ç´§å¯†é›†æˆï¼Œæ”¯æŒæŒ‰é˜¶æ®µåˆ†æã€è‡ªå®šä¹‰é‡‡æ ·ç­–ç•¥ã€å¤šæ´»åŠ¨ç±»å‹ç›‘æ§ç­‰åŠŸèƒ½ã€‚è¿™ç§é›†æˆä¸ºç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–æä¾›äº†æ•°æ®æ”¯æŒã€‚

```python
def profile(self, recv_req: ProfileReq):
    if recv_req.type == ProfileReqType.START_PROFILE:
        if recv_req.profile_by_stage or recv_req.start_step:
            return self.init_profile(
                recv_req.output_dir,
                recv_req.start_step,
                recv_req.num_steps,
                recv_req.activities,
                recv_req.with_stack,
                recv_req.record_shapes,
                recv_req.profile_by_stage,
                recv_req.profile_id,
            )
        else:
            self.init_profile(
                recv_req.output_dir,
                recv_req.start_step,
                recv_req.num_steps,
                recv_req.activities,
                recv_req.with_stack,
                recv_req.record_shapes,
                recv_req.profile_by_stage,
                recv_req.profile_id,
            )
            return self.start_profile(True)
    else:
        return self.stop_profile()
```

**è°ƒè¯•æ”¯æŒ**ï¼š
SGLangçš„è°ƒè¯•åŠŸèƒ½ä¸»è¦é€šè¿‡æ—¥å¿—ç³»ç»Ÿå’Œå†…ç½®çš„çŠ¶æ€æŸ¥è¯¢æ¥å£å®ç°ï¼Œä¸ºå¼€å‘è€…æä¾›äº†ä¸°å¯Œçš„ç³»ç»Ÿå†…éƒ¨çŠ¶æ€ä¿¡æ¯ã€‚é€šè¿‡è¯·æ±‚IDå¯ä»¥è¿½è¸ªè¯·æ±‚åœ¨å„ä¸ªé˜Ÿåˆ—å’Œæ‰¹æ¬¡ä¸­çš„çŠ¶æ€å˜åŒ–ã€‚

---

## 10. æ¶æ„æ€»ç»“ä¸æŠ€æœ¯ä»·å€¼

SGLangçš„è¯·æ±‚å¤„ç†æœºåˆ¶å±•ç°äº†ç°ä»£å¤§è¯­è¨€æ¨¡å‹æ¨ç†ç³»ç»Ÿåœ¨æ¶æ„è®¾è®¡å’Œå·¥ç¨‹å®ç°æ–¹é¢çš„æŠ€æœ¯æ°´å‡†ã€‚è¿™ä¸ªæœºåˆ¶åœ¨æ€§èƒ½ã€æ‰©å±•æ€§ã€ç¨³å®šæ€§æ–¹é¢éƒ½æœ‰è‰¯å¥½çš„è¡¨ç°ï¼Œä¸ºç³»ç»Ÿçš„æŒç»­æ¼”è¿›æä¾›äº†åšå®çš„æ¶æ„åŸºç¡€ã€‚

### 10.1 æŠ€æœ¯ç‰¹æ€§ä¸ä¼˜åŠ¿

**ç±»å‹é©±åŠ¨çš„åˆ†å‘æ¶æ„**ï¼š
SGLangé‡‡ç”¨äº†åŸºäºPythonç±»å‹ç³»ç»Ÿçš„è¯·æ±‚åˆ†å‘æœºåˆ¶ï¼Œå°†ä¼ ç»Ÿçš„æ¡ä»¶åˆ¤æ–­è·¯ç”±è½¬æ¢ä¸ºO(1)å¤æ‚åº¦çš„ç±»å‹åŒ¹é…æ“ä½œã€‚è¿™ç§è®¾è®¡ä¸ä»…æå‡äº†æ€§èƒ½ï¼Œæ›´é‡è¦çš„æ˜¯æä¾›äº†ç¼–è¯‘æ—¶ç±»å‹å®‰å…¨ä¿è¯ï¼Œæ˜¾è‘—é™ä½äº†ç³»ç»Ÿçš„è¿è¡Œæ—¶é”™è¯¯ç‡ã€‚

**å¤šæ¨¡æ€ç»Ÿä¸€å¤„ç†æ¡†æ¶**ï¼š
é€šè¿‡pad_input_ids_funcç­‰æ ¸å¿ƒæœºåˆ¶ï¼ŒSGLangå®ç°äº†æ–‡æœ¬ã€å›¾åƒã€è§†é¢‘ã€éŸ³é¢‘ç­‰å¤šæ¨¡æ€æ•°æ®çš„ç»Ÿä¸€å¤„ç†ã€‚è¿™ç§è®¾è®¡ä¸ºå¤šæ¨¡æ€å¤§è¯­è¨€æ¨¡å‹çš„æ¨ç†æä¾›äº†å®Œæ•´çš„åŸºç¡€è®¾æ–½æ”¯æŒã€‚

```python
# å¤šæ¨¡æ€ç»Ÿä¸€å¤„ç†çš„æ ¸å¿ƒå®ç°
if recv_req.mm_inputs is not None:  # æ£€æŸ¥æ˜¯å¦åŒ…å«å¤šæ¨¡æ€è¾“å…¥
    # ä»å­—å…¸åˆ›å»ºå¤šæ¨¡æ€è¾“å…¥å¯¹è±¡
    mm_inputs = MultimodalInputs.from_dict(recv_req.mm_inputs)
    # pad_input_ids_funcæ˜¯å¤šæ¨¡æ€tokenåŒ–çš„æ ¸å¿ƒå‡½æ•°
    # å°†å¤šæ¨¡æ€æ•°æ®è½¬æ¢ä¸ºtokenåºåˆ—å¹¶æ’å…¥åˆ°åˆé€‚ä½ç½®
    req.origin_input_ids = self.pad_input_ids_func(
        req.origin_input_ids, mm_inputs
    )
    # æ‰©å±•å¤šæ¨¡æ€è¾“å…¥åˆ°è¯·æ±‚å¯¹è±¡ä¸­
    req.extend_image_inputs(mm_inputs)

# æ”¯æŒå¤šç§æ¨¡æ€çš„ç»Ÿä¸€æ¥å£è®¾è®¡
@dataclasses.dataclass
class MultimodalInputs:
    mm_items: List[MultimodalDataItem]     # å¤šæ¨¡æ€æ•°æ®é¡¹åˆ—è¡¨
    im_token_id: Optional[int] = None      # å›¾åƒtokenæ ‡è¯†ç¬¦
    video_token_id: Optional[int] = None   # è§†é¢‘tokenæ ‡è¯†ç¬¦  
    audio_token_id: Optional[int] = None   # éŸ³é¢‘tokenæ ‡è¯†ç¬¦
    # ç»Ÿä¸€æ¥å£æ”¯æŒå›¾åƒã€è§†é¢‘ã€éŸ³é¢‘ç­‰å¤šç§æ¨¡æ€
```

**åˆ†å¸ƒå¼åè°ƒæœºåˆ¶**ï¼š
åœ¨TPã€PPã€DPæ··åˆå¹¶è¡Œçš„å¤æ‚ç¯å¢ƒä¸­ï¼ŒSGLangå®ç°äº†é«˜æ•ˆçš„è¯·æ±‚åè°ƒå’Œæ•°æ®åŒæ­¥ã€‚é€šè¿‡åˆç†çš„rankåˆ†å·¥å’Œä¼˜åŒ–çš„é€šä¿¡ç®—æ³•ï¼Œç³»ç»Ÿèƒ½å¤Ÿåœ¨å¤§è§„æ¨¡åˆ†å¸ƒå¼ç¯å¢ƒä¸­ä¿æŒé«˜æ€§èƒ½å’Œæ•°æ®ä¸€è‡´æ€§ã€‚

**æ™ºèƒ½æµé‡æ§åˆ¶ç³»ç»Ÿ**ï¼š
SchedulerInputBlockerå®ç°äº†åŸºäºçŠ¶æ€æœºçš„ç²¾ç»†åŒ–æµé‡æ§åˆ¶ï¼Œä¸ä»…æ”¯æŒæœ¬åœ°çš„èƒŒå‹ç®¡ç†ï¼Œè¿˜é€šè¿‡åˆ†å¸ƒå¼barrieræœºåˆ¶å®ç°äº†å…¨å±€ä¸€è‡´çš„æµé‡æ§åˆ¶ï¼Œè¿™åœ¨ç”Ÿäº§ç¯å¢ƒçš„ç³»ç»Ÿç»´æŠ¤å’Œæ•…éšœæ¢å¤ä¸­å…·æœ‰é‡è¦ä»·å€¼ã€‚

```python
# æ™ºèƒ½æµé‡æ§åˆ¶çš„çŠ¶æ€æœºå®ç°
class SchedulerInputBlocker:
    def __init__(self, noop: bool):
        self._state = _State.UNBLOCKED         # åˆå§‹çŠ¶æ€ä¸ºæœªé˜»å¡
        self._pending_reqs = []                # é˜»å¡æœŸé—´çš„pendingè¯·æ±‚é˜Ÿåˆ—
        self._global_unblock_barrier = PollBasedBarrier(noop=noop)  # åˆ†å¸ƒå¼åŒæ­¥å±éšœ

    def handle(self, recv_reqs: Optional[List[Any]]):
        if not self._noop:  # éæ— æ“ä½œæ¨¡å¼
            output_reqs = []
            for recv_req in recv_reqs:
                # å¤„ç†æ¯ä¸ªæ¥æ”¶åˆ°çš„è¯·æ±‚
                output_reqs += self._handle_recv_req(recv_req)

        # æ£€æŸ¥å…¨å±€è§£é™¤é˜»å¡å±éšœçŠ¶æ€
        global_arrived_unblock_barrier = (
            self._global_unblock_barrier.poll_global_arrived()
        )
        if (
            self._state == _State.GLOBAL_UNBLOCK_BARRIER  # å¤„äºå±éšœç­‰å¾…çŠ¶æ€
            and global_arrived_unblock_barrier            # æ‰€æœ‰èŠ‚ç‚¹éƒ½åˆ°è¾¾å±éšœ
        ):
            # é‡Šæ”¾æ‰€æœ‰pendingè¯·æ±‚
            output_reqs += self._handle_arrive_unblock_barrier()

        return output_reqs  # è¿”å›å¯ä»¥å¤„ç†çš„è¯·æ±‚åˆ—è¡¨

    def _handle_recv_req(self, recv_req):
        if isinstance(recv_req, BlockReqInput):  # æµé‡æ§åˆ¶å‘½ä»¤
            if recv_req.type == BlockReqType.BLOCK:
                self._execute_block_req()  # æ‰§è¡Œé˜»å¡æ“ä½œ
                return []
            elif recv_req.type == BlockReqType.UNBLOCK:
                self._execute_unblock_req()  # æ‰§è¡Œè§£é™¤é˜»å¡æ“ä½œ
                return []
        else:
            # æ™®é€šè¯·æ±‚çš„å¤„ç†
            if self._state == _State.UNBLOCKED:
                return [recv_req]  # æœªé˜»å¡çŠ¶æ€ï¼Œç›´æ¥æ”¾è¡Œ
            else:
                self._pending_reqs.append(recv_req)  # é˜»å¡çŠ¶æ€ï¼Œç¼“å­˜è¯·æ±‚
                return []
```

### 10.2 å·¥ç¨‹å®è·µä»·å€¼

**ç”Ÿäº§çº§ç³»ç»Ÿè®¾è®¡**ï¼š
SGLangçš„è¯·æ±‚å¤„ç†æœºåˆ¶é‡‡ç”¨äº†ç”Ÿäº§çº§ç³»ç»Ÿçš„è®¾è®¡æ–¹æ³•ï¼ŒåŒ…æ‹¬å®Œæ•´çš„é”™è¯¯å¤„ç†ã€èµ„æºç®¡ç†ã€æ•…éšœæ¢å¤ç­‰æœºåˆ¶ã€‚æ¯ä¸ªç»„ä»¶éƒ½è€ƒè™‘äº†å¼‚å¸¸æƒ…å†µçš„å¤„ç†ï¼Œç¡®ä¿äº†ç³»ç»Ÿåœ¨å¤æ‚ç”Ÿäº§ç¯å¢ƒä¸­çš„ç¨³å®šè¿è¡Œã€‚

```python
# å®Œæ•´çš„é”™è¯¯å¤„ç†æœºåˆ¶ç¤ºä¾‹
def handle_generate_request(self, recv_req: TokenizedGenerateReqInput):
    # è¾“å…¥é•¿åº¦éªŒè¯ï¼Œé˜²æ­¢è¶…å‡ºæ¨¡å‹ä¸Šä¸‹æ–‡é™åˆ¶
    error_msg = validate_input_length(
        req, self.max_req_input_len, self.server_args.allow_auto_truncate,
    )
    if error_msg:
        req.set_finish_with_abort(error_msg)  # è®¾ç½®ä¸­æ­¢çŠ¶æ€å¹¶è®°å½•é”™è¯¯ä¿¡æ¯
        return

    # è¯­æ³•çº¦æŸçš„é”™è¯¯å¤„ç†
    if value is INVALID_GRAMMAR_OBJ:  # æ£€æŸ¥ç¼“å­˜çš„è¯­æ³•å¯¹è±¡æ˜¯å¦æœ‰æ•ˆ
        error_msg = f"Invalid grammar request with cache hit: {key=}"
        req.set_finish_with_abort(error_msg)  # æ— æ•ˆè¯­æ³•ï¼Œä¸­æ­¢è¯·æ±‚

# é˜Ÿåˆ—ä¿æŠ¤çš„èµ„æºç®¡ç†æœºåˆ¶
if len(self.waiting_queue) + 1 > self.max_queued_requests:  # æ£€æŸ¥é˜Ÿåˆ—å®¹é‡
    # åˆ›å»ºä¸­æ­¢è¯·æ±‚ï¼Œå®ç°èƒŒå‹ä¿æŠ¤
    abort_req = AbortReq(
        recv_req.rid,  # è¯·æ±‚æ ‡è¯†ç¬¦
        finished_reason={
            "type": "abort",                           # ä¸­æ­¢ç±»å‹
            "status_code": HTTPStatus.SERVICE_UNAVAILABLE,  # HTTP 503çŠ¶æ€ç 
            "message": "The request queue is full.",   # é”™è¯¯ä¿¡æ¯
        },
    )
    self.send_to_tokenizer.send_pyobj(abort_req)  # å‘é€ä¸­æ­¢å“åº”ç»™tokenizer
```

**æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**ï¼š
ä»ç½‘ç»œé€šä¿¡çš„é›¶æ‹·è´ä¼ è¾“ï¼Œåˆ°è®¡ç®—å±‚é¢çš„æ‰¹é‡å¤„ç†å’Œæ™ºèƒ½ç¼“å­˜ï¼ŒSGLangåœ¨è¯·æ±‚å¤„ç†çš„å„ä¸ªç¯èŠ‚éƒ½è¿›è¡Œäº†ç›¸åº”çš„ä¼˜åŒ–ã€‚è¿™äº›ä¼˜åŒ–ç­–ç•¥ä¸ºå¤§è§„æ¨¡æ¨ç†æœåŠ¡æä¾›äº†æ€§èƒ½æ”¯æŒã€‚

**æ‰©å±•æ€§æ¶æ„è®¾è®¡**ï¼š
é€šè¿‡TypeBasedDispatcherçš„è§„èŒƒåŒ–æ‰©å±•æ¡†æ¶ï¼ŒSGLangä¸ºç³»ç»ŸåŠŸèƒ½çš„æŒç»­æ¼”è¿›æä¾›äº†ç¨³å®šçš„æ¶æ„åŸºç¡€ã€‚æ–°åŠŸèƒ½çš„æ·»åŠ æ— éœ€ä¿®æ”¹æ ¸å¿ƒé€»è¾‘ï¼Œé™ä½äº†ç³»ç»Ÿç»´æŠ¤çš„å¤æ‚åº¦ã€‚

**è¿ç»´å‹å¥½çš„ç›‘æ§ä½“ç³»**ï¼š
é›†æˆçš„æ€§èƒ½åˆ†æã€çŠ¶æ€ç›‘æ§ã€è°ƒè¯•è¿½è¸ªç­‰åŠŸèƒ½ï¼Œä¸ºç³»ç»Ÿè¿ç»´æä¾›äº†å…¨é¢çš„å·¥å…·æ”¯æŒã€‚è¿™äº›å·¥å…·ä¸ä»…æœ‰åŠ©äºæ•…éšœè¯Šæ–­ï¼Œæ›´ä¸ºç³»ç»Ÿä¼˜åŒ–å’Œå®¹é‡è§„åˆ’æä¾›äº†æ•°æ®åŸºç¡€ã€‚

```python
# æ€§èƒ½åˆ†æçš„ä¸“ä¸šå®ç°
def profile(self, recv_req: ProfileReq):
    if recv_req.type == ProfileReqType.START_PROFILE:  # å¯åŠ¨æ€§èƒ½åˆ†æ
        # åˆå§‹åŒ–profileré…ç½®ï¼Œæ”¯æŒå¤šç§åˆ†ææ¨¡å¼
        return self.init_profile(
            recv_req.output_dir,        # è¾“å‡ºç›®å½•
            recv_req.start_step,        # å¼€å§‹æ­¥éª¤
            recv_req.num_steps,         # åˆ†ææ­¥æ•°
            recv_req.activities,        # æ´»åŠ¨ç±»å‹ï¼ˆCPU/GPUï¼‰
            recv_req.with_stack,        # æ˜¯å¦åŒ…å«è°ƒç”¨æ ˆ
            recv_req.record_shapes,     # æ˜¯å¦è®°å½•å¼ é‡å½¢çŠ¶
            recv_req.profile_by_stage,  # æ˜¯å¦æŒ‰é˜¶æ®µåˆ†æ
            recv_req.profile_id,        # åˆ†æä¼šè¯ID
        )
    else:
        return self.stop_profile()  # åœæ­¢æ€§èƒ½åˆ†æå¹¶å¯¼å‡ºç»“æœ

# ä¼šè¯ç®¡ç†çš„å®Œæ•´é”™è¯¯å¤„ç†
def open_session(self, recv_req: OpenSessionReqInput):
    session_id = recv_req.session_id  # è·å–ä¼šè¯ID
    if session_id in self.sessions:   # æ£€æŸ¥ä¼šè¯æ˜¯å¦å·²å­˜åœ¨
        logger.warning(f"session id {session_id} already exist, cannot open.")
        return OpenSessionReqOutput(session_id, False)  # è¿”å›å¤±è´¥çŠ¶æ€
    elif session_id is None:  # æ£€æŸ¥ä¼šè¯IDæ˜¯å¦ä¸ºç©º
        logger.warning("session id is None, cannot open.")
        return OpenSessionReqOutput(session_id, False)  # è¿”å›å¤±è´¥çŠ¶æ€
```

### 10.3 æŠ€æœ¯æ¼”è¿›æ„ä¹‰

SGLangçš„è¯·æ±‚å¤„ç†æœºåˆ¶åœ¨å¤§è¯­è¨€æ¨¡å‹æ¨ç†ç³»ç»Ÿçš„æŠ€æœ¯å‘å±•ä¸­å…·æœ‰å‚è€ƒä»·å€¼ï¼š

**æ¶æ„æ¨¡å¼çš„è§„èŒƒåŒ–**ï¼šåˆ†å±‚æ¶æ„ã€ç±»å‹åŒ–åˆ†å‘ã€å¼‚æ­¥å¤„ç†ç­‰è®¾è®¡æ¨¡å¼ï¼Œä¸ºæ¨ç†ç³»ç»Ÿçš„æ¶æ„è®¾è®¡æä¾›äº†æœ‰ä»·å€¼çš„å‚è€ƒã€‚

```python
# è§„èŒƒåŒ–çš„åˆ†å±‚æ¶æ„æ¨¡å¼
# 1. æ¥æ”¶å±‚ - ç½‘ç»œè¯·æ±‚æ¥æ”¶
def recv_requests(self) -> List[Req]:
    # éé˜»å¡ZMQæ¥æ”¶ + åˆ†å¸ƒå¼rankåè°ƒ + æµé‡æ§åˆ¶
    pass

# 2. åˆ†å‘å±‚ - ç±»å‹åŒ–è¯·æ±‚è·¯ç”±  
self._request_dispatcher = TypeBasedDispatcher([...])  # åŸºäºç±»å‹çš„O(1)è·¯ç”±

# 3. å¤„ç†å±‚ - ä¸šåŠ¡é€»è¾‘å¤„ç†
def handle_generate_request(self, recv_req):
    # åˆ›å»ºReqå¯¹è±¡ + å¤šæ¨¡æ€å¤„ç† + è¯­æ³•çº¦æŸ + ä¼šè¯ç®¡ç†
    pass

# 4. é˜Ÿåˆ—å±‚ - è¯·æ±‚é˜Ÿåˆ—ç®¡ç†
self._add_request_to_queue(req)  # æ ¹æ®è¯·æ±‚ç‰¹æ€§é€‰æ‹©åˆé€‚é˜Ÿåˆ—
```

**å¤šæ¨¡æ€å¤„ç†çš„æ¨¡å¼**ï¼šç»Ÿä¸€çš„å¤šæ¨¡æ€å¤„ç†æ¡†æ¶ä¸ºå¤šæ¨¡æ€å¤§è¯­è¨€æ¨¡å‹çš„å‘å±•æä¾›äº†æŠ€æœ¯æ”¯æŒã€‚

```python
# å¤šæ¨¡æ€å¤„ç†çš„ç»Ÿä¸€æ¨¡å¼
class MultimodalInputs:
    mm_items: List[MultimodalDataItem]    # ç»Ÿä¸€çš„å¤šæ¨¡æ€æ•°æ®é¡¹åˆ—è¡¨
    im_token_id: Optional[int] = None     # å›¾åƒç‰¹æ®Štokenæ ‡è¯†ç¬¦
    video_token_id: Optional[int] = None  # è§†é¢‘ç‰¹æ®Štokenæ ‡è¯†ç¬¦
    audio_token_id: Optional[int] = None  # éŸ³é¢‘ç‰¹æ®Štokenæ ‡è¯†ç¬¦
    # ä¸ºä¸åŒæ¨¡æ€æä¾›ç»Ÿä¸€çš„æ•°æ®æ¥å£å’ŒtokenåŒ–æ”¯æŒ

# ç»Ÿä¸€çš„å¤šæ¨¡æ€å¡«å……å¤„ç†æ¥å£
req.origin_input_ids = self.pad_input_ids_func(
    req.origin_input_ids,  # åŸå§‹æ–‡æœ¬tokenåºåˆ—
    mm_inputs              # å¤šæ¨¡æ€è¾“å…¥æ•°æ®
)  # å°†å¤šæ¨¡æ€æ•°æ®è½¬æ¢ä¸ºtokenåºåˆ—å¹¶æ’å…¥åˆ°åˆé€‚ä½ç½®
```

**åˆ†å¸ƒå¼ç³»ç»Ÿçš„å®è·µç»éªŒ**ï¼šåœ¨å¤æ‚å¹¶è¡Œç¯å¢ƒä¸­çš„é«˜æ•ˆåè°ƒæœºåˆ¶ï¼Œä¸ºå¤§è§„æ¨¡åˆ†å¸ƒå¼AIç³»ç»Ÿçš„è®¾è®¡æä¾›äº†æœ‰ä»·å€¼çš„å‚è€ƒã€‚

```python
# åˆ†å¸ƒå¼åè°ƒçš„å®ç°æ¨¡å¼
# æµæ°´çº¿å¹¶è¡Œçš„rankåˆ†å·¥ç­–ç•¥
if self.pp_rank == 0:  # ç¬¬ä¸€ä¸ªPP stage
    if self.attn_tp_rank == 0:  # æ³¨æ„åŠ›TPçš„ä¸»rank
        # ä¸»rankè´Ÿè´£å®é™…çš„ç½‘ç»œæ¥æ”¶
        recv_reqs = []
        # æ‰§è¡ŒZMQéé˜»å¡æ¥æ”¶é€»è¾‘
    else:
        recv_reqs = None  # éä¸»rankç­‰å¾…åŒæ­¥
else:
    # éç¬¬ä¸€ä¸ªPP stageé€šè¿‡ç‚¹å¯¹ç‚¹é€šä¿¡è·å–è¯·æ±‚
    recv_reqs = point_to_point_pyobj(...)  # PP ranké—´çš„é«˜æ•ˆé€šä¿¡

# æ•°æ®å¹¶è¡Œçš„å¹¿æ’­åŒæ­¥æœºåˆ¶
if self.server_args.enable_dp_attention:  # å¯ç”¨DPæ³¨æ„åŠ›ä¼˜åŒ–
    # é«˜æ•ˆçš„é›†ä½“é€šä¿¡ï¼Œä¸€æ¬¡å¹¿æ’­åˆ°æ‰€æœ‰DP ranks
    recv_reqs = broadcast_pyobj(
        recv_reqs,                        # è¦å¹¿æ’­çš„è¯·æ±‚æ•°æ®
        self.world_group.device_group,    # é€šä¿¡è®¾å¤‡ç»„
        self.attn_dp_rank * self.attn_tp_size  # å¹¿æ’­æºrankè®¡ç®—
    )  # ç¡®ä¿æ‰€æœ‰DP ranksè·å¾—ä¸€è‡´çš„è¯·æ±‚æ•°æ®
```

**æ‰¿ä¸Šå¯ä¸‹**ï¼šåœ¨å‰é¢ç« èŠ‚ä¸­æˆ‘ä»¬äº†è§£äº†è°ƒåº¦å™¨çš„æ•´ä½“æ¶æ„å’Œæ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œæœ¬ç« æ·±å…¥å‰–æäº†è¯·æ±‚ä»æ¥æ”¶åˆ°å¤„ç†çš„å®Œæ•´æµç¨‹ã€‚æœ‰äº†è¿™äº›åŸºç¡€ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°†æ¢è®¨è°ƒåº¦å™¨çš„æ‰¹æ¬¡è°ƒåº¦ç­–ç•¥å’Œå†…å­˜ç®¡ç†ç®—æ³•ï¼Œäº†è§£SGLangå¦‚ä½•å°†è¿™äº›è¯·æ±‚é«˜æ•ˆåœ°ç»„ç»‡æˆæ‰¹æ¬¡å¹¶è¿›è¡Œæ¨ç†æ‰§è¡Œã€‚